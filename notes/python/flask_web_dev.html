<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>flask_web_dev</title>
<!-- 2017-05-02 Tue 10:44 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="your name" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>

         <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono|Galdeano|Open+Sans:600italic,400,600|Roboto+Condensed:400,700" rel="stylesheet" type="text/css">
         <link rel="stylesheet" type="text/css" href="/static/css/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="http://harrifeng.github.io/sitemap.html"> UP </a>
 |
 <a accesskey="H" href="http://harrifeng.github.io/index.html"> HOME </a>
</div><div id="preamble" class="status">

         <div id="header">
            <div id="header-top">
                <div id="blog-title">Harrifeng's Path</div>
                <div id="blog-sub-title">纸上得来终觉浅,绝知此事要Coding</div>
            </div>
            <div id="nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/about.html">About Me</a></li>
                    <li>
                    </li>
                </ul>
            </div>
         </div>
</div>
<div id="content">
<h1 class="title">flask_web_dev</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Chapter 1: Installation</a></li>
<li><a href="#sec-2">Chapter 2: Basic Application Structure</a>
<ul>
<li><a href="#sec-2-1">Initialization</a></li>
<li><a href="#sec-2-2">Routes and View Functions</a></li>
<li><a href="#sec-2-3">Server Startup</a></li>
<li><a href="#sec-2-4">A Complete Application</a></li>
<li><a href="#sec-2-5">Application and Request Context</a></li>
<li><a href="#sec-2-6">Request Dispatching</a></li>
<li><a href="#sec-2-7">Request Hooks</a></li>
<li><a href="#sec-2-8">Response</a></li>
<li><a href="#sec-2-9">Flask Extensions</a></li>
</ul>
</li>
<li><a href="#sec-3">Chapter 3: Templates</a>
<ul>
<li><a href="#sec-3-1">The Jinja2 Template Engine</a></li>
<li><a href="#sec-3-2">Twitter Bootstrap Integration with Flask-Bootstrap</a></li>
<li><a href="#sec-3-3">Custom Error Pages</a></li>
<li><a href="#sec-3-4">Links</a></li>
<li><a href="#sec-3-5">Static Files</a></li>
<li><a href="#sec-3-6">Location of Dates and Times with Flask-Momen</a></li>
</ul>
</li>
<li><a href="#sec-4">Chapter 4: Web Forms</a>
<ul>
<li><a href="#sec-4-1">Cross-Site Request Forgery(CSRF) Protection</a></li>
<li><a href="#sec-4-2">Form Classes</a></li>
<li><a href="#sec-4-3">Redirects and User Session</a></li>
<li><a href="#sec-4-4">Message Flashing</a></li>
</ul>
</li>
<li><a href="#sec-5">Chapter 5: Databases</a>
<ul>
<li><a href="#sec-5-1">SQL Databases</a></li>
<li><a href="#sec-5-2">NoSQL Databases</a></li>
<li><a href="#sec-5-3">Database Management with Flask-SQLAlchemy</a></li>
<li><a href="#sec-5-4">Model Definition</a></li>
<li><a href="#sec-5-5">Relationships</a></li>
<li><a href="#sec-5-6">Database Operations</a></li>
<li><a href="#sec-5-7">Database Use in View Functions</a></li>
<li><a href="#sec-5-8">Database Migrations with Flask-Migrate</a></li>
</ul>
</li>
<li><a href="#sec-6">Chapter 6: Email</a>
<ul>
<li><a href="#sec-6-1">Email Support with Flask-Mail</a></li>
<li><a href="#sec-6-2">Sending Email from the Python Shell</a></li>
<li><a href="#sec-6-3">Integrating Emails with the Application</a></li>
<li><a href="#sec-6-4">Sending Asynchronous Email</a></li>
</ul>
</li>
<li><a href="#sec-7">Chapter 7: Large Application Structure</a>
<ul>
<li><a href="#sec-7-1">Configuration Options</a></li>
<li><a href="#sec-7-2">Application Package</a></li>
<li><a href="#sec-7-3">Implementing Application Functionality in a Blueprint</a></li>
<li><a href="#sec-7-4">Launch Script</a></li>
<li><a href="#sec-7-5">Requirements File</a></li>
<li><a href="#sec-7-6">Unit Tests</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Chapter 1: Installation</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>使用virtualenv创建一个虚拟环境,然后使用pip安装
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #2aa198;">(</span>venv<span style="color: #2aa198;">)</span> &amp; pip install flask
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Chapter 2: Basic Application Structure</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Initialization</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>所有的Flask appilcation都需要创建一个application instance.Web server会把所有
的request请求都转给这个instance object来处理(使用的技术叫做WSGI)
</li>
<li>所谓的WSGI,全称是Web Server Gateway Interface.其诞生的原因是两个字"解耦",一
个网站开发的时候,一般有两个部分:
<ul class="org-ul">
<li>web server端
</li>
<li>应用程序端
</li>
</ul>
</li>
<li>我们在开发应用程序端的时候,为了方便,框架通常都会带一个web server,比如flask就
有,这个server的特点就是有良好的debug信息,但是也有问题,就是性能不行.我们真正
部署的时候,需要使用nginx等高效的web server.
</li>
<li>为了保证框架自带的web server和其他高级语言写的效率高的web server能够做到"无
缝替代",我们必须有一个规范来严格要求我们的server,这个时候WSGI就诞生了.
</li>
<li>WSGI在python界的地位和rack在ruby界的地位是一样的.
</li>
<li>我们创建的用来处理所有request请求的flask app创建过程如下:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Routes and View Functions</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>client端会发送request给web server,而web server则会把request转发给Flask
application instance.
</li>
<li>而Flask application instance则会为每一类特殊的URL设计一个function来去处理,
这种URL和处理URL的function之间关系叫做route
</li>
<li>flask使用了python内置的一个特性叫做decorator来把URL和function之间联系起来,
一个典型的decorator的书写过程如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">printdebug</span><span style="color: #2aa198;">(</span>func<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">decorator</span><span style="color: #2aa198;">(</span>user<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'----------enter the login---------&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   func<span style="color: #2aa198;">(</span>user<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'----------exit the login----------&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> decorator


<span style="color: #b58900;">@printdebug</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">(</span>user<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'In the login '</span> + user<span style="color: #2aa198;">)</span>

<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   login<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'hfeng'</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">##################################################</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; #</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">----------enter the login---------&gt;            #</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">In the login hfeng                             #</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">----------exit the login----------&gt;            #</span>
<span style="color: #93a1a1;">##################################################</span>
</pre>
</div>
</li>
<li>我们来看看flask里面是如何实现这个decorator的
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">route</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, rule, **options<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">decorator</span><span style="color: #2aa198;">(</span>f<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">endpoint</span> = options.pop<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'endpoint'</span>, <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.add_url_rule<span style="color: #2aa198;">(</span>rule, endpoint, f, **options<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> f
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> decorator
</pre>
</div>
</li>
<li>用法就很明显了
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello World&lt;/h1&gt;'</span>
</pre>
</div>
</li>
<li>这种被"修饰"的函数就叫view function, 这些函数的返回值可以是简答的string,当
然最好是HTML content. 最好是不要返回字符串,而且是使用template file,后面会讲
到.
</li>
<li>app.route的decorator里面的rule可以使用一些特殊的syntax,比如下面的例子,我们
使用了&lt;name&gt;来指代url里面的参数,而经过decorator的"妙手"之后,我们就可以在view
function里面使用这个变量name了.
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">user</span><span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello, %s!&lt;/h1&gt;'</span> % name
</pre>
</div>
</li>
<li>这种化腐朽为神奇的代码能够成功的原因,就是flask调用了Werkzeug这开源项目的功
能.使用url实例化了类:werkzeug.Rule
</li>
<li>werkzeug.Rule默认变量就是string类型,但是你其实也可以指定,比如/user/&lt;int:id&gt;
就会把id设置成int类.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Server Startup</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Flask application object也是要在建立以后,通过run()来进行明确的调度开始运行
server,因为server的程序一般都是运行一个loop,在这个loop里面等待着request,所
以如果不中断就会一直运行.为了我们调试方便,可以设置debug为True
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   app.run<span style="color: #2aa198;">(</span>debug=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">A Complete Application</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>前面讲的所有的代码,组成一个可以运行的python程序如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello World!&lt;/h1&gt;'</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">user</span><span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello, %s&lt;/h1&gt;'</span> % name

<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   app.run<span style="color: #2aa198;">(</span>debug=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">Application and Request Context</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>当Flask application object接到client发出(经过web server传递过来)的request的
时候,它希望request的一些信息能够分享给view function
</li>
<li>最简单的方法是把request object作为参数传递给view function,但是这会要求每个
view function都有额外的参数.而且request object只是我们需要的其中一个信息,如
果每个信息都需要一个参数的话,那么view function的参数列表就会非常的长
</li>
<li>flask的解决办法是创建了一个叫做contexts,而且有两种context:
<ul class="org-ul">
<li>一种是HTTP request级别的context,这个context是在某次http request完成之前在
不同函数直接可以"共享"的context
</li>
<li>一种是application级别的context,这个context是比较特殊的,因为HTTP本身就是前
后状态无关的协议,request context已经做到了这一点,设计application context
显得有点多余,其实这个application context是为了让多个app在一个WSGI server
上面共享信息,才创建的.其生命周期依然是一个HTTP Requst内!
</li>
</ul>
</li>
<li>常见的四种context对比如下
<table border="2" cellspacing="0" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Variable name</th>
<th scope="col" class="left">Context</th>
<th scope="col" class="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">current_app</td>
<td class="left">Application</td>
<td class="left">The application instance for the active application</td>
</tr>

<tr>
<td class="left">g</td>
<td class="left">Application</td>
<td class="left">An object that the application can use for temporary</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">storage during the handling of a request. This variable</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">is reset with each request</td>
</tr>

<tr>
<td class="left">request</td>
<td class="left">Request</td>
<td class="left">The request object, which encapsulates the contents of</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">a HTTP request sent by the client</td>
</tr>

<tr>
<td class="left">session</td>
<td class="left">Request</td>
<td class="left">The user session, a dictionary that the application can</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">use to store values that are "remembered" between</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">requests</td>
</tr>
</tbody>
</table>
</li>
<li>Python由于在threadlocal这种概念,所以为了让context信息能够只在thread内部使用
不得已做了些奇怪的动作:
<ul class="org-ul">
<li>要先push(也叫activate) application context,不然会报错
<div class="org-src-container">

<pre class="src src-python">&gt;&gt;&gt; <span style="color: #859900; font-weight: bold;">from</span> hello <span style="color: #859900; font-weight: bold;">import</span> app
&gt;&gt;&gt; <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> current_app
&gt;&gt;&gt; current_app.name
Traceback <span style="color: #2aa198;">(</span>most recent call last<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span> File <span style="color: #2aa198;">"&lt;stdin&gt;"</span>, line 1, <span style="color: #859900; font-weight: bold;">in</span> &lt;module&gt;
<span style="background-color: #eee8d5;"> </span> File <span style="color: #2aa198;">"/Users/hfeng/virtualpy/2014flask/lib/python2.7/site-packages/werkzeug/local.py"</span>, line 338, <span style="color: #859900; font-weight: bold;">in</span> __getattr__
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #657b83; font-weight: bold;">getattr</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>._get_current_object<span style="color: #b58900;">()</span>, name<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span> File <span style="color: #2aa198;">"/Users/hfeng/virtualpy/2014flask/lib/python2.7/site-packages/werkzeug/local.py"</span>, line 297, <span style="color: #859900; font-weight: bold;">in</span> _get_current_object
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">self</span>.__local<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span> File <span style="color: #2aa198;">"/Users/hfeng/virtualpy/2014flask/lib/python2.7/site-packages/flask/globals.py"</span>, line 34, <span style="color: #859900; font-weight: bold;">in</span> _find_app
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">raise</span> <span style="color: #b58900;">RuntimeError</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'working outside of application context'</span><span style="color: #2aa198;">)</span>
<span style="color: #b58900;">RuntimeError</span>: working outside of application context
&gt;&gt;&gt; app.app_context<span style="color: #2aa198;">()</span>.push<span style="color: #2aa198;">()</span>
&gt;&gt;&gt; current_app.name
<span style="color: #2aa198;">'hello'</span>
</pre>
</div>
</li>
<li>requst context也需要先push(),否则里面啥也没有
<div class="org-src-container">

<pre class="src src-python">&gt;&gt;&gt; <span style="color: #859900; font-weight: bold;">from</span> hello <span style="color: #859900; font-weight: bold;">import</span> app
&gt;&gt;&gt; <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request
&gt;&gt;&gt; request
&lt;LocalProxy unbound&gt;
&gt;&gt;&gt; <span style="color: #268bd2;">ctx</span> = app.test_request_context<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/?next=http://example.com/'</span><span style="color: #2aa198;">)</span>
&gt;&gt;&gt; ctx.push<span style="color: #2aa198;">()</span>
&gt;&gt;&gt; request
&lt;Request <span style="color: #2aa198;">'http://localhost/?next=http:%2F%2Fexample.com%2F'</span> <span style="color: #2aa198;">[</span>GET<span style="color: #2aa198;">]</span>&gt;
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">Request Dispatching</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>前面说过flask是使用了一个decorator来把view function和URL放到了一个map里面对
应起来.这个decorator我们也看了,其实就是包裹了一下app.add_url_rule()
</li>
<li>我们也可以看看view function和URL绑定的这个map
<div class="org-src-container">

<pre class="src src-python">&gt;&gt;&gt; <span style="color: #859900; font-weight: bold;">from</span> hello <span style="color: #859900; font-weight: bold;">import</span> app
&gt;&gt;&gt; app.url_map
Map<span style="color: #2aa198;">(</span><span style="color: #b58900;">[</span>&lt;Rule <span style="color: #2aa198;">'/'</span> <span style="color: #268bd2;">(</span>HEAD, OPTIONS, GET<span style="color: #268bd2;">)</span> -&gt; index&gt;,
<span style="background-color: #eee8d5;"> </span>&lt;Rule <span style="color: #2aa198;">'/static/&lt;filename&gt;'</span> <span style="color: #268bd2;">(</span>HEAD, OPTIONS, GET<span style="color: #268bd2;">)</span> -&gt; static&gt;,
<span style="background-color: #eee8d5;"> </span>&lt;Rule <span style="color: #2aa198;">'/user/&lt;name&gt;'</span> <span style="color: #268bd2;">(</span>HEAD, OPTIONS, GET<span style="color: #268bd2;">)</span> -&gt; user&gt;<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>有一个static的看起来有点陌生,这个是flask用来存储文件,图片等静态信息的地方
</li>
<li>除了GET是view function处理的外(不写什么方法,默认就是GET方法),HEAD和OPTION方
法是Flask自己默认支持的
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">Request Hooks</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>HTTP这种无状态协议有时候很需要在"处理HTTP request之前"和"处理HTTP request之
后"都运行一些动作(最常见的就是login),在rails里面就是before_filter和after_filter
而在flask里面就是request hook,常见的有:
<ul class="org-ul">
<li>before_first_requst: 在第一个request来之前运行的function
</li>
<li>before_request: 在每一个request来之前运行的function
</li>
<li>after_request: 在每一个request运行之后,"并且没有unhandled exception"发生的
情况下,运行的function
</li>
<li>teardown_request:在么一个requst运行之后,"即便发生了unhandled exception"的
情况下
</li>
</ul>
</li>
<li>request hook会和context紧密联系,一个常见的用法就是before_request把用户的登
录信息写入到application context g里面,必须存成g.user,后面到view function运行
的时候就可以直接从g.user里面读取这些信息.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8">Response</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>对于response来说,字符(或者html字符)信息固然重要,但是status code也非常重要,
前面我们的例子中没有设置这个code,那么就是flask默认设置的200(代表success)
</li>
<li>如果不想返回200,那么可以使用如下的代码来设置不同的返回值400
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Bad Request&lt;/h1&gt;'</span>, 400
</pre>
</div>
</li>
<li>上面这种返回多个参数(其实是一个tuple)的方法不是特别的直观,flask提供了一下函
数把参数捏合成一个response object. 下面的例子就是这样,这样的还可以对response
object做更改,比如加了一个cookie
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> make_response
<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">response</span> = make_response<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'&lt;h1&gt;This document carries a cookie!&lt;/h1&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   response.set_cookie<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'answer'</span>, <span style="color: #2aa198;">'42'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> response
</pre>
</div>
</li>
<li>有一种非常常见的response叫做redirect,status code是302. 因为太常用flask为它
设计了一个helper函数redirect()
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> redirect

<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'http://www.example.com'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>404当然也是天朝非常熟悉的status code啦
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> abort

<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;id&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get_user</span><span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">id</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">user</span> = load_user<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">id</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900; font-weight: bold;">not</span> user:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   abort<span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello, %s&lt;/h1&gt;'</span> % user.name
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9">Flask Extensions</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>flask是个轻量级的框架,其并不是所有的功能都做,而是把这些功能做成"可扩展"的形
式.方便你使用其他的package,或者是自己写
</li>
<li>flask就含有很多的扩展,这些扩展都叫做flask extension.
</li>
<li>flask开发的一个常见的需求,就是"不改动代码,就提供一些常用参数的改动",比如server
运行的端口号啊就经常改动,每次改源代码,太麻烦了.flask-script就是为这样的目的
而诞生的extension,安装方法如下
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #2aa198;">(</span>venv<span style="color: #2aa198;">)</span> $ pip install flask-script
</pre>
</div>
</li>
<li>代码需要一些改写
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask_script <span style="color: #859900; font-weight: bold;">import</span> Manager
<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="color: #268bd2;">manager</span> = Manager<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello World!&lt;/h1&gt;'</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">user</span><span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;h1&gt;Hello, %s!&lt;/h1&gt;'</span> % name


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   manager.run<span style="color: #2aa198;">()</span>
</pre>
</div>
</li>
<li>运行起来就是这种感觉
<div class="org-src-container">

<pre class="src src-sh">$ python hello.py -h

usage: hello.py <span style="color: #2aa198;">[</span>-h<span style="color: #2aa198;">]</span> <span style="color: #2aa198;">{</span>shell,runserver<span style="color: #2aa198;">}</span> ...

positional arguments:
  <span style="color: #2aa198;">{</span>shell,runserver<span style="color: #2aa198;">}</span>
    shell            Runs a Python shell inside Flask application context.
    runserver        Runs the Flask development server i.e. app.run<span style="color: #2aa198;">()</span>

optional arguments:
  -h, --help         show this help message and exit
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Chapter 3: Templates</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>在web开发的领域中，我们前面看到的flask中的view function其实承担了两种任务：
<ul class="org-ul">
<li>business logic:例如把用户的注册信息存入数据库
</li>
<li>presentation logic:例如把用户注册成功的信息以美观的形式发送回给浏览器以便
让用户能够得知
</li>
</ul>
</li>
<li>把这两者的代码混在一起，其实是不明智的（容易让人看不懂）， flask解决这个问题
的方法是把business logic保留在view function，而把presentation logic放在
template里面
</li>
<li>所谓template在flask的语境中其实就是一个file，而这个file的主体是html，但是在
需要显示的内容的部分是placeholder variable，每次传递不同的值给placeholder
variable会得到不同的网页（这也就是"动态网页"的来历）
</li>
<li>而每次把palaceholder variable变成实际的value，并且把最终的结果string作为
response返回的process就叫做rendering, flask使用了一个叫做jinja2的template
engine来render自己的网页
</li>
</ul>
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">The Jinja2 Template Engine</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>从最简单的直观感受来看,jinja2 template其实就是如下的含有placeholer的html文件
<div class="org-src-container">

<pre class="src src-web">&lt;h1&gt; Hello, <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> name <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span> ! &lt;/h1&gt;
</pre>
</div>
</li>
<li>默认情况下Flask会去自己root目录下面的templates子目录里面去寻找templates,
view function这一边也需要指定文件夹下的file name
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/index'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>render_template就是Flask提供的和jinja2整合的函数,整个函数还可以有第二个参数
这个参数是一个key=value的形式,包含template需要的placeholder变量的真实的值
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">user</span><span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'user.html'</span>,name=name<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>jinja2里面使用{{ name }}的办法来解析变量,而且这个变量可以是任何的python type
<div class="org-src-container">

<pre class="src src-web">&lt;p&gt; A value from a dictionary: <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> mydict<span style="color: #268bd2;">[</span>'key'<span style="color: #268bd2;">]</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>.&lt;/p&gt;
&lt;p&gt; A value from a list: <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> mylist<span style="color: #268bd2;">[</span>3<span style="color: #268bd2;">]</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>.&lt;/p&gt;
&lt;p&gt; A value from a list, which avariable index: <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> mylist<span style="color: #268bd2;">[</span>myintvar<span style="color: #268bd2;">]</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>. &lt;/p&gt;
&lt;p&gt; A value from an object's method: <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> myobj.somemethod<span style="color: #268bd2;">()</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>.&lt;/p&gt;
</pre>
</div>
</li>
<li>jinja2还提供了自己改变variable的能力,比如把名字首字母大写的功能
<div class="org-src-container">

<pre class="src src-web">Hello, <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> name | capitalize <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>改变变量的值很明显会减慢template的效率,所以jinjia2只提供了如下常用或者不得
不用的功能
<table border="2" cellspacing="0" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Filter name</th>
<th scope="col" class="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">safe</td>
<td class="left">Renders the value without applying escaping</td>
</tr>

<tr>
<td class="left">capitalize</td>
<td class="left">Convertst the first character of the value to uppercase and the rest to lowercase</td>
</tr>

<tr>
<td class="left">lower</td>
<td class="left">Converts the value to lowercase characters</td>
</tr>

<tr>
<td class="left">upper</td>
<td class="left">Converts the value to uppercase characters</td>
</tr>

<tr>
<td class="left">title</td>
<td class="left">Capitalizes each word in the value</td>
</tr>

<tr>
<td class="left">trim</td>
<td class="left">Removes leading and trailing whitespace from value</td>
</tr>

<tr>
<td class="left">striptags</td>
<td class="left">Removes any HTML tags from the value before rendering</td>
</tr>
</tbody>
</table>
</li>
<li>safe函数是需要说明一下的,默认情况下,jinja2为了安全要求(比如用户输入的内容,
黑客可以在里面写上代码,从而从客户端执行server的程序),比如'&lt;h1&gt;Hello&lt;/h1&gt;'
会自动被解析成如下的html string
<div class="org-src-container">

<pre class="src src-html"><span style="color: #268bd2;">&amp;lt;</span>h1<span style="color: #268bd2;">&amp;gt;</span>Hello<span style="color: #268bd2;">&amp;lt;</span>/h1<span style="color: #268bd2;">&amp;gt;</span>
</pre>
</div>
</li>
<li>而safe其作用是,如果你非常确信这个string里面的值是安全的(至少不是用户输入的),
你就可以使用了
</li>
<li>jinja2除了可以有些非常基础的转换函数,还可以使用control structure:
<ul class="org-ul">
<li>比如最常见的if else:
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% if user %<span style="color: #2aa198;">}</span>
Hello, <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> user <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>!
<span style="color: #2aa198;">{</span>% else %<span style="color: #2aa198;">}</span>
Hello, Stranger!
<span style="color: #2aa198;">{</span>% endif %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>还有loop
<div class="org-src-container">

<pre class="src src-web">&lt;ul&gt;
    <span style="color: #2aa198;">{</span>% for comment in comments %<span style="color: #2aa198;">}</span>
    &lt;li&gt;<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> comment <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>&lt;/li&gt;
    <span style="color: #2aa198;">{</span>% endfor %<span style="color: #2aa198;">}</span>
&lt;/ul&gt;
</pre>
</div>
</li>
<li>Jinja2还支持macro,类似于python的function,不仅仅是作用,写法也差不多
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% macro render_comment<span style="color: #b58900;">(</span>comment<span style="color: #b58900;">)</span> %<span style="color: #2aa198;">}</span>
&lt;li&gt;<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> comment <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span> &lt;/li&gt;
<span style="color: #2aa198;">{</span>% endmacro %<span style="color: #2aa198;">}</span>

&lt;ul&gt;
    <span style="color: #2aa198;">{</span>% for comment in comments %<span style="color: #2aa198;">}</span>
    <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> render_comment<span style="color: #268bd2;">(</span>comment<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
    <span style="color: #2aa198;">{</span>% endfor %<span style="color: #2aa198;">}</span>
&lt;/ul&gt;
</pre>
</div>
</li>
<li>我们可以把常用的macros写到一块,然后从一个文件里面导入
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% import 'macros.html' as macros %<span style="color: #2aa198;">}</span>
&lt;ul&gt;
    <span style="color: #2aa198;">{</span>% for comment in comments %<span style="color: #2aa198;">}</span>
    <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> macros.render_comment<span style="color: #268bd2;">(</span>comment<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
    <span style="color: #2aa198;">{</span>% endfor %<span style="color: #2aa198;">}</span>
&lt;/ul&gt;
</pre>
</div>
</li>
</ul>
</li>
<li>还有一种也勉强算是logic的tag,叫做block. block的主要作用是继承,不要害怕,这里
的继承没有cpp里面那么复杂,其主要作用就是为了"减少代码", block里面定义的在base
里面的代码可以在derived里面被替代:
<ul class="org-ul">
<li>我们先来看base.html
<div class="org-src-container">

<pre class="src src-web">&lt;html&gt;
    &lt;head&gt;
        <span style="color: #2aa198;">{</span>% block head %<span style="color: #2aa198;">}</span>
        &lt;title&gt; <span style="color: #2aa198;">{</span>% block title %<span style="color: #2aa198;">}</span> <span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span> - My Application &lt;/title&gt;
        <span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
    &lt;/head&gt;
    &lt;body&gt;
        <span style="color: #2aa198;">{</span>% block body %<span style="color: #2aa198;">}</span>
        <span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
</li>
<li>再来看看derived.html,特别注意,我们的block head写在了block title后面,是因为
block title在一开始有了值(index),我们block head想利用这个值(使用super()保
留原值),然后再添加自己的&lt;style&gt;!
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% extends "base.html" %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% block title %<span style="color: #2aa198;">}</span>Index <span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% block head %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> super<span style="color: #268bd2;">()</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
  &lt;style&gt;
  &lt;/style&gt;
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% block body %<span style="color: #2aa198;">}</span>
&lt;h1&gt;Hello, World!&lt;/h1&gt;
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Twitter Bootstrap Integration with Flask-Bootstrap</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>bootstrap也是一种框架,和我们常见框架不太一样,它本质上是一个css框架,大部分的
后端程序员对css都不太熟悉,bootstrap这么一个框架,让后端程序员只需要写html(或
者还有js)就可以完成工作,而不用去考虑不同设备浏览器的css"适配"
</li>
<li>对于flask来说,有一个extension叫做flask-bootstrap,其思想也特别简单,一旦你决定
使用(如下,实例化一个flask-bootstrap instance就可以),那么就提供一个base.html
给你用,这个base.html分成了很多个block,大部分block都是设计完备的,你只需要继承
然后再修改个别的block就可以了.
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask, render_template
<span style="color: #859900; font-weight: bold;">from</span> flask_script <span style="color: #859900; font-weight: bold;">import</span> Manager
<span style="color: #859900; font-weight: bold;">from</span> flask_bootstrap <span style="color: #859900; font-weight: bold;">import</span> Bootstrap

<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="color: #268bd2;">manager</span> = Manager<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">bootstrap</span> = Bootstrap<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span><span style="color: #2aa198;">)</span>


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">user</span><span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'user.html'</span>, name=name<span style="color: #2aa198;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   manager.run<span style="color: #2aa198;">()</span>
</pre>
</div>
</li>
<li>flask-bootstrap的base.html里面设计了如下的几个block
<table border="2" cellspacing="0" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Block name</th>
<th scope="col" class="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">doc</td>
<td class="left">The entire HTML document</td>
</tr>

<tr>
<td class="left">html_attribs</td>
<td class="left">Attributest inside the &lt;html&gt; tag</td>
</tr>

<tr>
<td class="left">html</td>
<td class="left">The contents of the &lt;html&gt; tag</td>
</tr>

<tr>
<td class="left">head</td>
<td class="left">The contents of the &lt;head&gt; tag</td>
</tr>

<tr>
<td class="left">title</td>
<td class="left">The contents of the &lt;title&gt; tag</td>
</tr>

<tr>
<td class="left">metas</td>
<td class="left">The list of &lt;meta&gt; tags</td>
</tr>

<tr>
<td class="left">styles</td>
<td class="left">Cascading stylesheet definitions</td>
</tr>

<tr>
<td class="left">body_attribs</td>
<td class="left">Attributes inside the &lt;body&gt; tag</td>
</tr>

<tr>
<td class="left">body</td>
<td class="left">The contents of the &lt;body&gt; tag</td>
</tr>

<tr>
<td class="left">navbar</td>
<td class="left">User-defined navigation bar</td>
</tr>

<tr>
<td class="left">content</td>
<td class="left">User-defined page content</td>
</tr>

<tr>
<td class="left">scripts</td>
<td class="left">JavaScript declarations at the bottomof the document</td>
</tr>
</tbody>
</table>
</li>
<li>我们一般只需要更改其中的title, navbar, content就可以了,其他最好不要动,因为
你一动就等于完全替代了flask-bootstrap自己的代码.如果实在要动除了title, navbar
content的部分以外的block,一定要使用super(),保留原来的代码,如下
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% block scripts %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> super<span style="color: #268bd2;">()</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
&lt;script type="text/javascript" src="my-script.js"&gt;&lt;/script&gt;
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Custom Error Pages</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>status code 404是我国非常常见的页面了,而status code 500也是非常常见(exception
没有处理),我们可以使用如下代码来指定处理error的page,并且指定status code
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">page_not_found</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'404.html'</span><span style="color: #2aa198;">)</span>, 404

<span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>500<span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">internal_server_error</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'500.html'</span><span style="color: #2aa198;">)</span>, 500
</pre>
</div>
</li>
<li>这两个html(404.html, 500.html)都有很多共同的部分,我们可以借助flask的html可以
继承的特性(再借助flask-bootstrap来帮我们设计css), 来如下完成这两个html
<pre class="example">
    +------------------------------+
    |    bootstrap/base.html       |
    +---------------+--------------+
                    |
                    |
            +-------+-------+
            |   base.html   |
            +---+------+----+-
               /        \
              /          \
             /            \
+---------------+     +---------------+
|    404.html   |     |    500.html   |
+---------------+     +---------------+
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">Links</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>互联网的核心就是link,不仅仅不同网站之间会相互建立连接,自己本站之内的相互使用
link的情况也更加普遍.在网站小的时候,可以直接写上url,但是这样有两个缺点:
<ul class="org-ul">
<li>容易写错
</li>
<li>url有时候会更改
</li>
</ul>
</li>
<li>flask天生容易去克服这个问题,因为flask是把view function和url的对应关系放到了
一个map里面.url改动并不会导致view function改动(view function改动名字那就是
重构了),所以flask引入了一个函数url来获取一个view function的url,以我们的第一
个例子为例:
<ul class="org-ul">
<li>url_for('index') 会得到"/"
</li>
<li>url_for('index', _external=True),会得到"<a href="http://localhost:5000/">http://localhost:5000/</a>".
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5">Static Files</h3>
<div class="outline-text-3" id="text-3-5">
<ul class="org-ul">
<li>我们前面看到过flask为静态文件专门设计了一个staticurl,其实就是default的放到
了static文件夹下面,我们还是可以使用url_for来获取这个静态文件的地址,方法是
<div class="org-src-container">

<pre class="src src-python">url_for<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'static'</span>, filename=<span style="color: #2aa198;">'css/style.css'</span>, _external=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">=&gt; http://localhost:5000/static/css/styles.css</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6">Location of Dates and Times with Flask-Momen</h3>
<div class="outline-text-3" id="text-3-6">
<ul class="org-ul">
<li>如今的互联网是连接世界的工具,自然不能只考虑一个时区.存储时间的best practice
是:
<pre class="example">
server端所有的时间都是以UTC时间存储
</pre>
</li>
<li>而business logic所有的操作也都是基于server里面的UTC时间的,但是可以在present
logic,也就是render的过程中,把UTC的时间转换成用户的当地时间.我们可能会希望jinja2
像提供safe()函数一样提供这个功能.但是jinja2没有,但是js社区的moment.js提供了
这种功能
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask_script <span style="color: #859900; font-weight: bold;">import</span> Manager
<span style="color: #859900; font-weight: bold;">from</span> flask_bootstrap <span style="color: #859900; font-weight: bold;">import</span> Bootstrap
<span style="color: #859900; font-weight: bold;">from</span> flask_moment <span style="color: #859900; font-weight: bold;">import</span> Moment

<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="color: #268bd2;">manager</span> = Manager<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">bootstrap</span> = Bootstrap<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">moment</span> = Moment<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>在template页面,还需要手动加入moment.js,可以选择手动加入js文件,或者像下面这
样使用helper函数加入moment.js,这里是更改了scripts block(注意不要忘记super())
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% block scripts %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> super<span style="color: #268bd2;">()</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> moment.include_moment<span style="color: #268bd2;">()</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>在使用的时候,我们肯定首先要在business logic里面传递一个时间
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> datetime <span style="color: #859900; font-weight: bold;">import</span> datetime

<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  current_time=datetime.utcnow<span style="color: #b58900;">()</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>在present logic里面,也就是template里面,我们就可以把moment.js提供的函数当做
jinja2提供的函数来转换utc时间了
<div class="org-src-container">

<pre class="src src-web">&lt;p&gt; The local date and time is <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> moment<span style="color: #268bd2;">(</span>current_time<span style="color: #268bd2;">)</span>.format<span style="color: #268bd2;">(</span>'LLL'<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>. &lt;/p&gt;
&lt;p&gt; That was <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> moment<span style="color: #268bd2;">(</span>current_time<span style="color: #268bd2;">)</span>.fromNow<span style="color: #268bd2;">(</span>refresh=True<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span> &lt;/p&gt;
</pre>
</div>
</li>
<li>我们经常在页面看到的"2 minutes ago", "五分钟前"就是依靠这个fromNow()做出来
的.之所以有中文有英文,也是可以设置的,比如设置成西班牙文或者中文
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> moment.lang<span style="color: #268bd2;">(</span>'es'<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> moment.lang<span style="color: #268bd2;">(</span>'zh-CN'<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Chapter 4: Web Forms</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>flask里面的request object包含了client的所有的信息,其中一个最重要的信息就是
request.form提供了POST里面的form data的信息
</li>
<li>虽然理论上面,我们有这个request.form就可以完全完成我们的工作了,但是实际上,有些
工作,比如生成HTML form表格,验证form data的有效性等工作,都是非常繁琐麻烦的,我
们可以使用Flask的extension来完成这些工作,这个extension就是flask-WTF
</li>
</ul>
</div>
<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">Cross-Site Request Forgery(CSRF) Protection</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>CSRF是一种非常常见的攻击方式,其原理就是:
<ul class="org-ul">
<li>用户的cookie信息是存在浏览器里面的
</li>
<li>用户点击"恶意链接"里面可能存在一些"恶意form",这些"恶意form"产生的post信息
会对用户造成伤害(因为原来server验证用户的唯一方式就是cookie)
</li>
</ul>
</li>
<li>预防CSRF的方法最常用的一种就是在每个form里面添加一个hidden的input,其值是server
填充进去的,一个server生成的一个单项加密的值(就是只能从'原始值'得到'加密值',
不能反过来), 就我们的flask-wtf来说,其使用如下的值来生成hidden token:
<ul class="org-ul">
<li>一个salt: 这个salt是cookie里面存储的session里面存储的一个值叫做csrf_token
请大家一定不要误会,这个csrf_token就是使用随机值生成的一个字符串,用来做salt
的,为了方便存储在cookie里面(cookie的值一般是base64转码的,是可以相互转换来
转换去的),如果你换个浏览器就会发现这个值不一样了.我们可以找到网页的cookie值
使用如下的方法就可以把cookie转换成我们的session 对象.
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> hashlib <span style="color: #859900; font-weight: bold;">import</span> sha1
<span style="color: #859900; font-weight: bold;">from</span> flask.sessions <span style="color: #859900; font-weight: bold;">import</span> session_json_serializer
<span style="color: #859900; font-weight: bold;">from</span> itsdangerous <span style="color: #859900; font-weight: bold;">import</span> URLSafeTimedSerializer

<span style="color: #268bd2;">s</span> = URLSafeTimedSerializer<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'hard to guess string'</span>,
<span style="background-color: #eee8d5;"> </span>   salt=<span style="color: #2aa198;">'cookie-session'</span>,
<span style="background-color: #eee8d5;"> </span>   serializer=session_json_serializer,
<span style="background-color: #eee8d5;"> </span>   signer_kwargs=<span style="color: #b58900;">{</span><span style="color: #2aa198;">'key_derivation'</span>: <span style="color: #2aa198;">'hmac'</span>, <span style="color: #2aa198;">'digest_method'</span>: sha1<span style="color: #b58900;">}</span>
<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">session_data</span> = s.loads<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'eyJjc3JmX3Rva2VuIjp7IiBiIjoiWVRCbFlUTXhaREkzWkRBNU5tST\</span>
<span style="color: #2aa198;">BZbUZsTWpVMk1EVXdZalptWVRBMVpESXdPV1V6T0RjeE5BPT0ifX0.CqVM1w.o2zmmPgj8HGsyh9Gd\</span>
<span style="color: #2aa198;">ikA2c_d_mw'</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>session_data<span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">###############################################################</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;              #</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">{u'csrf_token': 'a0ea31d27d096b4bae256050b6fa05d209e38714'} #</span>
<span style="color: #93a1a1;">###############################################################</span>
</pre>
</div>
</li>
<li>secret_key: 这个是你网站的"密码",千万不能给其他人看到,这个密码一般存储在
环境变量里面.设置的方法如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SECRET_KEY'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'hard to guess string'</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">Form Classes</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>对于html来说,表单是非常重要的一类代码,因为POST请求只能在表单里面实现,所以专
门有一个extension叫做flask-wtf为我们提供对表单的整合,就是把需要的field都放
到一个WTForm object里面,然后传给template:
<ul class="org-ul">
<li>server端的代码如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask, render_template
<span style="color: #859900; font-weight: bold;">from</span> flask_script <span style="color: #859900; font-weight: bold;">import</span> Manager
<span style="color: #859900; font-weight: bold;">from</span> flask_bootstrap <span style="color: #859900; font-weight: bold;">import</span> Bootstrap
<span style="color: #859900; font-weight: bold;">from</span> flask_moment <span style="color: #859900; font-weight: bold;">import</span> Moment
<span style="color: #859900; font-weight: bold;">from</span> flask_wtf <span style="color: #859900; font-weight: bold;">import</span> Form
<span style="color: #859900; font-weight: bold;">from</span> wtforms <span style="color: #859900; font-weight: bold;">import</span> StringField, SubmitField
<span style="color: #859900; font-weight: bold;">from</span> wtforms.validators <span style="color: #859900; font-weight: bold;">import</span> Required

<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SECRET_KEY'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'hard to guess string'</span>

<span style="color: #268bd2;">manager</span> = Manager<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">bootstrap</span> = Bootstrap<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">moment</span> = Moment<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>


<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NameForm</span><span style="color: #2aa198;">(</span>Form<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = StringField<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'What is your name?'</span>, validators=<span style="color: #b58900;">[</span>Required<span style="color: #268bd2;">()</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">submit</span> = SubmitField<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'Submit'</span><span style="color: #2aa198;">)</span>


<span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">page_not_found</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'404.html'</span><span style="color: #2aa198;">)</span>, 404


<span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>500<span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">internal_server_error</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'500.html'</span><span style="color: #2aa198;">)</span>, 500


<span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form.name.data</span> = <span style="color: #2aa198;">''</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=name<span style="color: #2aa198;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   manager.run<span style="color: #2aa198;">()</span>
</pre>
</div>
</li>
<li>而template就可以对form这个对象进行操作(注意上面的例子,一旦form.name.data
里面有值,那么就赋值给name,而且form.name.data马上设置为空,否则input框里面
还是会有上次的值)
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% extends "base.html" %<span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% import "bootstrap/wtf.html" as wtf %<span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">{</span>% block title %<span style="color: #2aa198;">}</span>Flasky<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">{</span>% block page_content %<span style="color: #2aa198;">}</span>
&lt;div class="page-header"&gt;
    &lt;h1&gt;Hello, <span style="color: #2aa198;">{</span>% if name %<span style="color: #2aa198;">}{</span><span style="color: #b58900;">{</span> name <span style="color: #b58900;">}</span><span style="color: #2aa198;">}{</span>% else %<span style="color: #2aa198;">}</span>Stranger<span style="color: #2aa198;">{</span>% endif %<span style="color: #2aa198;">}</span>!&lt;/h1&gt;
&lt;/div&gt;
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> wtf.quick_form<span style="color: #268bd2;">(</span>form<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">Redirects and User Session</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>上面的处理GET和POST请求使用一个URL的代码,会出现"表单重复提交"的问题,重现的
步骤如下
<pre class="example">
打开浏览器输入http://localhost:5000,然后填入用户'abc'提交. 之后显示
hello abc,马上刷新浏览器会出现警告"确认重新提交表单"警告
</pre>
</li>
<li>出现上述问题的原因是"刷新"的原理是"重复上一次的HTTP请求",我们上一次是POST请
求,刷新了之后,必然是发送POST请求.那么解决的办法自然是"不让POST作为最后一次
的http请求",使用redirect的方法把post请求之后加入一个GET请求,那么"刷新"的话,
只会刷新出GET来
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form.name.data</span> = <span style="color: #2aa198;">''</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=name<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>这样以后,还是有问题,因为我们的POST请求是可以访问name这个变量的,但是我们
redirect的时候并没有带着这个name变量,下一次redirect的GET请求会并不会进入这
个if语句,所以name最后会是一个None.
</li>
<li>问题的原因在于HTTP请求是没有status,我们在不同的http request之间传递数据需要
框架的session支持(前面的csrf_token也是存在了session里面,而且你可以看到,使用
了secret_token进行加密,不是非常重要的数据,比如密码,都是可以放在session里面
了), session通常会存储用户一般隐私(比如输入了什么值,不会存储密码的),因为通常
会存储在cookie里面,所以要加密(但是这个加密是可逆的,而不是密码或者hidden的csrf
token value不可逆)
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">]</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">Message Flashing</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>有一类信息是用来提示用户的, 比如登录时候的"密码错误",这个字符串,还是存在server
端,然后发给client端比较好.
</li>
<li>我们当然可以在render_template里面加上这个hash值,但是由于这种值特别常用,flask
或者说绝大多数的web框架都给这种情况取了个名字叫做flash,而且做了支持:
<ul class="org-ul">
<li>在server端是flash()函数
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">old_name</span> = session.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> old_name <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span> <span style="color: #859900; font-weight: bold;">and</span> old_name != form.name.data:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   flash<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'Looks like you have changed your name!'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">]</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>在template端是get_flashed_messages()函数(更改在base.html,因为大部分的页面都会用到flash)
<div class="org-src-container">

<pre class="src src-python"><span style="color: #2aa198;">{</span>% block content %<span style="color: #2aa198;">}</span>
&lt;div <span style="color: #859900; font-weight: bold;">class</span>=<span style="color: #2aa198;">"container"</span>&gt;
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">{</span>% <span style="color: #859900; font-weight: bold;">for</span> message <span style="color: #859900; font-weight: bold;">in</span> get_flashed_messages<span style="color: #b58900;">()</span> %<span style="color: #2aa198;">}</span>
<span style="background-color: #eee8d5;"> </span>   &lt;div <span style="color: #859900; font-weight: bold;">class</span>=<span style="color: #2aa198;">"alert alert-warning"</span>&gt;
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   &lt;button <span style="color: #657b83; font-weight: bold;">type</span>=<span style="color: #2aa198;">"button"</span> <span style="color: #859900; font-weight: bold;">class</span>=<span style="color: #2aa198;">"close"</span> data-<span style="color: #268bd2;">dismiss</span>=<span style="color: #2aa198;">"alert"</span>&gt;&amp;times;&lt;/button&gt;
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> message <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="background-color: #eee8d5;"> </span>   &lt;/div&gt;
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">{</span>% endfor %<span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">{</span>% block page_content %<span style="color: #2aa198;">}{</span>% endblock %<span style="color: #2aa198;">}</span>
&lt;/div&gt;
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Chapter 5: Databases</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">SQL Databases</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>关系型数据库中的主力是table,每个table都对应OO语言中的一个对象
</li>
<li>每个table都有一列非常重要,叫做primary key.来唯一标示自己
</li>
<li>table种还有可能有一个叫做foreign key的用来指向其他table(或者本table)里面的
某一行, foreign key联系其他table里面行的行为就叫做"关系",这也是关系型数据库
的来历
</li>
<li>关系型数据库会把不同"对象"拆分成不同的表存储,其优点是信息不回重复,存储效率
高,其缺点是join表查询有时候会很复杂
</li>
<li>数据库中的每一行叫做一个record
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">NoSQL Databases</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>nosql数据库的特点是:
<ul class="org-ul">
<li>使用collections替代table
</li>
<li>使用documents替代record
</li>
</ul>
</li>
<li>由于nosql里面join的实现难度特别大,所以一般都不支持join,需要程序自己进行joing
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">Database Management with Flask-SQLAlchemy</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>SQLAlchemy是python里面最好的ORM库,flask实现了一个extension叫做Flask-SQLAlchemy
来对它进行封装和整合,其初始化方法如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask_sqlalchemy <span style="color: #859900; font-weight: bold;">import</span> SQLAlchemy

<span style="color: #268bd2;">basedir</span> = os.path.abspath<span style="color: #2aa198;">(</span>os.path.dirname<span style="color: #b58900;">(</span>__file__<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SECRET_KEY'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'hard to guess string'</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SQLALCHEMY_DATABASE_URI'</span><span style="color: #2aa198;">]</span> =\
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'sqlite:///'</span> + os.path.join<span style="color: #2aa198;">(</span>basedir, <span style="color: #2aa198;">'data.sqlite'</span><span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">True</span>

<span style="color: #268bd2;">manager</span> = Manager<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">bootstrap</span> = Bootstrap<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">moment</span> = Moment<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">db</span> = SQLAlchemy<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>其中db就是SQLAlchemy中代表数据库的instance
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4">Model Definition</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>ORM里面都是一个class对应一个table, 一个attribute对应一个column
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Role</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">__tablename__</span> = <span style="color: #2aa198;">'roles'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #657b83; font-weight: bold;">id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, primary_key=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">name</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>64<span style="color: #b58900;">)</span>, unique=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__repr__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;Role %r&gt;'</span> % <span style="color: #859900; font-weight: bold;">self</span>.name


<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">User</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">__tablename__</span> = <span style="color: #2aa198;">'users'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #657b83; font-weight: bold;">id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, primary_key=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">username</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>64<span style="color: #b58900;">)</span>, unique=<span style="color: #268bd2; font-weight: bold;">True</span>, index=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__repr__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;User %r&gt;'</span> % <span style="color: #859900; font-weight: bold;">self</span>.username
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5">Relationships</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>一个Role可能有多个User,而一个User只能有一个Role,所以Role和User就是one-to-many
的关系, 在SQLAlchemy中的实现方法如下:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Role</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">...</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">users</span> = db.relationship<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'User'</span>, backref=<span style="color: #2aa198;">'role'</span><span style="color: #2aa198;">)</span>

<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">User</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">...</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">role_id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, db.ForeignKey<span style="color: #b58900;">(</span><span style="color: #2aa198;">'roles.id'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>User下面新的attribute明确的指出了ForeignKey,因为User是Many那一边,所以只要写
出roles.id就可以了
</li>
<li>而Role这一段是One,对应的User是many,所以使用了复数users,而参数backref的意思
是在Many那一边,我可以以`role`的名字出现(不然的话,就是role_id)
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6">Database Operations</h3>
<div class="outline-text-3" id="text-5-6">
<ul class="org-ul">
<li>我们创建了SQLAlchemy的class以后,其实就等于创建好了create table的SQL语句,我们
通过db instance的create_all()函数就可以完成创建数据库的工作了
<div class="org-src-container">

<pre class="src src-sh">$ python hello.py shell

&gt;&gt;&gt; from hello import db
&gt;&gt;&gt; db.create_all<span style="color: #2aa198;">()</span>
</pre>
</div>
</li>
<li>而删除数据库(同时清除所有数据)的工作就是
<div class="org-src-container">

<pre class="src src-python">db.drop_all<span style="color: #2aa198;">()</span>
</pre>
</div>
</li>
<li>插入数据的方法如下:
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; from hello import Role,User
from hello import Role,User
&gt;&gt;&gt; admin_role = Role<span style="color: #2aa198;">(</span><span style="color: #268bd2;">name</span>=<span style="color: #2aa198;">'Admin'</span><span style="color: #2aa198;">)</span>
admin_role = Role<span style="color: #2aa198;">(</span><span style="color: #268bd2;">name</span>=<span style="color: #2aa198;">'Admin'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>我们这样加入admin_role以后,其实只是在内存里面有这个值,并没有写入到数据库里面
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
None
&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&lt;Role <span style="color: #2aa198;">'Admin'</span>&gt;
</pre>
</div>
</li>
<li>从内存写入到数据库里面要有两个步骤,第一是db.session.add()先把object加入到数
据库,第二要使用db.session.commit()函数"显示的把改动写入到数据库里面",注意:
默认大部分数据库(比如mysql)都会默认开启autocommit,等于把每条sql都当做一个独
立的transaction,但是python连接数据库都会默认把autocommit关上,让你自己commit()
的时候,才真正写入.
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; db.session.add<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">db.session.add</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
None
&gt;&gt;&gt; db.session.commit<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">db.session.commit</span><span style="color: #2aa198;">()</span>
&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role.id<span style="color: #2aa198;">)</span>
1
</pre>
</div>
</li>
<li>db.session其实最好的名字应该叫做db.transaction,这样就不会和flask的session
object相混了.
</li>
<li>更改一个row的方法如下
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&lt;Role u<span style="color: #2aa198;">'Admin'</span>&gt;
&gt;&gt;&gt; admin_role.name = <span style="color: #2aa198;">'Administrator'</span>
admin_role.name = <span style="color: #2aa198;">'Administrator'</span>
&gt;&gt;&gt; db.session.add<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">db.session.add</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&gt;&gt;&gt; db.session.commit<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">db.session.commit</span><span style="color: #2aa198;">()</span>
&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&lt;Role u<span style="color: #2aa198;">'Administrator'</span>&gt;
</pre>
</div>
</li>
<li>删除一行的办法是db.session.delete(obj),然后commit()
</li>
<li>查询的复杂性是体现动态语言优势的地方:
<ul class="org-ul">
<li>最简单的查询,是查出所有的结果
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; Role.query.all<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">Role.query.all</span><span style="color: #2aa198;">()</span>
<span style="color: #2aa198;">[</span>&lt;Role u<span style="color: #2aa198;">'Administrator'</span>&gt;<span style="color: #2aa198;">]</span>
&gt;&gt;&gt; User.query.all<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">User.query.all</span><span style="color: #2aa198;">()</span>
<span style="color: #2aa198;">[</span>&lt;User u<span style="color: #2aa198;">'john'</span>&gt;, &lt;User u<span style="color: #2aa198;">'susan'</span>&gt;<span style="color: #2aa198;">]</span>
</pre>
</div>
</li>
<li>还可以使用filter
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; print<span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">print</span><span style="color: #2aa198;">(</span>admin_role<span style="color: #2aa198;">)</span>
&lt;Role u<span style="color: #2aa198;">'Administrator'</span>&gt;
&gt;&gt;&gt; User.query.filter_by<span style="color: #2aa198;">(</span><span style="color: #268bd2;">role</span>=admin_role<span style="color: #2aa198;">)</span>.all<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">User.query.filter_by</span><span style="color: #2aa198;">(</span><span style="color: #268bd2;">role</span>=admin_role<span style="color: #2aa198;">)</span>.all<span style="color: #2aa198;">()</span>
<span style="color: #2aa198;">[</span>&lt;User u<span style="color: #2aa198;">'john'</span>&gt;, &lt;User u<span style="color: #2aa198;">'susan'</span>&gt;<span style="color: #2aa198;">]</span>
</pre>
</div>
</li>
<li>SQLAlchemy还把str()函数设置为"展示"SELECT语句
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; str<span style="color: #2aa198;">(</span>User.query.filter_by<span style="color: #b58900;">(</span><span style="color: #268bd2;">role</span>=admin_role<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">str</span><span style="color: #2aa198;">(</span>User.query.filter_by<span style="color: #b58900;">(</span><span style="color: #268bd2;">role</span>=admin_role<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">'SELECT users.id AS users_id, users.username AS users_username,</span>
<span style="color: #2aa198;"> users.role_id AS users_role_id \nFROM users</span>
<span style="color: #2aa198;"> \nWHERE :param_1 = users.role_id'</span>
</pre>
</div>
</li>
<li>我们在代码里面不能写"Administrator"所在的object,而要使用搜索,搜索到这个
object
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; Role.query.filter_by<span style="color: #2aa198;">(</span><span style="color: #268bd2;">name</span>=<span style="color: #2aa198;">'Administrator'</span><span style="color: #2aa198;">)</span>.first<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">Role.query.filter_by</span><span style="color: #2aa198;">(</span><span style="color: #268bd2;">name</span>=<span style="color: #2aa198;">'Administrator'</span><span style="color: #2aa198;">)</span>.first<span style="color: #2aa198;">()</span>
&lt;Role u<span style="color: #2aa198;">'Administrator'</span>&gt;
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7">Database Use in View Functions</h3>
<div class="outline-text-3" id="text-5-7">
<ul class="org-ul">
<li>数据库的应用肯定是为了在web上面显示:
<ul class="org-ul">
<li>server端的代码如下:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">user</span> = User.query.filter_by<span style="color: #2aa198;">(</span>username=form.name.data<span style="color: #2aa198;">)</span>.first<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> user <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">user</span> = User<span style="color: #2aa198;">(</span>username=form.name.data<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   db.session.add<span style="color: #2aa198;">(</span>user<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'known'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">False</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'known'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">]</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  known=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'known'</span>, <span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>template端的代码如下:
<div class="org-src-container">

<pre class="src src-web"><span style="color: #2aa198;">{</span>% block page_content %<span style="color: #2aa198;">}</span>
&lt;div class="page-header"&gt;
    &lt;h1&gt;Hello, <span style="color: #2aa198;">{</span>% if name %<span style="color: #2aa198;">}{</span><span style="color: #b58900;">{</span> name <span style="color: #b58900;">}</span><span style="color: #2aa198;">}{</span>% else %<span style="color: #2aa198;">}</span>Stranger<span style="color: #2aa198;">{</span>% endif %<span style="color: #2aa198;">}</span>!&lt;/h1&gt;
    <span style="color: #2aa198;">{</span>% if not known %<span style="color: #2aa198;">}</span>
    &lt;p&gt;Pleased to meet you!&lt;/p&gt;
    <span style="color: #2aa198;">{</span>% else %<span style="color: #2aa198;">}</span>
    &lt;p&gt;Happy to see you again!&lt;/p&gt;
    <span style="color: #2aa198;">{</span>% endif %<span style="color: #2aa198;">}</span>
&lt;/div&gt;
<span style="color: #2aa198;">{</span><span style="color: #b58900;">{</span> wtf.quick_form<span style="color: #268bd2;">(</span>form<span style="color: #268bd2;">)</span> <span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span>% endblock %<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8">Database Migrations with Flask-Migrate</h3>
<div class="outline-text-3" id="text-5-8">
<ul class="org-ul">
<li>Flask-SQLAlchemy只是能够create table,如果我们的table发生了改变,其唯一的办法
就是先把所有的table drop掉,然后重新create一遍table.这样一来,所有的数据都没有了.
</li>
<li>这不是我们想要的,而能够保留数据的前提下进行table的格式更新,需要的是migration
的extension,也就是Flask-Migrate,其是一个队Alembic 的wrapper
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask_migrate <span style="color: #859900; font-weight: bold;">import</span> Migrate, MigrateCommand

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">...</span>
<span style="color: #268bd2;">migrate</span> = Migrate<span style="color: #2aa198;">(</span>app, db<span style="color: #2aa198;">)</span>
manager.add_command<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'db'</span>, MigrateCommand<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>加完这几行以后,python hello.py就会多了一个db功能
<div class="org-src-container">

<pre class="src src-sh">$ python hello.py --help
usage: hello.py <span style="color: #2aa198;">[</span>-h<span style="color: #2aa198;">]</span> <span style="color: #2aa198;">{</span>shell,db,runserver<span style="color: #2aa198;">}</span> ...

positional arguments:
  <span style="color: #2aa198;">{</span>shell,db,runserver<span style="color: #2aa198;">}</span>
    shell               Runs a Python shell inside Flask application context.
    db                  Perform database migrations
    runserver           Runs the Flask development server i.e. app.run<span style="color: #2aa198;">()</span>

optional arguments:
  -h, --help            show this help message and exit
</pre>
</div>
</li>
<li>我们执行db下面的init,就会生成一个文件夹migrations, 这个文件夹以后会放置所有
的migration文件的,换言之,init一般只需要第一次运行,以后还是要加入到版本管理
里面.
<div class="org-src-container">

<pre class="src src-sh">$ python hello.py db init
  Creating directory /Users/hfeng/github/flasky/migrations ... done
  Creating directory /Users/hfeng/github/flasky/migrations/versions ... done
  Generating /Users/hfeng/github/flasky/migrations/alembic.ini ... done
  Generating /Users/hfeng/github/flasky/migrations/env.py ... done
  Generating /Users/hfeng/github/flasky/migrations/env.pyc ... done
  Generating /Users/hfeng/github/flasky/migrations/README ... done
  Generating /Users/hfeng/github/flasky/migrations/script.py.mako ... done
  Please edit configuration/connection/logging settings<span style="color: #859900; font-weight: bold;"> in</span>
  <span style="color: #2aa198;">'/Users/hfeng/github/flasky/migrations/alembic.ini'</span> before proceeding.
</pre>
</div>
</li>
<li>第二步是生成migration文件
<div class="org-src-container">

<pre class="src src-sh">$ python hello.py db migrate -m <span style="color: #2aa198;">"initial migration"</span>
INFO  <span style="color: #2aa198;">[</span>alembic.migration<span style="color: #2aa198;">]</span> Context impl SQLiteImpl.
INFO  <span style="color: #2aa198;">[</span>alembic.migration<span style="color: #2aa198;">]</span> Will assume non-transactional DDL.
INFO  <span style="color: #2aa198;">[</span>alembic.autogenerate.compare<span style="color: #2aa198;">]</span> Detected added table <span style="color: #2aa198;">'roles'</span>
INFO  <span style="color: #2aa198;">[</span>alembic.autogenerate.compare<span style="color: #2aa198;">]</span> Detected added table <span style="color: #2aa198;">'users'</span>
INFO  <span style="color: #2aa198;">[</span>alembic.autogenerate.compare<span style="color: #2aa198;">]</span> Detected added index <span style="color: #2aa198;">'ix_users_username'</span> on <span style="color: #2aa198;">'['</span>username<span style="color: #2aa198;">']'</span>
  Generating /Users/hfeng/github/flasky/migrations/versions/3002e7cc92d6_initial_migration.py ... done
</pre>
</div>
</li>
<li>我们可以看看我们生成的这个叫做3002e7cc92d6_initial_migration.py的文件,可以
看到,第一次运行的话,这个文件里面就是create_all()一样的效果,创建一个空结构的
数据库而已
<div class="org-src-container">

<pre class="src src-python"><span style="color: #2aa198;">"""initial migration</span>

<span style="color: #2aa198;">Revision ID: 3002e7cc92d6</span>
<span style="color: #2aa198;">Revises: None</span>
<span style="color: #2aa198;">Create Date: 2016-08-29 17:21:24.054417</span>

<span style="color: #2aa198;">"""</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">revision identifiers, used by Alembic.</span>
<span style="color: #268bd2;">revision</span> = <span style="color: #2aa198;">'3002e7cc92d6'</span>
<span style="color: #268bd2;">down_revision</span> = <span style="color: #268bd2; font-weight: bold;">None</span>

<span style="color: #859900; font-weight: bold;">from</span> alembic <span style="color: #859900; font-weight: bold;">import</span> op
<span style="color: #859900; font-weight: bold;">import</span> sqlalchemy <span style="color: #859900; font-weight: bold;">as</span> sa


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">upgrade</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;">### </span><span style="color: #93a1a1;">commands auto generated by Alembic - please adjust! ###</span>
<span style="background-color: #eee8d5;"> </span>   op.create_table<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'roles'</span>,
<span style="background-color: #eee8d5;"> </span>   sa.Column<span style="color: #b58900;">(</span><span style="color: #2aa198;">'id'</span>, sa.Integer<span style="color: #268bd2;">()</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.Column<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span>, sa.String<span style="color: #268bd2;">(</span>length=64<span style="color: #268bd2;">)</span>, nullable=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.PrimaryKeyConstraint<span style="color: #b58900;">(</span><span style="color: #2aa198;">'id'</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.UniqueConstraint<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   op.create_table<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'users'</span>,
<span style="background-color: #eee8d5;"> </span>   sa.Column<span style="color: #b58900;">(</span><span style="color: #2aa198;">'id'</span>, sa.Integer<span style="color: #268bd2;">()</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.Column<span style="color: #b58900;">(</span><span style="color: #2aa198;">'username'</span>, sa.String<span style="color: #268bd2;">(</span>length=64<span style="color: #268bd2;">)</span>, nullable=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.Column<span style="color: #b58900;">(</span><span style="color: #2aa198;">'role_id'</span>, sa.Integer<span style="color: #268bd2;">()</span>, nullable=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.ForeignKeyConstraint<span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span><span style="color: #2aa198;">'role_id'</span><span style="color: #268bd2;">]</span>, <span style="color: #268bd2;">[</span><span style="color: #2aa198;">'roles.id'</span><span style="color: #268bd2;">]</span>, <span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   sa.PrimaryKeyConstraint<span style="color: #b58900;">(</span><span style="color: #2aa198;">'id'</span><span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   op.create_index<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'ix_users_username'</span>, <span style="color: #2aa198;">'users'</span>, <span style="color: #b58900;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #b58900;">]</span>, unique=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;">### </span><span style="color: #93a1a1;">end Alembic commands ###</span>


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">downgrade</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;">### </span><span style="color: #93a1a1;">commands auto generated by Alembic - please adjust! ###</span>
<span style="background-color: #eee8d5;"> </span>   op.drop_index<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'ix_users_username'</span>, <span style="color: #2aa198;">'users'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   op.drop_table<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'users'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   op.drop_table<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'roles'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;">### </span><span style="color: #93a1a1;">end Alembic commands ###</span>
</pre>
</div>
</li>
<li>下面我们就可以使用db upgrade来运行我们对数据库的更改了.
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #2aa198;">(</span>2014flask<span style="color: #2aa198;">)</span> hfeng@ flasky <span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span>HEAD detached at 5d<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> $ sqlite3 data.sqlite
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter <span style="color: #2aa198;">".help"</span> for usage hints.
sqlite&gt; .tables
alembic_version
sqlite&gt; .quit
<span style="color: #2aa198;">(</span>2014flask<span style="color: #2aa198;">)</span> hfeng@ flasky <span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span>HEAD detached at 5d<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> $ python hello.py db upgrade
INFO  <span style="color: #2aa198;">[</span>alembic.migration<span style="color: #2aa198;">]</span> Context impl SQLiteImpl.
INFO  <span style="color: #2aa198;">[</span>alembic.migration<span style="color: #2aa198;">]</span> Will assume non-transactional DDL.
INFO  <span style="color: #2aa198;">[</span>alembic.migration<span style="color: #2aa198;">]</span> Running upgrade None -&gt; 3002e7cc92d6, initial migration
<span style="color: #2aa198;">(</span>2014flask<span style="color: #2aa198;">)</span> hfeng@ flasky <span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span>HEAD detached at 5d<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> $ sqlite3 data.sqlite
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter <span style="color: #2aa198;">".help"</span> for usage hints.
sqlite&gt; .tables
alembic_version  roles            users
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Chapter 6: Email</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">Email Support with Flask-Mail</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>大部分的application都会在一些event发生的时候,发送email给用户.Python有一个
standard library叫做smtplib,Flask如果希望使用在这个library的话,必须wrap一下,
于是就有了Flask-Mail这个extension
</li>
<li>这个extension的工作原理就是把邮件发送给某个SMTP(Simple Mail Transfer Protocol)
server,让这个server帮助把邮件发送出去,常见配置如下
<table border="2" cellspacing="0" cellpadding="6" rules="all" frame="border">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Key</th>
<th scope="col" class="left">Default</th>
<th scope="col" class="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">MAIL_HOSTNAME</td>
<td class="left">localhost</td>
<td class="left">Hostname or IP address of the email server</td>
</tr>

<tr>
<td class="left">MAIL_PORT</td>
<td class="left">25</td>
<td class="left">Port of the email server</td>
</tr>

<tr>
<td class="left">MAIL_USE_TLS</td>
<td class="left">False</td>
<td class="left">Enable Transport Layer Security(TLS) security</td>
</tr>

<tr>
<td class="left">MAIL_USE_SSL</td>
<td class="left">False</td>
<td class="left">Enable Secure Sockets Layer(SSL) security</td>
</tr>

<tr>
<td class="left">MAIL_USERNAME</td>
<td class="left">None</td>
<td class="left">Mail account username</td>
</tr>

<tr>
<td class="left">MAIL_PASSWORD</td>
<td class="left">None</td>
<td class="left">Mail account password</td>
</tr>
</tbody>
</table>
</li>
<li>一般来说,我们不使用localhost,而是使用其他的SMTP server,比如下面就是一个使用
google mail account的例子
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> os
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">...</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'MAIL_SERVER'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'smtp.googlemail.com'</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'MAIL_PORT'</span><span style="color: #2aa198;">]</span> = 587
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'MAIL_USE_TLS'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'MAIL_USERNAME'</span><span style="color: #2aa198;">]</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'MAIL_USERNAME'</span><span style="color: #2aa198;">)</span>
<span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'MAIL_PASSWORD'</span><span style="color: #2aa198;">]</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'MAIL_PASSWORD'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">Sending Email from the Python Shell</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>我们可以测试下我们的发送能否成功,代码就是上面的smtp.googlemail.com的代码,还
需要下面的代码设置下环境变量
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #2aa198;">(</span>venv<span style="color: #2aa198;">)</span> $ export <span style="color: #268bd2;">MAIL_USERNAME</span>=&lt;Gmail username&gt;
<span style="color: #2aa198;">(</span>venv<span style="color: #2aa198;">)</span> $ export <span style="color: #268bd2;">MAIL_PASSWORD</span>=&lt;Gmail password&gt;
</pre>
</div>
</li>
<li>然后就可以试验了
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; from flask_mail import Message
&gt;&gt;&gt; from hello import mail
&gt;&gt;&gt; msg = Message<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'test subject'</span>, <span style="color: #268bd2;">sender</span>=<span style="color: #2aa198;">'124363973@qq.com'</span>, <span style="color: #268bd2;">recipients</span>=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'124363973@qq.com'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
&gt;&gt;&gt; msg.body = <span style="color: #2aa198;">'text body'</span>
&gt;&gt;&gt; msg.html = <span style="color: #2aa198;">'&lt;b&gt; HTML&lt;/b&gt; body'</span>
&gt;&gt;&gt; with app.app_context<span style="color: #2aa198;">()</span>:
...     mail.send<span style="color: #2aa198;">(</span>msg<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3">Integrating Emails with the Application</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>我们可以使用如下的代码来把上面的试验转换为代码
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">send_email</span><span style="color: #2aa198;">(</span>to, subject, template, **kwargs<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg</span> = Message<span style="color: #2aa198;">(</span>app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'FLASKY_MAIL_SUBJECT_PREFIX'</span><span style="color: #b58900;">]</span> + <span style="color: #2aa198;">' '</span> + subject,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> sender=app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'FLASKY_MAIL_SENDER'</span><span style="color: #b58900;">]</span>, recipients=<span style="color: #b58900;">[</span>to<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg.body</span> = render_template<span style="color: #2aa198;">(</span>template + <span style="color: #2aa198;">'.txt'</span>, **kwargs<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg.html</span> = render_template<span style="color: #2aa198;">(</span>template + <span style="color: #2aa198;">'.html'</span>, **kwargs<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   mail.send<span style="color: #2aa198;">(</span>msg<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>创建用户的时候,如果是新用户,那么就发送邮件确认
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">form</span> = NameForm<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> form.validate_on_submit<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">user</span> = User.query.filter_by<span style="color: #2aa198;">(</span>username=form.name.data<span style="color: #2aa198;">)</span>.first<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> user <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">user</span> = User<span style="color: #2aa198;">(</span>username=form.name.data<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   db.session.add<span style="color: #2aa198;">(</span>user<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'known'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">False</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">if</span> app.config<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'FLASKY_ADMIN'</span><span style="color: #2aa198;">]</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   send_email<span style="color: #2aa198;">(</span>app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'FLASKY_ADMIN'</span><span style="color: #b58900;">]</span>, <span style="color: #2aa198;">'New User'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'mail/new_user'</span>, user=user<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'known'</span><span style="color: #2aa198;">]</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">]</span> = form.name.data
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'index.html'</span>, form=form, name=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'name'</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  known=session.get<span style="color: #b58900;">(</span><span style="color: #2aa198;">'known'</span>, <span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4">Sending Asynchronous Email</h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li>如果你注意观察的话,会发现我们试验的时候,如下语句就会block很久
<div class="org-src-container">

<pre class="src src-sh">&gt;&gt;&gt; with app.app_context<span style="color: #2aa198;">()</span>:
...     mail.send<span style="color: #2aa198;">(</span>msg<span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>我们如果在index()函数里面也调用这句话的话,就会导致整个页面的"无响应感",解决
的办法是使用另外的一个单独的thread去处理发送邮件的事宜,而主thread在设置完发
送邮件这个事情以后,就继续自己的逻辑
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> threading <span style="color: #859900; font-weight: bold;">import</span> Thread

<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">send_async_email</span><span style="color: #2aa198;">(</span>app, msg<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">with</span> app.app_context<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   mail.send<span style="color: #2aa198;">(</span>msg<span style="color: #2aa198;">)</span>

<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">send_email</span><span style="color: #2aa198;">(</span>to, subject, template, **kwargs<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg</span> = Message<span style="color: #2aa198;">(</span>app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'FLASK_MAIL_SUBJECT_PREFIX'</span><span style="color: #b58900;">]</span> + subject,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> sender=app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'FLASK_MAIL_SENDER'</span><span style="color: #b58900;">]</span>, recipients=<span style="color: #b58900;">[</span>to<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg.body</span> = render_template<span style="color: #2aa198;">(</span>template + <span style="color: #2aa198;">'.txt'</span>, **kwargs<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">msg.html</span> = render_template<span style="color: #2aa198;">(</span>template + <span style="color: #2aa198;">'.html'</span>, **kwargs<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">thr</span> = Thread<span style="color: #2aa198;">(</span>target=send_async_email, args=<span style="color: #b58900;">[</span>app, msg<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   thr.start<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> thr
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Chapter 7: Large Application Structure</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>工程大了以后,所有逻辑写到一个文件里面显然是不合适的,但是flask和其他的框架不
一样,它并没有要求你使用什么样的structure,下面的建议属于best practice
<div class="org-src-container">

<pre class="src src-sh">$ tree .
<span style="color: #657b83; font-weight: bold;">.</span>
|-- LICENSE
|-- README.md
|-- app
|   |-- __init__.py
|   |-- email.py
|   |-- main
|   |   |-- __init__.py
|   |   |-- errors.py
|   |   |-- forms.py
|   |   <span style="color: #6c71c4; font-weight: bold;">`-- views.py</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- models.py</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- static</span>
<span style="color: #6c71c4; font-weight: bold;">|   |   `</span>-- favicon.ico
|   <span style="color: #6c71c4; font-weight: bold;">`-- templates</span>
<span style="color: #6c71c4; font-weight: bold;">|       |-- 404.html</span>
<span style="color: #6c71c4; font-weight: bold;">|       |-- 500.html</span>
<span style="color: #6c71c4; font-weight: bold;">|       |-- base.html</span>
<span style="color: #6c71c4; font-weight: bold;">|       |-- index.html</span>
<span style="color: #6c71c4; font-weight: bold;">|       `</span>-- mail
|           |-- new_user.html
|           <span style="color: #6c71c4; font-weight: bold;">`-- new_user.txt</span>
<span style="color: #6c71c4; font-weight: bold;">|-- config.py</span>
<span style="color: #6c71c4; font-weight: bold;">|-- manage.py</span>
<span style="color: #6c71c4; font-weight: bold;">|-- migrations</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- README</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- alembic.ini</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- env.py</span>
<span style="color: #6c71c4; font-weight: bold;">|   |-- script.py.mako</span>
<span style="color: #6c71c4; font-weight: bold;">|   `</span>-- versions
|       <span style="color: #6c71c4; font-weight: bold;">`-- 38c4e85512a9_initial_migration.py</span>
<span style="color: #6c71c4; font-weight: bold;">|-- requirements.txt</span>
<span style="color: #6c71c4; font-weight: bold;">`</span>-- tests
    |-- __init__.py
    <span style="color: #6c71c4; font-weight: bold;">`-- test_basics.py</span>

<span style="color: #6c71c4; font-weight: bold;">8 directories, 26 files</span>
</pre>
</div>
</li>
<li>总体上来看有四个大的文件夹:
<ul class="org-ul">
<li>Flask application一般放在app文件夹里面
</li>
<li>migrations文件夹里面包含了database migration的文件
</li>
<li>tests文件夹里面包含测试用例
</li>
<li>venv(这里没有)包含了virtual environment的信息.
</li>
</ul>
</li>
<li>还有一些和四大文件夹并列的top层的文件:
<ul class="org-ul">
<li>requirements.txt: 包含了pip需要安装的信息
</li>
<li>config.py:包含了configuration信息
</li>
<li>manage.py包含了启动application task的信息.
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Configuration Options</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>app需要很多的设置,最常见的就是database设置,因为开发,测试,生产环境会有三套不
同的环境,前面我们在hello.py设置了configuration,这显然不是长久之计,在大的工
程里面,一般使用configration class来做变量配置,这个class的文件名叫做config.py
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> os
<span style="color: #268bd2;">basedir</span> = os.path.abspath<span style="color: #2aa198;">(</span>os.path.dirname<span style="color: #b58900;">(</span>__file__<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Config</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">SECRET_KEY</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'SECRET_KEY'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">or</span> <span style="color: #2aa198;">'hard to guess string'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">SQLALCHEMY_COMMIT_ON_TEARDOWN</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">MAIL_SERVER</span> = <span style="color: #2aa198;">'smtp.googlemail.com'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">MAIL_PORT</span> = 587
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">MAIL_USE_TLS</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">MAIL_USERNAME</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'MAIL_USERNAME'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">MAIL_PASSWORD</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'MAIL_PASSWORD'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">FLASKY_MAIL_SUBJECT_PREFIX</span> = <span style="color: #2aa198;">'[Flasky]'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">FLASKY_MAIL_SENDER</span> = <span style="color: #2aa198;">'Flasky Admin <a href="mailto:flasky%40example.com">&lt;flasky@example.com&gt;</a>'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">FLASKY_ADMIN</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'FLASKY_ADMIN'</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #b58900;">@staticmethod</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">init_app</span><span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">pass</span>
</pre>
</div>
</li>
<li>特别注意这个init_app,这个函数什么都没做,但是却引入了我们的flask app
</li>
<li>我们会看到这个Config class只有一个static的函数和一些"static"变量针对不同的
环境我们又有三个derived class:
<ul class="org-ul">
<li>Development:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">DevelopmentConfig</span><span style="color: #2aa198;">(</span>Config<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">DEBUG</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">SQLALCHEMY_DATABASE_URI</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'DEV_DATABASE_URL'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">or</span> \
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'sqlite:///'</span> + os.path.join<span style="color: #2aa198;">(</span>basedir, <span style="color: #2aa198;">'data-dev.sqlite'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>Testing:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">TestingConfig</span><span style="color: #2aa198;">(</span>Config<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">TESTING</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">SQLALCHEMY_DATABASE_URI</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'TEST_DATABASE_URL'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">or</span> \
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'sqlite:///'</span> + os.path.join<span style="color: #2aa198;">(</span>basedir, <span style="color: #2aa198;">'data-test.sqlite'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>Production:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ProductionConfig</span><span style="color: #2aa198;">(</span>Config<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">SQLALCHEMY_DATABASE_URI</span> = os.environ.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'DATABASE_URL'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">or</span> \
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'sqlite:///'</span> + os.path.join<span style="color: #2aa198;">(</span>basedir, <span style="color: #2aa198;">'data.sqlite'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
</ul>
</li>
<li>然后我们要设置一个全局变量(python的全局变量在其他object访问的时候,可能要用
到global关键字),这个全局变量是一个json里面设置了不同模式需要使用的Configure
Class
<div class="org-src-container">

<pre class="src src-python"><span style="color: #268bd2;">config</span> = <span style="color: #2aa198;">{</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'development'</span>: DevelopmentConfig,
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'testing'</span>: TestingConfig,
<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'production'</span>: ProductionConfig,

<span style="background-color: #eee8d5;"> </span>   <span style="color: #2aa198;">'default'</span>: DevelopmentConfig
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">Application Package</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>也就是我们说的app文件夹,这里面包含了:
<ul class="org-ul">
<li>application code
</li>
<li>template
</li>
<li>static file
</li>
<li>database model
</li>
<li>email
</li>
</ul>
</li>
<li>我们的app使用了python标准的package结构:
<ul class="org-ul">
<li>在directory里面加上__init__.py让代码意识到,这是一个package,可以被import.
</li>
<li>这个__init__.py里面可以是空,也可以有代码,这些代码都会在当前package被import
</li>
</ul>
</li>
<li>我们的__init__.py里面就可以有代码,这个代码是一个factory,所谓factory就是使用
一个函数(而不是使用ctor来创建instance),使用factory创建instance的好处在不同
的语言不同的环境里面都不同,这里的意义是能够让我们"动态"的(使用config json不
同的环境)生成不同的app instance. 不同的app instance在unit test的时候尤为重
要.
</li>
<li>Flask的app.config里面有个函数叫做from_object,说的就是从object里面引入配置参
数,所以我们的__init__.py代码可以如下写:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="color: #859900; font-weight: bold;">from</span> flask_bootstrap <span style="color: #859900; font-weight: bold;">import</span> Bootstrap
<span style="color: #859900; font-weight: bold;">from</span> flask_mail <span style="color: #859900; font-weight: bold;">import</span> Mail
<span style="color: #859900; font-weight: bold;">from</span> flask_moment <span style="color: #859900; font-weight: bold;">import</span> Moment
<span style="color: #859900; font-weight: bold;">from</span> flask_sqlalchemy <span style="color: #859900; font-weight: bold;">import</span> SQLAlchemy
<span style="color: #859900; font-weight: bold;">from</span> config <span style="color: #859900; font-weight: bold;">import</span> config

<span style="color: #268bd2;">bootstrap</span> = Bootstrap<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">mail</span> = Mail<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">moment</span> = Moment<span style="color: #2aa198;">()</span>
<span style="color: #268bd2;">db</span> = SQLAlchemy<span style="color: #2aa198;">()</span>


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">create_app</span><span style="color: #2aa198;">(</span>config_name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   app.config.from_object<span style="color: #2aa198;">(</span>config<span style="color: #b58900;">[</span>config_name<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   config<span style="color: #2aa198;">[</span>config_name<span style="color: #2aa198;">]</span>.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   bootstrap.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   mail.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   moment.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   db.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">from</span> .main <span style="color: #859900; font-weight: bold;">import</span> main <span style="color: #859900; font-weight: bold;">as</span> main_blueprint
<span style="background-color: #eee8d5;"> </span>   app.register_blueprint<span style="color: #2aa198;">(</span>main_blueprint<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> app
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">Implementing Application Functionality in a Blueprint</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>因为我们选择了使用factory函数来生成app,所以对于flask的route就会有很大的问题,
因为我们的route是调用的app的route函数形如@app.route("/"&#x2026;)
</li>
<li>正是因为route的过程需要app这个instance,而我们现在的app是在"运行态"生成的,所
以对运行态生成出来的app在设置其route就来不及了.我们需要新的技术,也就是blueprint
</li>
<li>我们可以把blueprint理解为是app的一个替身:因为我们可以对app进行设置其route,
我们也可以对blueprint设置其route.区别是我们的blueprint只有在被app注册了以后,
其设置的route才会有用.
<ul class="org-ul">
<li>我们选择在app/main/__init__.py里面设置Blueprint
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Blueprint

<span style="color: #268bd2;">main</span> = Blueprint<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'main'</span>, <span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>使用的时候,就和app.route一样
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> render_template
<span style="color: #859900; font-weight: bold;">from</span> . <span style="color: #859900; font-weight: bold;">import</span> main


<span style="color: #b58900;">@main.app_errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">page_not_found</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'404.html'</span><span style="color: #2aa198;">)</span>, 404
</pre>
</div>
</li>
<li>而app注册blueprint的代码如下
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">create_app</span><span style="color: #2aa198;">(</span>config_name<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   app.config.from_object<span style="color: #2aa198;">(</span>config<span style="color: #b58900;">[</span>config_name<span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   config<span style="color: #2aa198;">[</span>config_name<span style="color: #2aa198;">]</span>.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   bootstrap.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   mail.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   moment.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   db.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">from</span> .main <span style="color: #859900; font-weight: bold;">import</span> main <span style="color: #859900; font-weight: bold;">as</span> main_blueprint
<span style="background-color: #eee8d5;"> </span>   app.register_blueprint<span style="color: #2aa198;">(</span>main_blueprint<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> app
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4">Launch Script</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>学习django,我们在root目录下面也有一个manager.py,只不过这个文件是我们自己写
的,而不是生成的.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5">Requirements File</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>requirements.txt就是我们需要的lib文件
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6">Unit Tests</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li>tests文件夹下面就是测试文件了.
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

         <!-- Disqus Comment BEGIN -->
          <div id="disqus_thread"></div>
          <script type="text/javascript">
              var disqus_shortname = 'harrifeng';

              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

         <!-- Disqus Comment END -->
</div>
</body>
</html>
