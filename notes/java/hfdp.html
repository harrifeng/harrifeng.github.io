<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>hfdp</title>
<!-- 2017-05-02 Tue 10:49 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="your name" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>

         <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono|Galdeano|Open+Sans:600italic,400,600|Roboto+Condensed:400,700" rel="stylesheet" type="text/css">
         <link rel="stylesheet" type="text/css" href="/static/css/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="http://harrifeng.github.io/sitemap.html"> UP </a>
 |
 <a accesskey="H" href="http://harrifeng.github.io/index.html"> HOME </a>
</div><div id="preamble" class="status">

         <div id="header">
            <div id="header-top">
                <div id="blog-title">Harrifeng's Path</div>
                <div id="blog-sub-title">纸上得来终觉浅,绝知此事要Coding</div>
            </div>
            <div id="nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/about.html">About Me</a></li>
                    <li>
                    </li>
                </ul>
            </div>
         </div>
</div>
<div id="content">
<h1 class="title">hfdp</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Chapter 1: Intro to Design Patterns</a>
<ul>
<li><a href="#sec-1-1">It started with a simple SimUDuck app</a></li>
<li><a href="#sec-1-2">But now we need the ducks to FLY</a></li>
<li><a href="#sec-1-3">But Something went horribly wrong</a></li>
<li><a href="#sec-1-4">How about an interface</a></li>
<li><a href="#sec-1-5">Zeroing in on the problem&#x2026;</a></li>
<li><a href="#sec-1-6">Separating what changes from what stays the same</a></li>
<li><a href="#sec-1-7">Designing the Duck Behaviors</a></li>
<li><a href="#sec-1-8">Implementing the Duck Behavior</a></li>
<li><a href="#sec-1-9">Integrating the Duck Behavior</a></li>
<li><a href="#sec-1-10">Testing the Duck code</a></li>
<li><a href="#sec-1-11">Setting behavior dynamically</a></li>
<li><a href="#sec-1-12">The Big Picture on encapsulated behaviors</a></li>
<li><a href="#sec-1-13">HAS-A can be better than IS-A</a></li>
</ul>
</li>
<li><a href="#sec-2">Chapter 2: The Observer Pattern : Keep your objects in the know</a>
<ul>
<li><a href="#sec-2-1">The Weather Monitoring application overriew</a></li>
<li><a href="#sec-2-2">Unpacking the WeatherData class</a></li>
<li><a href="#sec-2-3">Taking a first, misguided SWAG at the Weather Station</a></li>
<li><a href="#sec-2-4">What's wrong with our implementation?</a></li>
<li><a href="#sec-2-5">The Observer Pattern defined</a></li>
<li><a href="#sec-2-6">The power of Losse Coupling</a></li>
<li><a href="#sec-2-7">Designing the Weather Station</a></li>
<li><a href="#sec-2-8">Using Java's build-in Observer Pattern</a></li>
<li><a href="#sec-2-9">The dark side of java.util.Observeable</a></li>
</ul>
</li>
<li><a href="#sec-3">Chapter 3: the Decorator Pattern Decorating Objects</a>
<ul>
<li><a href="#sec-3-1">Welcome to Starbuzz Coffee</a></li>
<li><a href="#sec-3-2">The Open-Closed Principle</a></li>
<li><a href="#sec-3-3">Meet the Decorator Pattern</a></li>
<li><a href="#sec-3-4">Coding Beverage</a></li>
</ul>
</li>
<li><a href="#sec-4">Chapter 4: the Factory Pattern: Baking with OO Goodness</a>
<ul>
<li><a href="#sec-4-1">Thinking about "new"</a></li>
<li><a href="#sec-4-2">What's wrong with "new"?</a></li>
<li><a href="#sec-4-3">Identifying the aspects that vary</a></li>
<li><a href="#sec-4-4">Building a simple pizza factory</a></li>
<li><a href="#sec-4-5">Reworking the PizzaStore class</a></li>
<li><a href="#sec-4-6">The Simple Factory defined</a></li>
<li><a href="#sec-4-7">Franchising the pizza store</a></li>
<li><a href="#sec-4-8">We've seen one approach&#x2026;</a></li>
<li><a href="#sec-4-9">But you'd like a little more quality control</a></li>
<li><a href="#sec-4-10">A framework for the pizza store</a></li>
<li><a href="#sec-4-11">Declaring a factory method</a></li>
<li><a href="#sec-4-12">We're just missing one thing: PIZZA!</a></li>
<li><a href="#sec-4-13">It's finally time to meet the Factory Method Pattern</a></li>
<li><a href="#sec-4-14">Factory Method Pattern defined</a></li>
<li><a href="#sec-4-15">A very dependent PizzaStore</a></li>
<li><a href="#sec-4-16">The Dependency Inversion Principle</a></li>
<li><a href="#sec-4-17">Applying the Principle</a></li>
<li><a href="#sec-4-18">A few guidelines to help you follow the Pinciple&#x2026;</a></li>
<li><a href="#sec-4-19">Ensuring consistency in your ingredients</a></li>
<li><a href="#sec-4-20">Building the ingredient factories</a></li>
<li><a href="#sec-4-21">Building the New York ingredient factory</a></li>
<li><a href="#sec-4-22">Reworking the pizzas</a></li>
<li><a href="#sec-4-23">Revisiting our pizza stores</a></li>
<li><a href="#sec-4-24">What have we done?</a></li>
<li><a href="#sec-4-25">Abstract Factory Pattern defined</a></li>
</ul>
</li>
<li><a href="#sec-5">Chapter 5: the Singleton Pattern: One of a Kind Objects</a>
<ul>
<li><a href="#sec-5-1">Dissecting the classic Singleton Pattern implementation</a></li>
<li><a href="#sec-5-2">The Chocolate Factory</a></li>
<li><a href="#sec-5-3">Singleton Pattern defined</a></li>
<li><a href="#sec-5-4">Threads are a problem</a></li>
<li><a href="#sec-5-5">Can we improve multithreading?</a></li>
</ul>
</li>
<li><a href="#sec-6">Chapter 6: the Command Pattern: Encapsulating Invocation</a>
<ul>
<li><a href="#sec-6-1">Remote Control</a></li>
<li><a href="#sec-6-2">The Command Pattern defined</a></li>
<li><a href="#sec-6-3">Time to QA that Undo button!</a></li>
</ul>
</li>
<li><a href="#sec-7">Chapter 7: the Adapter and Facade Patterns: Being Adaptive</a>
<ul>
<li><a href="#sec-7-1">Adapters all around us</a></li>
<li><a href="#sec-7-2">Object oriented adapters</a></li>
<li><a href="#sec-7-3">Adapter Example</a></li>
<li><a href="#sec-7-4">Adapter Pattern defined</a></li>
<li><a href="#sec-7-5">Real world adapters</a></li>
<li><a href="#sec-7-6">There is another pattern in this chapter: Facade</a></li>
<li><a href="#sec-7-7">Construting your home therater facade</a></li>
<li><a href="#sec-7-8">Facade Pattern defined</a></li>
<li><a href="#sec-7-9">The Principle of Least Knowledge</a></li>
</ul>
</li>
<li><a href="#sec-8">Chapter 8: the Template Method Pattern: Encapsulating Algorithms</a>
<ul>
<li><a href="#sec-8-1">It's time for some more cafeine</a></li>
<li><a href="#sec-8-2">Whipping up some coffee and tea classes</a></li>
<li><a href="#sec-8-3">Sir, may I abstract your Coffee, Tea?</a></li>
<li><a href="#sec-8-4">Taking the design further..</a></li>
<li><a href="#sec-8-5">The implementation code</a></li>
<li><a href="#sec-8-6">Meet the Template Method</a></li>
<li><a href="#sec-8-7">Template Method Pattern defined</a></li>
<li><a href="#sec-8-8">Hooked on Template Method</a></li>
<li><a href="#sec-8-9">The Holywood Principls</a></li>
<li><a href="#sec-8-10">Template Methods in the JDK</a></li>
</ul>
</li>
<li><a href="#sec-9">Chapter 9: the Iterator and Composite Patterns: Well-Managed Collections</a>
<ul>
<li><a href="#sec-9-1">Two resturants merge</a></li>
<li><a href="#sec-9-2">Use java's Iterator</a></li>
<li><a href="#sec-9-3">Iterator Pattern defined</a></li>
<li><a href="#sec-9-4">Single Responsibility</a></li>
<li><a href="#sec-9-5">Iterators and Collections</a></li>
<li><a href="#sec-9-6">New problem raised</a></li>
<li><a href="#sec-9-7">The Composite Pattern defined</a></li>
<li><a href="#sec-9-8">Designing Menus with Composite</a></li>
<li><a href="#sec-9-9">Flashback to Iterator</a></li>
</ul>
</li>
<li><a href="#sec-10">Chapter 10: the State Pattern: The State of Things</a>
<ul>
<li><a href="#sec-10-1">The messy State of things</a></li>
<li><a href="#sec-10-2">The new design</a></li>
<li><a href="#sec-10-3">Implementing our state class</a></li>
<li><a href="#sec-10-4">The State Pattern defined</a></li>
</ul>
</li>
<li><a href="#sec-11">Chapter 11: the Proxy Pattern: Controlling Object Access</a>
<ul>
<li><a href="#sec-11-1">New requirement</a></li>
<li><a href="#sec-11-2">Misunderstanding</a></li>
<li><a href="#sec-11-3">The Proxy Pattern defined</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Chapter 1: Intro to Design Patterns</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">It started with a simple SimUDuck app</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Joe公司的要设计一款有很多种类型鸭子的游戏.所以很自然的,他们首先创建了一个superclass
SimUDuck

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/duck-super.png" alt="duck-super.png" />
</p>
<p><span class="figure-number">Figure 1:</span> duck-super.png</p>
</div>
</li>
<li>从上例我们可以看到:
<ul class="org-ul">
<li>Duck是superclass
</li>
<li>在其内部就实现了quack()和swim()
</li>
<li>而把display()设计成abstract的, 因为所有的子类型display出来都是不同的.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">But now we need the ducks to FLY</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>后来公司面对激烈的市场竞争,决定增加自己游戏里面鸭子的"能力",原来只会游泳和叫
现在我们要这个鸭子会飞!
</li>
<li>最简单的实现方法就是在superclass里面加上一个fly() 函数,这下多有的subclass就
都会飞啦!

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/duck-add-fly.png" alt="duck-add-fly.png" />
</p>
<p><span class="figure-number">Figure 2:</span> duck-ad-fly.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">But Something went horribly wrong</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>增加了一个fly函数以后,看似让所有的鸭子都增加了新功能,但同时也带来了设计的错
误,因为不是所有的鸭子都会飞,比如"橡胶鸭子"就不会飞
</li>
<li>一个可行的方案是把rubber duck的fly method override.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">RubberDuck</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">....</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span> <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Override to do nothing}</span>
<span style="color: #b58900;">}</span>
</pre>
</div>
</li>
<li>但是override终究只是"权宜之计",一旦我们加入一个新的"木头鸭子", 它既不能"飞"
也不能"叫",我们总不能把fly和quack都override了吧.所以明显的,问题是出在了我们
的设计上
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">How about an interface</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Joe的解决办法是把某些"行为"(比如fly或者quack)从superclass里面独立出来,放到
某些接口里面,如果这个鸭子拥有这个"行为"的能力,那么就去implements这个接口

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/duck-interface.png" alt="duck-interface.png" />
</p>
<p><span class="figure-number">Figure 3:</span> duck-interface.png</p>
</div>
</li>
<li>这种解决方法, 虽然解决了一部分问题,但是依然不好, 因为它
<pre class="example">
       破坏了"code reuse": 因为java的interface里面的函数都没有实现代
       码,我们要为每个行为在每个subclass里面实现一遍.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">Zeroing in on the problem&#x2026;</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>既然继承和interface都不好使,我们就要使用新的方法来处理这个问题了.新的方法就
是我们要介绍的Design Pattern
</li>
<li>Design Pattern一般都是长相相似的某些代码,其核心又是遵循了某些Design Principle
比如,要解决我们的duck问题,我们就要遵循下面的一个Design Principle
<pre class="example">
Identify the aspects of your application that vary and
spearate them from what statys the same
</pre>
</li>
<li>把"变动"的和"不变"吧部分分开.这个principle虽然简单,但是却基本上为所有的design
pattern所用.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">Separating what changes from what stays the same</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>既然制定了大方向,那么我们就依次开始重构我们的代码:
<ul class="org-ul">
<li>变动的部分: fly, quack这些函数肯定是"变动的部分",要把他们从superclass拿出来
</li>
<li>不变的部分: display, swim不改变,还留在superclass
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">Designing the Duck Behaviors</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>好了,我们先开始实现"变动的部分"也就是behavior: 把fly, quack从superclass拿出
来这个行动,和前面的interface解法相似. 所以仅仅把这个两个行为抽象成interface
然后让subclass继承这条路是行不通的.
</li>
<li>我们要让另外的一些class去继承这些接口, 而!不!是!让subclass去继承.
</li>
<li>我们的subclass再去包含这些class的supertype就可以了. 所谓supertype,其实就是
实现这些类的interface! 我们还可以在运行时动态的改变这些class, 因为保存的是
superctype(interface), 所以所有implements这个interface的class我们都可以包含
</li>
<li>而原来的做法是:
<ul class="org-ul">
<li>要么从superclass获取实现(implementation)
</li>
<li>要么自己实现(implement)一个函数体
</li>
</ul>
</li>
<li>用包含interface的办法来替代"获取implementation"的办法就是另外一个Design principle
<pre class="example">
Program to an interface, not an implementation
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">Implementing the Duck Behavior</h3>
<div class="outline-text-3" id="text-1-8">
<ul class="org-ul">
<li>下面就是那些implements接口的class们

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/duck-behavior.png" alt="duck-behavior.png" />
</p>
<p><span class="figure-number">Figure 4:</span> duck-behavior.png</p>
</div>
</li>
<li>这些class由于不再受duck的控制,你甚至可以被Bird或者是Animal来"包含"这些behavior
class
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">Integrating the Duck Behavior</h3>
<div class="outline-text-3" id="text-1-9">
<ul class="org-ul">
<li>我们的做法不再是把fly, quack等行为放到superclass里面实现,或者放到subclass里
面实现,而是在上面的class里面实现好了.现在我们来"包含"它们.包含的办法就是:创
建两个变量分别指向我们需要的行为. 后面我们会看到,这种"包含"在java里面叫做组
合(composition)
</li>
<li>我们的相应的fly或者quack行为需要重新设计函数,在其内部调用刚才的变量来实现真
正的动作,下面以quack为例(fly也一样)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">QuackBehavior</span> <span style="color: #268bd2;">quackBehavior</span>;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">more</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">performQuack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        quackBehavior.quack<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>下面我们要看看这两个instance variable是如何在subclass中被实例化的
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MallardDuck</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">MallardDuck</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        quackBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Quack</span><span style="color: #268bd2;">()</span>;
        flyBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FlyWithWings</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">Testing the Duck code</h3>
<div class="outline-text-3" id="text-1-10">
<ul class="org-ul">
<li>首先是Duck class的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">FlyBehavior</span> <span style="color: #268bd2;">flyBehavior</span>;
    <span style="color: #b58900;">QuackBehavior</span> <span style="color: #268bd2;">quackBehavior</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Duck</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">performFly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        flyBehavior.fly<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">performQuack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        quackBehavior.quack<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>其次是fly behavior的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">FlyBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">FlyNoWay</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">FlyBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Fly No Way!"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">FlyWithWings</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">FlyBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Fly with Wings"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>quack behavior的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">QuackBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Quack</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">QuackBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Quack normally"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Squeak</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">QuackBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Squeak"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MuteQuack</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">QuackBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Mute Quack"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>某一种鸭子MallardDuck的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MallardDuck</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">MallardDuck</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        flyBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FlyWithWings</span><span style="color: #268bd2;">()</span>;
        quackBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Quack</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"This is a MallardDuck"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MiniDuckSimulator</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">mallard</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MallardDuck</span><span style="color: #268bd2;">()</span>;
        mallard.performFly<span style="color: #268bd2;">()</span>;
        mallard.performQuack<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Fly with Wings                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Quack normally                                 //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">Setting behavior dynamically</h3>
<div class="outline-text-3" id="text-1-11">
<ul class="org-ul">
<li>我们还可以在duck中增加函数setter,从而可以做到在run time更改鸭子的行为(其实
也就是让两个变量ref到其他对象)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setFlyBehavior</span><span style="color: #b58900;">(</span><span style="color: #b58900;">FlyBehavior</span> <span style="color: #268bd2;">fb</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        flyBehavior = fb;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setQuackBehavior</span><span style="color: #b58900;">(</span><span style="color: #b58900;">QuackBehavior</span> <span style="color: #268bd2;">qb</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        quackBehavior = qb;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>新建一个默认不能fly的duck
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ModelDuck</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Duck</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ModelDuck</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        flyBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FlyNoWay</span><span style="color: #268bd2;">()</span>;
        quackBehavior = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Quack</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"I'm a model duck"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>增加一种依靠"火箭"飞行的方法
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">FlyRocketPowered</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">FlyBehavior</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"I'm flying with a rocket!"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试runtime更改行为
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch1.<span style="color: #268bd2; font-weight: bold;">strategy</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ModelDuckSimulator</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">model</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ModelDuck</span><span style="color: #268bd2;">()</span>;
        model.performFly<span style="color: #268bd2;">()</span>;
        model.setFlyBehavior<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FlyRocketPowered</span><span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        model.performFly<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I can't fly!                                   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying with a rocket!                      //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">The Big Picture on encapsulated behaviors</h3>
<div class="outline-text-3" id="text-1-12">
<ul class="org-ul">
<li>好了,我们从从下图就可以看到整个的类图全貌.

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/duck-summary.png" alt="duck-summary.png" />
</p>
<p><span class="figure-number">Figure 5:</span> duck-summary.png</p>
</div>
</li>
<li>这是我们第一个design pattern叫做strategy pattern, 定义如下, 用处不大
<pre class="example">
The Strategy Pattern defines a family of algorithms, encapsulates
each one, and makes them interchangeable. Strategy lets the
algorithm vary independently from clients that use it.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">HAS-A can be better than IS-A</h3>
<div class="outline-text-3" id="text-1-13">
<ul class="org-ul">
<li>所谓HAS-A的关系,就是我们这里说的每个duck都has a "Fly Behavior" and a "Quack
Behavior". 也就是我们说的组合(composition)关系
</li>
<li>关于composition,我们也有一个design principle
<pre class="example">
Favor composition over inheritance
</pre>
</li>
<li>实际的情况也是composition拥有比inheritance更多的优点.主要表现在:
<ul class="org-ul">
<li>包装一系列的其他类的算法, 却没有继承负担
</li>
<li>可以在runtime更改行为
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Chapter 2: The Observer Pattern : Keep your objects in the know</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">The Weather Monitoring application overriew</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>现在我们手头有一个项目, 需要从Weather Station读取数据,然后将数据显示出来.这
个项目有三个主体:
<ul class="org-ul">
<li>Weather Station: 是物理设备,读取三个参数湿度,温度,气压
</li>
<li>WeatherData Object: 能够从Weather Station读取数据并且传递给Display device
</li>
<li>Display Device: 能够从WeatherData Object那里得到数据并显示.
</li>
</ul>
</li>
<li>Weather Station喝Display Device等硬件的部分,我们不需要操心,我们只需要设计并
实现好软件部分也就是WeatherData Object就好
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Unpacking the WeatherData class</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>WeatherData的类图如下
<pre class="example">
+---------------------+
|   WeatherData       |
+---------------------+
|getTemperature()     |
|getHumidity()        |
|getPressure()        |
|measurementsChanged()|
|//...                |
+---------------------+
</pre>
</li>
<li>getter函数主要的功能是从Weather Station读取最新的测量数据, 其内部如何实现我
们不必关心
</li>
<li>我们需要关心的是函数measurementsChanged(), 这个函数是我们和Weather Station交
互的函数,每当Weather Station发现了自己测量的数据有变动的时候,就会调用WeatherData
Object的measurementsChanged()函数. 所以这个函数是要我们来实现的.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Taking a first, misguided SWAG at the Weather Station</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>我们来看一个最朴素的WeatherData Object的实现方法
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WeatherData</span><span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">instance variable declarations</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">measurementsChanged</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">float</span> <span style="color: #268bd2;">temp</span> = getTemperature<span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span> = getHumidity<span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">float</span> <span style="color: #268bd2;">presure</span> = getPressure<span style="color: #268bd2;">()</span>;

        <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">Three devices get the update</span>
        currentConditionDisplay.update<span style="color: #268bd2;">(</span>temp,humidity, pressure<span style="color: #268bd2;">)</span>;
        statisticsDisplay.update<span style="color: #268bd2;">(</span>temp,humidity, pressure<span style="color: #268bd2;">)</span>;
        forecastDisplay.update<span style="color: #268bd2;">(</span>temp,humidity, pressure<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">What's wrong with our implementation?</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>上面的实现,问题一大堆:
<ul class="org-ul">
<li>我们update Device的方法是,把每个具体的实现(implementation)都放入了函数内
部, 这违反了design principle(Program to an interface, not an implementation)
从而导致无法再runtime 增加或删除display设备
</li>
<li>既然display设备是有可能"改变的部分",我们要独立出来实现
</li>
<li>三个display对象的update函数参数都一样,我们最少要让他们实现同一个接口.
</li>
</ul>
</li>
<li>更改的方法就是Observer Pattern
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">The Observer Pattern defined</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>Observer Pattern定义
<pre class="example">
The Observer Pattern defines a one-to-many dependency between
objects so that when one object changes state, all of its
dependents are notified and updated automatically.
</pre>
</li>
<li>我们习惯上把更改的那个object叫做subject(话题), 而被通知的所有订阅这个subject
的object叫做observer(观察者), 这也是名字的来历
</li>
<li>下面是observer pattern的类图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/observer.png" alt="observer.png" />
</p>
<p><span class="figure-number">Figure 6:</span> observer.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">The power of Losse Coupling</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Observer Pattern的设计也同时遵从了一个Design Principle
<pre class="example">
Strive for loosely coupled designs between objects that interact
</pre>
</li>
<li>subject和observer之间的联系就很少, subject对observer唯一的了解就是observer肯
定会implements一个接口,从而能够"肯定实现一个函数"
</li>
<li>这样一来,observer改动的自由度就很大,比如上例中一种完全崭新的display的方法,
只需要继承一个接口,那么subject也会快乐接受
</li>
<li>由于observer遵从了某一种接口,那么我们subject可以在runtime随意增加删除observer
</li>
<li>只要保证这个"松耦合"不变,我们更改两个类内部的什么其他部分都不会影响工作. 所
以"松耦合"是非常好的一种设计哲学.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">Designing the Weather Station</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>整个系统的设计类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/weather-data.png" alt="weather-data.png" />
</p>
<p><span class="figure-number">Figure 7:</span> weather-data.png</p>
</div>
</li>
<li>好的,我们来看看代码实现.有些细节还是代码里面才能体现
<ul class="org-ul">
<li>首先看Subject interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Subject</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">registerObserver</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observer</span> <span style="color: #268bd2;">o</span><span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">removeObserver</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observer</span> <span style="color: #268bd2;">o</span><span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">notifyObservers</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>WeatherData实现了这个接口.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">ArrayList</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WeatherData</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Subject</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">Observer</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">observers</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">WeatherData</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        observers = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">Observer</span><span style="color: #268bd2;">&gt;()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">registerObserver</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observer</span> <span style="color: #268bd2;">o</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        observers.add<span style="color: #268bd2;">(</span>o<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">removeObserver</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observer</span> <span style="color: #268bd2;">o</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = observers.indexOf<span style="color: #268bd2;">(</span>o<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>i &gt;= 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            observers.remove<span style="color: #6c71c4;">(</span>i<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">notifyObservers</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; observers.<span style="color: #b58900;">size</span><span style="color: #6c71c4;">()</span>; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">Observer</span> <span style="color: #268bd2;">observer</span> = observers.get<span style="color: #6c71c4;">(</span>i<span style="color: #6c71c4;">)</span>;
            observer.update<span style="color: #6c71c4;">(</span>temperature, humidity, pressure<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">&#27492;&#20989;&#25968;&#19968;&#33324;&#26159;WeatherStation&#35843;&#29992;,&#22312;&#26356;&#26032;&#30340;&#24773;&#20917;&#19979;,&#36890;&#30693;&#25152;&#26377;&#30340;observer</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">measurementsChanged</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        notifyObservers<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setMeasurements</span><span style="color: #b58900;">(</span><span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.temperature = temperature;
        <span style="color: #859900; font-weight: bold;">this</span>.humidity = humidity;
        <span style="color: #859900; font-weight: bold;">this</span>.pressure = pressure;
        measurementsChanged<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Observer interface的代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Observer</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">update</span><span style="color: #b58900;">(</span><span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span><span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>DisplayElement interface的代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">DisplayElement</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>任意一个display都可以如下的实现上面两个接口, 我们以其中一个display为例,其
他display都类似
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CurrentConditionDisplay</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Observer</span>, <span style="color: #b58900;">DisplayElement</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperate</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>;
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&#21253;&#21547;&#20102;&#19968;&#20010;&#25351;&#21521;ConcreteSubject&#30340;ref, &#36825;&#26679;&#21487;&#20197;&#22312;ctor&#30340;&#26102;&#20505;&#27880;&#20876;&#36827;&#21435;.</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&#24403;&#28982;&#20063;&#21487;&#20197;&#26126;&#30830;&#30340;&#22312;"&#22806;&#37096;"&#27880;&#20876;."&#20869;&#37096;"&#27880;&#20876;&#21453;&#32780;&#26356;&#19981;&#23481;&#26131;&#38169;</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Subject</span> <span style="color: #268bd2;">weatherData</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">CurrentConditionDisplay</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Subject</span> <span style="color: #268bd2;">weatherData</span><span style="color: #b58900;">){</span>
        <span style="color: #859900; font-weight: bold;">this</span>.weatherData = weatherData;
        weatherData.registerObserver<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">update</span><span style="color: #b58900;">(</span><span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.temperate = temperature;
        <span style="color: #859900; font-weight: bold;">this</span>.humidity = humidity;
        display<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Current condition: "</span> + temperate
                           + <span style="color: #2aa198;">"F degree and "</span> + humidity + <span style="color: #2aa198;">"% humidity"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>好,我们最后来写个main例子来测试我们的display
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">plain</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WeatherStation</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">WeatherData</span> <span style="color: #268bd2;">weatherData</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">WeatherData</span><span style="color: #268bd2;">()</span>;

        <span style="color: #b58900;">CurrentConditionsDisplay</span> <span style="color: #268bd2;">currentConditionsDisplay</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CurrentConditionsDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">StatisticsDisplay</span> <span style="color: #268bd2;">statisticsDisplay</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">StatisticsDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">ForecastDisplay</span> <span style="color: #268bd2;">forecastDisplay</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ForecastDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;
        weatherData.setMeasurements<span style="color: #268bd2;">(</span>80, 65, 30.4f<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">()</span>;
        weatherData.setMeasurements<span style="color: #268bd2;">(</span>82, 70, 29.2f<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current condition: 80.0F degree and 65.0% humidity //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Avg/Max/Min temperate = 80.0/80.0/80.0             //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Forecast: Improving weather on the day             //</span>
<span style="color: #93a1a1;">//                                                    </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current condition: 82.0F degree and 70.0% humidity //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Avg/Max/Min temperate = 81.0/82.0/80.0             //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Forecast: Watch out for cooler, rainy weather      //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8">Using Java's build-in Observer Pattern</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>由于observer模式是如此广泛的存在.java为其设计了内置的支持:
<ul class="org-ul">
<li>观察者这边是interface Observer:
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">observable</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Observable</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Observer</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CurrentConditionsDisplay</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Observer</span>, <span style="color: #b58900;">DisplayElement</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Observable</span> <span style="color: #268bd2;">observable</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">CurrentConditionsDisplay</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observable</span> <span style="color: #268bd2;">observable</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.observable = observable;
        observable.addObserver<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">update</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Observable</span> <span style="color: #268bd2;">obs</span>, <span style="color: #b58900;">Object</span> <span style="color: #268bd2;">arg</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>obs <span style="color: #859900; font-weight: bold;">instanceof</span> WeatherData<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">WeatherData</span> <span style="color: #268bd2;">weatherData</span> = <span style="color: #6c71c4;">(</span><span style="color: #b58900;">WeatherData</span><span style="color: #6c71c4;">)</span>obs;
            <span style="color: #859900; font-weight: bold;">this</span>.temperature = weatherData.getTemperature<span style="color: #6c71c4;">()</span>;
            <span style="color: #859900; font-weight: bold;">this</span>.humidity = weatherData.getTemperature<span style="color: #6c71c4;">()</span>;
            display<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Current conditions: "</span> + temperature + <span style="color: #2aa198;">"F degrees and "</span>
                + humidity + <span style="color: #2aa198;">"% humidity"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>订阅者这边是class Observable:
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">observable</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Observable</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WeatherData</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Observable</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">getTemperature</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> temperature;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">getHumidity</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> humidity;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">getPressure</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> pressure;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">WeatherData</span><span style="color: #b58900;">(){</span> <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">measurementsChanged</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        setChanged<span style="color: #268bd2;">()</span>;
        notifyObservers<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setMeasurements</span><span style="color: #b58900;">(</span><span style="color: #b58900;">float</span> <span style="color: #268bd2;">temperature</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">humidity</span>, <span style="color: #b58900;">float</span> <span style="color: #268bd2;">pressure</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.temperature = temperature;
        <span style="color: #859900; font-weight: bold;">this</span>.humidity = humidity;
        <span style="color: #859900; font-weight: bold;">this</span>.pressure = pressure;
        measurementsChanged<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>用户使用
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch2.observer.<span style="color: #268bd2; font-weight: bold;">observable</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WeatherStation</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">WeatherData</span> <span style="color: #268bd2;">weatherData</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">WeatherData</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">CurrentConditionsDisplay</span> <span style="color: #268bd2;">currentConditionDisplay</span> =
            <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CurrentConditionsDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">StatisticsDisplay</span> <span style="color: #268bd2;">statisticsDisplay</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">StatisticsDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">ForecastDisplay</span> <span style="color: #268bd2;">forecastDisplay</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ForecastDisplay</span><span style="color: #268bd2;">(</span>weatherData<span style="color: #268bd2;">)</span>;

        weatherData.setMeasurements<span style="color: #268bd2;">(</span>82, 70, 29.2f<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">()</span>;
        weatherData.setMeasurements<span style="color: #268bd2;">(</span>82, 70, 29.2f<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">//////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Forecast: Watch out for cooler, rainy weather        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Avg/Max/Min temperate = 82.0/82.0/82.0               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current conditions: 82.0F degrees and 82.0% humidity //</span>
<span style="color: #93a1a1;">//                                                      </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Forecast: More of the same                           //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Avg/Max/Min temperate = 82.0/82.0/82.0               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current conditions: 82.0F degrees and 82.0% humidity //</span>
<span style="color: #93a1a1;">//////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
<li>上面的Observable的使用有些门道:
<ul class="org-ul">
<li>你必须首先设置内部的state为changed,然后才能进行notify
</li>
<li>measurementsChanged()按说是被调用者使用的,这里被setMeasurements包含,然后
被用户调用
</li>
<li>IMPORTANT! 这次display的顺序和上次不同! 上次是按照我们注册的顺序C-&gt;A-&gt;F,
而这次顺序却反过来了!F-&gt;A-C, 这是因为java实现时候的notify顺序和我们的不同
所以
<pre class="example">
Never depend on order of evaluation of the Observer notifications
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9">The dark side of java.util.Observeable</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>java的observable设计的不太好,限制了它发挥自己的功能:
<ul class="org-ul">
<li>Observable is a class:
<ol class="org-ol">
<li>这没有必要,因为我们必须继承Observerable, 而我们如果已经有一套成熟代码
的情况下想"获取Observable这种能力",那么我们implement接口就好了(脑补
Runnable), 但是设计成class就没办法了
</li>
<li>你甚至不能提供自己的observable实现,比如多线程安全版本的
</li>
</ol>
</li>
<li>Observable 的关键函数的protected的:
如果你看了代码你会发现Observable最关键的函数setChanged()是protected,这就
说明你必须得subclass才能调用,连composition这条路都堵上了.
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Chapter 3: the Decorator Pattern Decorating Objects</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Welcome to Starbuzz Coffee</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Starbuzz咖啡是一个非常出名的品牌，他们店内有非常多的饮料，具体类图如下Beverage
是一个abstract class

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/first-beverage.png" alt="first-beverage.png" />
</p>
<p><span class="figure-number">Figure 8:</span> first-beverage.png</p>
</div>
</li>
<li>但是你想到了没有,如果在原有的饮料基础上,新加一些调料的话,会不停的增加新的类,
然后就会出现所谓的"class explosion"(很多没必要的类都会出现):

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/explosion-beverage.png" alt="explosion-beverage.png" />
</p>
<p><span class="figure-number">Figure 9:</span> explosion-beverage.png</p>
</div>
</li>
<li>如果不想出现"class explosion",我们也在abstract class里面设置一些instance
variable, 然后其他class继承了这个superclass就有这些"变化"了

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/instance-beverage.png" alt="instance-beverage.png" />
</p>
<p><span class="figure-number">Figure 10:</span> instance-beverage.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">The Open-Closed Principle</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>上面这种做法看似正确,其实也是有问题,因为它违反了如下的design principle
<pre class="example">
Classes should be open for extension, but closed for modification.
</pre>
</li>
<li>其实说白了,我们的目标很简单,就是能够更快的把功能加入到已有的代码,而不破坏已
有代码
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Meet the Decorator Pattern</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>Decorator pattern的类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/decorate-component.png" alt="decorate-component.png" />
</p>
<p><span class="figure-number">Figure 11:</span> decorate-component.png</p>
</div>
</li>
<li>什么是decorator pattern呢?就是说:
<ul class="org-ul">
<li>我们有个基本的咖啡DarkRoast
</li>
<li>第一步"装饰": Mocha
</li>
<li>第二步"装饰": Whip
</li>
<li>这样一来调用cost()的时候,就可以根据装饰的过程来计算最后的价格
</li>
</ul>
</li>
<li>这个过程听起来是有些难以理解,看看类图:

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/decorate-beverage.png" alt="decorate-beverage.png" />
</p>
<p><span class="figure-number">Figure 12:</span> decorate-beverage.png</p>
</div>
</li>
<li>类图理解如下
<ul class="org-ul">
<li>Beverage就是component
</li>
<li>Espresso等咖啡就是具体的component(ConcreteComponent)
</li>
<li>Milk, Soy等"作料"也想成为和Espresso等一样的Concretecomponent,无奈自己能力
有限,所以要依靠decorator
</li>
<li>CondimentDecorator(作料decorator), 把自己装扮成"ConcreteComponent"
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">Coding Beverage</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>再来看看代码:
<ul class="org-ul">
<li>Beverage就是一个abstract class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch3.<span style="color: #268bd2; font-weight: bold;">starbuzz</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Beverage</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span> = <span style="color: #2aa198;">"Unknown Beverage"</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> description;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">double</span> <span style="color: #268bd2;">cost</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Espresso是具体的咖啡,是咖啡店的主力
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch3.<span style="color: #268bd2; font-weight: bold;">starbuzz</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Espresso</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Beverage</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Espresso</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        description = <span style="color: #2aa198;">"Espresso"</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">double</span> <span style="color: #268bd2;">cost</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> 1.99;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>CondimentDecorator,目的是:让"作料"也有主力咖啡样子的
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch3.<span style="color: #268bd2; font-weight: bold;">starbuzz</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CondimentDecorator</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Beverage</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Milk是"作料",它继承了CodimentDecorator,从此有了主力咖啡的能力
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch3.<span style="color: #268bd2; font-weight: bold;">starbuzz</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Milk</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">CondimentDecorator</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Beverage</span> <span style="color: #268bd2;">beverage</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Milk</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Beverage</span> <span style="color: #268bd2;">beverage</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.beverage = beverage;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> beverage.getDescription<span style="color: #268bd2;">()</span> + <span style="color: #2aa198;">", Milk"</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">double</span> <span style="color: #268bd2;">cost</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> .10 + beverage.cost<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>最后我们来看看测试代码,用法很特别
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch3.<span style="color: #268bd2; font-weight: bold;">starbuzz</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CoffeeTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Beverage</span> <span style="color: #268bd2;">beverage</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Espresso</span><span style="color: #268bd2;">()</span>;
        System.out.println<span style="color: #268bd2;">(</span>beverage.getDescription<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">" $"</span> + beverage.cost<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">Beverage</span> <span style="color: #268bd2;">beverage2</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">DarkRoast</span><span style="color: #268bd2;">()</span>;
        beverage2 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Mocha</span><span style="color: #268bd2;">(</span>beverage2<span style="color: #268bd2;">)</span>;
        beverage2 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Mocha</span><span style="color: #268bd2;">(</span>beverage2<span style="color: #268bd2;">)</span>;
        beverage2 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Whip</span><span style="color: #268bd2;">(</span>beverage2<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span>beverage2.getDescription<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">" $"</span> + beverage2.cost<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">Beverage</span> <span style="color: #268bd2;">beverage3</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">HouseBlend</span><span style="color: #268bd2;">()</span>;
        beverage3 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Soy</span><span style="color: #268bd2;">(</span>beverage3<span style="color: #268bd2;">)</span>;
        beverage3 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Mocha</span><span style="color: #268bd2;">(</span>beverage3<span style="color: #268bd2;">)</span>;
        beverage3 = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Whip</span><span style="color: #268bd2;">(</span>beverage3<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span>beverage3.getDescription<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">" $"</span> + beverage3.cost<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Espresso $1.99                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Dark Roast Coffee, Mocha, Mocha, Whip $1.49    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">House Blend Coffee, Soy, Mocha, Whip $1.34     //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Chapter 4: the Factory Pattern: Baking with OO Goodness</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">Thinking about "new"</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>当你要使用new的时候,其实你是在"实例化"一个concrete class.所以,结果必须是一个
class,而不是一个interface.
</li>
<li>而且你以后会发现,使用new来创建一个concrete class会让你的代码more fragile 并
且less flexible.
</li>
<li>假设,你有一系列已知的concrete class, 你要想在运行时知道使用哪个concrete class
必须写如下的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">duck</span>;
<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>picnic<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    duck = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MalardDuck</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>hunting<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    duck = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">DecoyDuck</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>inBathTub<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    duck = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">RubberDuck</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>如果类似上面一样代码出现在你代码的多个地方的时候,维护以及更新"这些代码"都会
是nightmare
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">What's wrong with "new"?</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>其实从技术角度上来讲, new并没有什么错误,错误还是在于我们的老朋友CHANGE(改变):
<ul class="org-ul">
<li>新的类型的"鸭子"可能会加入
</li>
<li>老的类型的"鸭子"可能会不再支持
</li>
</ul>
</li>
<li>如果上述CHANGE不停出现,你在代码里找到那些if else,并且更改,是非常麻烦的事情,
所以,我们必须做些改变
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">Identifying the aspects that vary</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>"判断哪些部分是以后可能改动的"是我们的design principle之一
</li>
<li>假设我们有个披萨店, 然后就有一个"订购披萨"的函数
<div class="org-src-container">

<pre class="src src-java"><span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Pizza</span><span style="color: #b58900;">()</span>;

    pizza.prepare<span style="color: #b58900;">()</span>;
    pizza.bake<span style="color: #b58900;">()</span>;
    pizza.cut<span style="color: #b58900;">()</span>;
    pizza.box<span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">return</span> pizza;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>但是我们需要多种类型的披萨,所以传入个参数来引入多种披萨
<div class="org-src-container">

<pre class="src src-java"><span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span>;

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.equals<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.equals<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"greek"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">GreekPizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.equals<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"pepperoni"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">PepperoniPizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    pizza.prepare<span style="color: #b58900;">()</span>;
    pizza.bake<span style="color: #b58900;">()</span>;
    pizza.cut<span style="color: #b58900;">()</span>;
    pizza.box<span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">return</span> pizza;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>仔细分析代码,这段代码还是破坏了我们的design principle:"代码必须对扩展开放,
但是不要运行更改内部代码", 因为如果我们要"增加新披萨",或者是"删除老披萨",必
然要改动这个函数, 比如
<div class="org-src-container">

<pre class="src src-java"><span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span>;

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.equals<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.equals<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"pepperoni"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">PepperoniPizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>type.euqls<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">newly added</span>
        pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClamPizza</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    pizza.prepare<span style="color: #b58900;">()</span>;
    pizza.bake<span style="color: #b58900;">()</span>;
    pizza.cut<span style="color: #b58900;">()</span>;
    pizza.box<span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">return</span> pizza;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>经过这个改动,我们也就知道如下部分是"不变"的,我们需要跟"变化"的部分分开
<div class="org-src-container">

<pre class="src src-java">pizza.prepare<span style="color: #2aa198;">()</span>;
pizza.bake<span style="color: #2aa198;">()</span>;
pizza.cut<span style="color: #2aa198;">()</span>;
pizza.box<span style="color: #2aa198;">()</span>;
<span style="color: #859900; font-weight: bold;">return</span> pizza;
</pre>
</div>
</li>
<li>也就是说,变化的部分是如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>type.equals<span style="color: #b58900;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>type.equals<span style="color: #b58900;">(</span><span style="color: #2aa198;">"pepperoni"</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">PepperoniPizza</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>type.euqls<span style="color: #b58900;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">newly added</span>
    pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClamPizza</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>一个最直观的想法就是把改动的这个部分封装在一个函数里面,这样所有用到这段代码
的地方,只需要更改这个函数就可以了.这看起来好像是DRY(Don't repeat yourself)
的感觉
</li>
<li>在design pattern的世界里面,我们把抽象出来的这个函数叫做Factory, 这个名字也
很形象: 我们每次都需要instance的时候,直观跟工厂要,产品更新换代这些事情,就交
给"工厂"来处理吧.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">Building a simple pizza factory</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>好了,我们现在来看看"抽出来"的代码实现factory的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">SimplePizzaFactory</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>type.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>type.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"pepperoni"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">PepperoniPizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>type.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClamPizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>type.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"veggie"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">VeggiePizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>这段代码"抽出来"以后,貌似只是"换了一个地方增加或删除披萨类型",但是因为这段代
码会在"其他多个地方使用",所以"抽出来"以后,你可以只改动一个地方,就"影响"其他
的使用它的类了.
</li>
<li>这个是factory的代码,还有一种叫做static factory代码, static factory的代码,就
是把createPizza函数设计成static的,这样做有优点也有缺点:
<ul class="org-ul">
<li>优点是不需要实例化SimplePizzaFactory就可以使用createPizza
</li>
<li>缺点是不能通过"继承"SimplePizzaFactory来更改createPizza的实现.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5">Reworking the PizzaStore class</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li>已经把"改动的"抽出来了,然后我们再看看把"抽出来"的部分,加载到原来的"不变的"
部分中去
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">As we use factory, not `static factory`, we have to have the factory</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">instance first.</span>
    <span style="color: #b58900;">SimplePizzaFactory</span> <span style="color: #268bd2;">factory</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">PizzaStore</span><span style="color: #b58900;">(</span><span style="color: #b58900;">SimplePizzaFactory</span> <span style="color: #268bd2;">factory</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.factory = factory;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span>;

        <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">`operator new` is repalced with `method createPizza`</span>
        pizza = factory.createPizza<span style="color: #268bd2;">(</span>type<span style="color: #268bd2;">)</span>;
        pizza.prepare<span style="color: #268bd2;">()</span>;
        pizza.bake<span style="color: #268bd2;">()</span>;
        pizza.cut<span style="color: #268bd2;">()</span>;
        pizza.box<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">other methods</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6">The Simple Factory defined</h3>
<div class="outline-text-3" id="text-4-6">
<ul class="org-ul">
<li>请屏住呼吸,接受下面的一个事实
<pre class="example">
       我们前面讨论的一切叫做`Simple Factory`, 它并不是设计模式的一种!
       介绍它是因为它广泛的存在和使用
</pre>
</li>
<li>下面就是simple factory的类图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/simple-factory.png" alt="simple-factory.png" />
</p>
<p><span class="figure-number">Figure 13:</span> simple-factory.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7">Franchising the pizza store</h3>
<div class="outline-text-3" id="text-4-7">
<ul class="org-ul">
<li>btw, franching在这里是"特许经营"的意思
</li>
<li>随着你的披萨越做越好,很多人想"加盟"你的品牌.特许加盟是有较高的利润,但是同时
也要解决两个问题:
<ul class="org-ul">
<li>为了保证自己的产品质量不会因为"新加盟商"的把控不力而砸了牌子
</li>
<li>每个加盟商都在不同的地区,都有"地区化的特殊"要求,换句话说,会有不同的的
prepare(),或者bake()函数实现
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8">We've seen one approach&#x2026;</h3>
<div class="outline-text-3" id="text-4-8">
<ul class="org-ul">
<li>如果利用我们上面学到的知识,我们可以使用Simple Factory来实现的话,会是一个非常
好的approach, 比如我们可以extends Simple Factory来创建新的Factory比如:
<ul class="org-ul">
<li>New York: 就创建个新的NYPizzaFactory
</li>
<li>Chicago: 就创建个新的ChicagoPizzaFactory
</li>
<li>California: 就创建个CaliforniaPizzaFactory
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9">But you'd like a little more quality control</h3>
<div class="outline-text-3" id="text-4-9">
<ul class="org-ul">
<li>如果让加盟商自己的Factory来实现bake()等重要函数, 如果供应商在这上面做了什么
手脚的话,其肯定会对我们的品牌有影响
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10">A framework for the pizza store</h3>
<div class="outline-text-3" id="text-4-10">
<ul class="org-ul">
<li>好,总结起来,我们对"加盟"这件事情,有如下两点要求:
<ul class="org-ul">
<li>我们对于prepare(), bake()等工作要求甚高,不能由"加盟商"实现,所以我们要保护
好这些代码
</li>
<li>同时我们要给"加盟商"一些选择自己的披萨类型的权利.注意是'选择披萨类型的权利',
而不是'更改烹饪方法的权利'
</li>
</ul>
</li>
<li>下面就是一种能够满足上述两种要求的做法, 首先在PizzaStore里面加一个abstract
method(所以PizzaStore自己也就是abstract的了)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span>;

        pizza = createPizza<span style="color: #268bd2;">(</span>type<span style="color: #268bd2;">)</span>;

        pizza.prepare<span style="color: #268bd2;">()</span>;
        pizza.bake<span style="color: #268bd2;">()</span>;
        pizza.cut<span style="color: #268bd2;">()</span>;
        pizza.box<span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>这样做的直观感受就是"factory被变成了一个abstract method"
</li>
<li>然后,我们让其他的加盟商来extends我们的PizzaStore, 然后在子类里面Override最
重要的函数createPizza, 因为这个函数约束了其返回值必须是Pizza类型的.所以只需
要要求所有的Pizza(包括其子类)都是我们"供应商"提供的,就可以了!
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NYPizzaStore</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">item</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYStyleCheesePizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"veggie"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYStyleVeggiePizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYStyleClamPizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"pepperoni"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYStylePepperoniPizza</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11">Declaring a factory method</h3>
<div class="outline-text-3" id="text-4-11">
<ul class="org-ul">
<li>abstract createPizza method其实就是一个起到factory作用的method.简称factory
method,其特征一般如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">Product</span> <span style="color: #268bd2;">factoryMethod</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>factory method的特征分析:
<ul class="org-ul">
<li>首先factory method必须是abstract的, 所以才能让subclass来进行object的creation
的活动
</li>
<li>其次,其返回值一般会为superclass所用, superclass也知道其接口
</li>
<li>factoryMethod也是可以有参数的,用来选择不同的类型.
</li>
</ul>
</li>
<li>factoryMethod其实就是让使用它代码的client(orderPizza() in superclass), 不去
了解它要去处理的exactly的类型(只知道个大概,也就是Pizza, 不知道具体类型)
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12">We're just missing one thing: PIZZA!</h3>
<div class="outline-text-3" id="text-4-12">
<ul class="org-ul">
<li>基类的Pizza是如下的样子
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">dough</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">sauce</span>;
    <span style="color: #b58900;">ArrayList</span> <span style="color: #268bd2;">toppings</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">()</span>;

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepare</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Prepareing"</span> + name<span style="color: #268bd2;">)</span>;

    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>基类是我们供应的,但是加盟商希望更多样话更本地化,我们就sub一个芝加哥的子类
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ChicagoStyleCheesePizza</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ChicagoStyleCheesePizza</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        name = <span style="color: #2aa198;">"Chicago Style Deep Dish Cheese Pizza"</span>;
        dough = <span style="color: #2aa198;">"Extra Thick Crust Dough"</span>;
        sauce = <span style="color: #2aa198;">"Plum Tomato Sauce"</span>;

        toppings.add<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Shredded Mozzarella Cheese"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">The chicago style pizza also overrides the cut() method</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">so that the pieces are cut into square.</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">cut</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Cutting the pizza into square slices"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>好,我们来main函数,来看我们怎么使用这些store和pizza
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">method</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">PizzaStore</span> <span style="color: #268bd2;">nyStore</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYPizzaStore</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">PizzaStore</span> <span style="color: #268bd2;">chicagoStore</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ChicagoPizzaStore</span><span style="color: #268bd2;">()</span>;

        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = nyStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adam ordered a "</span> + pizza.getName<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">"\n"</span><span style="color: #268bd2;">)</span>;

        pizza = chicagoStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Bell ordered a "</span> + pizza.getName<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">"\n"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">///////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a NY Style Cheese Pizza ---                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing NY Style Cheese Pizza                       //</span>
<span style="color: #93a1a1;">//   </span><span style="color: #93a1a1;">Grated Reggiano Cheese                              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutes at 350                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cutting the pizza into diagonal slices                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Adam ordered a NY Style Cheese Pizza                  //</span>
<span style="color: #93a1a1;">//                                                       </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a Chicago Style Deep Dish Cheese Pizza --- //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing Chicago Style Deep Dish Cheese Pizza        //</span>
<span style="color: #93a1a1;">//   </span><span style="color: #93a1a1;">Shredded Mozzarella Cheese                          //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutes at 350                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cutting the pizza into square slices                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bell ordered a Chicago Style Deep Dish Cheese Pizza   //</span>
<span style="color: #93a1a1;">///////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13">It's finally time to meet the Factory Method Pattern</h3>
<div class="outline-text-3" id="text-4-13">
<ul class="org-ul">
<li>factory-like pattern有一个特点叫
<pre class="example">
       封装object创建过程: encapsulate object creation
</pre>
</li>
<li>Factory Method Pattern的封装过程很特别: 其是
<pre class="example">
       让子类来决定生产什么样的对象
</pre>
</li>
<li>下面是factory method pattern的类图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/factory-method.png" alt="factory-method.png" />
</p>
<p><span class="figure-number">Figure 14:</span> factory-method.png</p>
</div>
</li>
<li>为了让子类来决定生产什么样的对象, 我们必须在父类里面声明一个abstact method
也就是createPizza()
</li>
<li>而真正生产pizza的class是NYPizzaStore(也就是加盟商),这种"真正的生产product"
的class叫做concrete creator
</li>
<li>abstract class Pizza是 abstract class PizzaStore里面生产的, 而真实的类型则
是NYStyleCheesePizza这种,也叫concrete product
</li>
<li>更加重要的是, factory method pattern是一个"生产者"和"产品"相互对应的形式:
<ul class="org-ul">
<li>Abstract Factory produces Abstract Product
</li>
<li>Concrete Factory produces Concrete Product
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14">Factory Method Pattern defined</h3>
<div class="outline-text-3" id="text-4-14">
<ul class="org-ul">
<li>定义还是如此的艰涩
<pre class="example">
The Factory Method Pattern: defines an interface for creating an object,
but lets subclasses decide which class to instantiate, Factory Method lets a
class defer instantiation to subclasses.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15">A very dependent PizzaStore</h3>
<div class="outline-text-3" id="text-4-15">
<ul class="org-ul">
<li>粗看起来Factory Method pattern好像没什么用, 因为要理解它的作用,要先来个反例:
下面这个例子没有使用任何一种factory, 我们的Store就直接依赖于各种的pizza object
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">DependentPizzaStore</span> <span style="color: #2aa198;">{</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">style</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>style.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"NY"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = NYStyleCheesePizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = NYStyleClamPizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"veggie"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = NYStyleVeggiePizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>style.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Chicago"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = ChicagoStyleCheesePizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = ChicagoStyleClamPizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>type.equals<span style="color: #859900;">(</span><span style="color: #2aa198;">"veggie"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                pizza = ChicagoStyleVeggiePizza<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #268bd2;">}</span>

        pizza.prepare<span style="color: #268bd2;">()</span>;
        pizza.bake<span style="color: #268bd2;">()</span>;
        pizza.cut<span style="color: #268bd2;">()</span>;
        pizza.box<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>所以我们每增加一个类型的pizza,我们就要更改一次PizzaStore,因为我们的PizzaStore
是"直接依赖concrete pizza类型的"

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/very-dependent-pizzastore.png" alt="very-dependent-pizzastore.png" />
</p>
<p><span class="figure-number">Figure 15:</span> very-dependent-pizzastore.png</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16">The Dependency Inversion Principle</h3>
<div class="outline-text-3" id="text-4-16">
<ul class="org-ul">
<li>我们可以看到,减少对"concrete class"的依赖,是一件非常好的事情.我们甚至为这条
增加了一个design principle
<pre class="example">
Depend upon abstractions. Do not depend upon concrete classes
</pre>
</li>
<li>这个principle看起来和"program to interface"相似,但是缺是一个"更强"的要求:
<ul class="org-ul">
<li>"program to interface"更多的是要求high-level使用low-level的时候,要使用
low-level的接口
</li>
<li>而我们当前的dependency inversion principle要求我们(high-level就是决定
low-level的类,比如这里是store, 而low-level就是pizza:
<ol class="org-ol">
<li>high-level依赖low-level的接口
</li>
<li>low-level也要同时依赖high-level的接口
</li>
</ol>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17">Applying the Principle</h3>
<div class="outline-text-3" id="text-4-17">
<ul class="org-ul">
<li>前面的Very Dependent PizzaStore的问题就是会depends on'每一种pizza'.其实我们
的PizzaStore如果考虑'每一种pizza'就会相互的dependency很重
</li>
<li>我们要通过apply 'dependency inversion principle'来减少"两个方向上的依赖":也
就是我们前面的Factory Method Pattern. 我们可以看到,apply factory method pattern
以后,high-level的PizzaStore和low-level的concrete pizza都依赖于"abstract pizza"

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/apply-principle-pizzastore.png" alt="apply-principle-pizzastore.png" />
</p>
<p><span class="figure-number">Figure 16:</span> apply-principle-pizzastore.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-18" class="outline-3">
<h3 id="sec-4-18">A few guidelines to help you follow the Pinciple&#x2026;</h3>
<div class="outline-text-3" id="text-4-18">
<ul class="org-ul">
<li>坚持如下几点设计的"外在要求",能够保证不破坏Dependency Inversion Principle:
<ul class="org-ul">
<li>No variable should hold a reference to a concrete class: 如果你使用了new的
话, 那么你就hold了一个concrete class的reference,肯定就依赖于这个concrete
class, 使用factory来返回一个interface,在runtime来确定是什么concrete class
</li>
<li>No class should derive from a concrete class: 如果你继承一个concrete class,
那么肯定是依赖于这个class, 所以请继承一个interface(或者abstract class)
</li>
<li>No method should override an implementted method of any of its base classes:
依然用到了继承, 而且还是集成的abstract class, 那么base class的method已经实
现了的话,那么subclass是"最好不要"改动implementation,因为一旦改动,这个"is-a"
的关系,就不纯正了.
</li>
</ul>
</li>
<li>上面三条,都是"最好"坚持,因为不可能所有的情况下都不break这些条例.比如我们的
chicago pizza就行override了cut()函数
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-19" class="outline-3">
<h3 id="sec-4-19">Ensuring consistency in your ingredients</h3>
<div class="outline-text-3" id="text-4-19">
<ul class="org-ul">
<li>我们已经标准化了生产过程,但是"加盟商"还会在"原料"上偷工减料,从而伤害我们的品
牌, 所以,我们还要对原料的来源进行"标准化"
</li>
<li>而原料的标准化比较麻烦,因为原料都是原产地直供的:芝加哥的red sauce和纽约的
red sauce肯定不一样.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-20" class="outline-3">
<h3 id="sec-4-20">Building the ingredient factories</h3>
<div class="outline-text-3" id="text-4-20">
<ul class="org-ul">
<li>下面我们来创建一个"制造ingredient的factory", 这是个interface (pure abstract)
class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Dough</span> <span style="color: #268bd2;">createDough</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Sauce</span> <span style="color: #268bd2;">createSauce</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Cheese</span> <span style="color: #268bd2;">createCheese</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Clam</span> <span style="color: #268bd2;">createClam</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>在这个"抽象工厂"的基础上,我们要坐如下工作来满足我们的要求:
<ul class="org-ul">
<li>为每一个地区都创建一个PizzaIngredientFactory的subclass来创建"地区特色配料"
</li>
<li>创建一系列"concrete ingredient", 比如ReggianoCheese, ThinCrustDough这些配
料是可以在不同的地区间分享的(如果一个ingredient每处都可得,当然可以)
</li>
<li>最后我们还是需要一个PizzaStore来联系所有的东西
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-21" class="outline-3">
<h3 id="sec-4-21">Building the New York ingredient factory</h3>
<div class="outline-text-3" id="text-4-21">
<ul class="org-ul">
<li>我们首先来看看为NY准备的sub class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NYPizzaIngredientFactory</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #2aa198;">{</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Dough</span> <span style="color: #268bd2;">createDough</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ThinCrustDough</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Sauce</span> <span style="color: #268bd2;">createSauce</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MarinaraSauce</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Cheese</span> <span style="color: #268bd2;">createCheese</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ReggianoCheese</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Clam</span> <span style="color: #268bd2;">createClam</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FreshClam</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-22" class="outline-3">
<h3 id="sec-4-22">Reworking the pizzas</h3>
<div class="outline-text-3" id="text-4-22">
<ul class="org-ul">
<li>pizza的代码现在如下, 其为一个abstract class, 和它打交道的也都是一些abstract
的class(或者interface), 比如 Dough Sauce Clam等
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">Dough</span> <span style="color: #268bd2;">dough</span>;
    <span style="color: #b58900;">Sauce</span> <span style="color: #268bd2;">sauce</span>;
    <span style="color: #b58900;">Cheese</span> <span style="color: #268bd2;">cheese</span>;
    <span style="color: #b58900;">Clam</span> <span style="color: #268bd2;">clam</span>;

    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepare</span><span style="color: #b58900;">()</span>;

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">bake</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Bake for 25 minutest at 350"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">cut</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Cuttng the pizza into diagonal slices"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">box</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Place pizza in official PizzaStore box"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setName</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">StringBuilder</span> <span style="color: #268bd2;">result</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">StringBuilder</span><span style="color: #268bd2;">()</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"---  "</span> + name + <span style="color: #2aa198;">" ---\n"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>dough != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span>dough<span style="color: #6c71c4;">)</span>;
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>sauce != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span>sauce<span style="color: #6c71c4;">)</span>;
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>cheese != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span>cheese<span style="color: #6c71c4;">)</span>;
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>clam != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span>clam<span style="color: #6c71c4;">)</span>;
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> result.toString<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>只有abstract的Pizza是不够的,我们还要concrete的Pizza, 也只有在concrete的时候,
你才会发现, "配料工厂"才会进来和我们合作
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CheesePizza</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">CheesePizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.ingredientFactory = ingredientFactory;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepare</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Preparing "</span> + name<span style="color: #268bd2;">)</span>;
        dough = ingredientFactory.createDough<span style="color: #268bd2;">()</span>;
        sauce = ingredientFactory.createSauce<span style="color: #268bd2;">()</span>;
        cheese = ingredientFactory.createCheese<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>当然你会发现,合作的也是"abstract factory", 原料的不同,会以"工厂的不同"来显
示出来. 从ClamPizza上再来看一遍
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ClamPizza</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ClamPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.ingredientFactory = ingredientFactory;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepare</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Preparing "</span> + name<span style="color: #268bd2;">)</span>;
        dough = ingredientFactory.createDough<span style="color: #268bd2;">()</span>;
        sauce = ingredientFactory.createSauce<span style="color: #268bd2;">()</span>;
        cheese = ingredientFactory.createCheese<span style="color: #268bd2;">()</span>;
        clam = ingredientFactory.createClam<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-23" class="outline-3">
<h3 id="sec-4-23">Revisiting our pizza stores</h3>
<div class="outline-text-3" id="text-4-23">
<ul class="org-ul">
<li>PizzaStore必然和原来一样, 只是一个factory method来引入pizza的factory
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">protected</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">item</span><span style="color: #b58900;">)</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">orderPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">type</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = createPizza<span style="color: #268bd2;">(</span>type<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--- Making a "</span> + pizza.getName<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">" ---"</span><span style="color: #268bd2;">)</span>;
        pizza.prepare<span style="color: #268bd2;">()</span>;
        pizza.bake<span style="color: #268bd2;">()</span>;
        pizza.cut<span style="color: #268bd2;">()</span>;
        pizza.box<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>不同的subStore会确定不同的地区,从而引用不同的"配料工厂", 然后会根据口味的不
同来引入不同的pizza
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NYPizzaStore</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">protected</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">item</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span> =
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYPizzaIngredientFactory</span><span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #6c71c4;">(</span>ingredientFactory<span style="color: #6c71c4;">)</span>;
            pizza.setName<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"New York Style Cheese Pizza"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClamPizza</span><span style="color: #6c71c4;">(</span>ingredientFactory<span style="color: #6c71c4;">)</span>;
            pizza.setName<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"New York Style Clam Pizza"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-24" class="outline-3">
<h3 id="sec-4-24">What have we done?</h3>
<div class="outline-text-3" id="text-4-24">
<ul class="org-ul">
<li>我们为"不同地区,引入不同配料"的过程,其实是通过一种新的设计模式实现的:抽象工
厂 (Abstract Factory)
</li>
<li>抽象工厂模式是让我们使用不同的工厂来为每一个不同的地区,每一个不同的环境来创
建一个新的"一系列的product"
</li>
<li>抽象工厂不仅仅自己是抽象的,抽象工厂内部处理的product也是抽象的(一般是interface)
所以我们可以在sub factory中产生whatever的concrete product
</li>
<li>最后我们来看看main函数是怎么创建一个抽象工厂的
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">PizzaStore</span> <span style="color: #268bd2;">nyStore</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYPizzaStore</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">PizzaStore</span> <span style="color: #268bd2;">chicagoStore</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ChicagoPizzaStore</span><span style="color: #268bd2;">()</span>;

        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = nyStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Nina ordered a "</span> + pizza<span style="color: #268bd2;">)</span>;
        pizza = chicagoStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Clark ordered a "</span> + pizza<span style="color: #268bd2;">)</span>;

        pizza = nyStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Neil ordered a "</span> + pizza<span style="color: #268bd2;">)</span>;
        pizza = chicagoStore.orderPizza<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Cindy ordered a"</span> + pizza<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">/////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a New York Style Cheese Pizza ---        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing New York Style Cheese Pizza               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutest at 350                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cuttng the pizza into diagonal slices               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Nina ordered a ---  New York Style Cheese Pizza --- //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Thin Crust Dough                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Marinara Sauce                                      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Reggiano Cheese                                     //</span>
<span style="color: #93a1a1;">//                                                     </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a Chicago Style Cheese Pizza ---         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing Chicago Style Cheese Pizza                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutest at 350                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cuttng the pizza into diagonal slices               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Clark ordered a ---  Chicago Style Cheese Pizza --- //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Thin Crust Dough                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Marinara Sauce                                      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Shredded Mozzarella                                 //</span>
<span style="color: #93a1a1;">//                                                     </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a New York Style Clam Pizza ---          //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing New York Style Clam Pizza                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutest at 350                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cuttng the pizza into diagonal slices               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Neil ordered a ---  New York Style Clam Pizza ---   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Thin Crust Dough                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Marinara Sauce                                      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Reggiano Cheese                                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Fresh Clam from Long Island Sound                   //</span>
<span style="color: #93a1a1;">//                                                     </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--- Making a Chicago Style Clam Pizza ---           //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Preparing Chicago Style Clam Pizza                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bake for 25 minutest at 350                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cuttng the pizza into diagonal slices               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Place pizza in official PizzaStore box              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Cindy ordered a---  Chicago Style Clam Pizza ---    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Thin Crust Dough                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Marinara Sauce                                      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Shredded Mozzarella                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Frozen Clam from Chesapeake Bay                     //</span>
<span style="color: #93a1a1;">/////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
<li>创建store的时候,就确定了区域,至于每个区域的clam是什么样子的,那不用你关心,store
自己内部会处理
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-25" class="outline-3">
<h3 id="sec-4-25">Abstract Factory Pattern defined</h3>
<div class="outline-text-3" id="text-4-25">
<ul class="org-ul">
<li>好啦,让我们来看看abstract factory的具体定义
<pre class="example">
The Abstract Factory Pattern provides an interface for creating
families of related or dependent objects without specifying
their concrete classes
</pre>
</li>
<li>其核心的使用方法就是让client在创建的时候,完全使用抽象工厂,自己的函数也是只
处理抽象的对象:
<ul class="org-ul">
<li>比如,我们'具体的pizza CheesePizza'就是Abstract Factory的使用者(Client). 在
定义的时候, 内部是看不到concrete class的, PizzaIngredientFactory, dough,
sauce, cheese都是interface或者abstract class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch4.factory.<span style="color: #268bd2; font-weight: bold;">abstractf</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CheesePizza</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Pizza</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">CheesePizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.ingredientFactory = ingredientFactory;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepare</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Preparing "</span> + name<span style="color: #268bd2;">)</span>;
        dough = ingredientFactory.createDough<span style="color: #268bd2;">()</span>;
        sauce = ingredientFactory.createSauce<span style="color: #268bd2;">()</span>;
        cheese = ingredientFactory.createCheese<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
</pre>
</div>
</li>
<li>只有在runtime使用的时候,才会赋予一个concreteFactory, 从而生产出concretePizza,
注意是在if else里面的new instance的时候,传入一个concreteFactory
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NYPizzaStore</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">PizzaStore</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">protected</span> <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">createPizza</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">item</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Pizza</span> <span style="color: #268bd2;">pizza</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #b58900;">PizzaIngredientFactory</span> <span style="color: #268bd2;">ingredientFactory</span> =
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NYPizzaIngredientFactory</span><span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"cheese"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CheesePizza</span><span style="color: #6c71c4;">(</span>ingredientFactory<span style="color: #6c71c4;">)</span>;
            pizza.setName<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"New York Style Cheese Pizza"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>item.equals<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"clam"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            pizza = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClamPizza</span><span style="color: #6c71c4;">(</span>ingredientFactory<span style="color: #6c71c4;">)</span>;
            pizza.setName<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"New York Style Clam Pizza"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> pizza;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
<li>最后我们来看看Abstract Factory的类图,因为我们的例子中concrete Pizza是在一个
factory method中实现的,所以不是太明显,而在普通的Abstrct Factory中,其实这就是
一个Client Class

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/abstract-factory.png" alt="abstract-factory.png" />
</p>
<p><span class="figure-number">Figure 17:</span> abstract-factory.png</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Chapter 5: the Singleton Pattern: One of a Kind Objects</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>有很多的object在整个process中,我们只需要一个,如果实例化了超过一个对象,我们会
面对很多错误的行为,或者资源耗尽等错误,这类object有:
<ul class="org-ul">
<li>thread polls
</li>
<li>caches
</li>
<li>dialog boxes
</li>
<li>objects that handle preferences and registery settings
</li>
<li>objects used for logging
</li>
<li>objects that act as device drivers to devices like printers
</li>
</ul>
</li>
<li>Java中, static variable(全局变量)看起来也能达到"只有一个"的效果,但是显然singlton
显然是一个time-tested的方法.比如:
<ul class="org-ul">
<li>全局变量是在application加载的时候就被初始化了
</li>
<li>singleton可以在我们需要的时候再初始化
</li>
</ul>
</li>
<li>比如一个object是很珍贵的资源,如果我们初始化其为global variable,但是却从来不使
用,那就亏了. (注意end up doing的意思是: 最终做了something, end up相当于助词
'最终')
<pre class="example">
What if this object is resource intensive and your application never
ends up using it?
</pre>
</li>
<li>当然现在业界也流传着singleton被"过度"使用的情况. 这个以后再表
</li>
</ul>
</div>
<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">Dissecting the classic Singleton Pattern implementation</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>我们保证一个object只被初始化一次的方法是private ctor,下面是第一个例子(当然
这个例子不完美)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Singleton</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span> <span style="color: #268bd2;">uniqueInstance</span>;

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">other useful instance variables here</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #268bd2;">Singleton</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span> <span style="color: #268bd2;">getInstance</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            uniqueInstance = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Singleton</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">other useful methods here</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">The Chocolate Factory</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>现代的巧克力工厂(不是工厂模式)都有一个电脑控制的锅炉,用来混合巧克力和牛奶,
并加热
</li>
<li>这个锅炉的程序书写要非常的小心,避免以下几种"BAD things"的出现:
<ul class="org-ul">
<li>巧克力和牛奶还没有加热就排除
</li>
<li>锅炉已经满了还往里加牛奶或巧克力
</li>
<li>加热一个空的锅炉
</li>
</ul>
</li>
<li>下面是我们的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">empty</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">boiled</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ChocolateBoiler</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        empty = <span style="color: #268bd2; font-weight: bold;">true</span>;
        boiled = <span style="color: #268bd2; font-weight: bold;">false</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fill</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>isEmpty<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            empty = <span style="color: #268bd2; font-weight: bold;">false</span>;
            boiled = <span style="color: #268bd2; font-weight: bold;">false</span>;
            <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">fill the boiler with a milk/chocolate mixture</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">drain</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-weight: bold;">!</span>isEmpty<span style="color: #6c71c4;">()</span> &amp;&amp; isBoiled<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">drain the boiled milk and cholate</span>
            empty = <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">boil</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-weight: bold;">!</span>isEmpty<span style="color: #6c71c4;">()</span> &amp;&amp; isBoiled<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">bring the contents to a boil</span>
            boiled = <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">isEmpty</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> empty;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">isBoiled</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> boiled;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>这个代码非常认真的控制了一些边界条件,试图让bad things不发生. 但是,一个意想不
到的事情发生了,那就是
<pre class="example">
ChocolateBoiler被实例化了多次!!
</pre>
</li>
<li>一旦被实例化多少次,可能objectA已经把锅炉注满了,objectB又新创建,还以为是空的!
</li>
<li>那么当务之急就是让ChocolateBoiler变成一个Singleton class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">empty</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">boiled</span>;

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #268bd2;">uniqueInstance</span>;

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #268bd2;">ChocolateBoiler</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        empty = <span style="color: #268bd2; font-weight: bold;">true</span>;
        boiled = <span style="color: #268bd2; font-weight: bold;">false</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #268bd2;">getInstance</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            uniqueInstance = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ChocolateBoiler</span><span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fill</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>isEmpty<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            empty = <span style="color: #268bd2; font-weight: bold;">false</span>;
            boiled = <span style="color: #268bd2; font-weight: bold;">false</span>;
            <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">fill the boiler with a milk/cocolate mixture</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">rest of ChocolateBoiler Code</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">Singleton Pattern defined</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>Singleton模式定义如下
<pre class="example">
The Sinleton Pattern ensures a class has only one instance, and provides a glob
al point of access to it.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4">Threads are a problem</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>如果我们允许多个thread,同时调用getInstance()函数的话,可能会出现非常严重的问
题. 简言之就是"破坏了只能实例化一个对象"的承诺:
<ul class="org-ul">
<li>首先为了能够使问题更容易实现,让getInstance中间休息一秒
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #268bd2;">getInstance</span><span style="color: #2aa198;">()</span> <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">Exception</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        SECONDS.sleep<span style="color: #268bd2;">(</span>1<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Creating unique instance of Chocolate Boiler, should happen only once!"</span><span style="color: #268bd2;">)</span>;
        uniqueInstance = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ChocolateBoiler</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    System.out.println<span style="color: #b58900;">(</span><span style="color: #2aa198;">"Returning instance of Chocolate Boiler"</span><span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>创建一个允许getInstance()的thread
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch5.singleton.<span style="color: #268bd2; font-weight: bold;">notthreadsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">BoilerRunnable</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Runnable</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            ChocolateBoiler.getInstance<span style="color: #6c71c4;">()</span>.fill<span style="color: #6c71c4;">()</span>;
            ChocolateBoiler.getInstance<span style="color: #6c71c4;">()</span>.boil<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">Exception</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            e.printStackTrace<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>

    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们运行三个thread,应该只创建一次object, 从打印信息来看,我们不小心创建了
三次(每个thread都创建了一个object). singleton的承诺,荡然无存
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch5.singleton.<span style="color: #268bd2; font-weight: bold;">notthreadsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 3; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Thread</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">BoilerRunnable</span><span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>.start<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Creating unique instance of Chocolate Boiler, should happen only once! //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Filling                                                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Creating unique instance of Chocolate Boiler, should happen only once! //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Filling                                                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">We boiled already! NO MORE Boil should ever happen!                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Creating unique instance of Chocolate Boiler, should happen only once! //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Filling                                                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">We boiled already! NO MORE Boil should ever happen!                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">We boiled already! NO MORE Boil should ever happen!                    //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
<li>一个显而易见的办法是:
<ul class="org-ul">
<li>让getInstance每次只能有一个thread进入
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">ChocolateBoiler</span> <span style="color: #268bd2;">getInstance</span><span style="color: #2aa198;">()</span> <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">Exception</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        SECONDS.sleep<span style="color: #268bd2;">(</span>1<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Creating unique instance of Chocolate Boiler, should happen only once!"</span><span style="color: #268bd2;">)</span>;
        uniqueInstance = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ChocolateBoiler</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
    System.out.println<span style="color: #b58900;">(</span><span style="color: #2aa198;">"Returning instance of Chocolate Boiler"</span><span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>结果很令人满意
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch5.singleton.<span style="color: #268bd2; font-weight: bold;">threadsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 3; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Thread</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">BoilerRunnable</span><span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>.start<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;                         //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Creating unique instance of Chocolate Boiler, should happen only once! //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Filling                                                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">We boiled already! NO MORE Boil should ever happen!                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Returning instance of Chocolate Boiler                                 //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5">Can we improve multithreading?</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>synchronized已经可以完成任务,但是还是有提高效率的余地:
<ul class="org-ul">
<li>如果getInstance()对你的效率影响没有"很重要", 那么,不必要进行improve.
synchronized的方式,一般会降低100倍的速度.所以如果经常调用的话,还是要去优化
</li>
<li>放弃lazy initialization, 当然了,这样就无法做到我们前面说的"expensive的资源
不需要就不创建". 下面的方法,等于使用了JVM的承诺:一定在某个thread到来之前,
初始化好instance
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Singleton</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span> <span style="color: #268bd2;">uniqueInstance</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Singleton</span><span style="color: #b58900;">()</span>;

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #268bd2;">Singleton</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span> <span style="color: #268bd2;">getInstance</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>使用"double-check lock"来解决synchronized次数多的问题!(After JDK 1.4).注意!
下面的例子使用了两次的check. 综合下来,我们只有第一个thread来的时候需要synchronized.
还要注意的是double check要同时加上volatile,防止编译器为了性能更改'语句'顺序.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Singleton</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">volatile is needed here</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">volatile</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span> <span style="color: #268bd2;">uniqueInstance</span>;

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #268bd2;">Singleton</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">Singleton</span>  <span style="color: #268bd2;">getInstance</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">synchronized the Singleton.class, other than this!</span>
            <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #6c71c4;">(</span>Singleton.<span style="color: #859900; font-weight: bold;">class</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #93a1a1;">/////////////////////////////////////////////////////////////////</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">There may be more than one threads waiting outside of the   //</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">synchronized closure, so after the first thread out, the    //</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">second thread go here may still not know that the           //</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">uniqueInstance is already created                           //</span>
                <span style="color: #93a1a1;">/////////////////////////////////////////////////////////////////</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>uniqueInstance == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                    uniqueInstance = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Singleton</span><span style="color: #b58900;">()</span>;
                <span style="color: #859900;">}</span>
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> uniqueInstance;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Chapter 6: the Command Pattern: Encapsulating Invocation</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">Remote Control</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>最近我们又接到了新的任务:
<ul class="org-ul">
<li>我们要设计一个remote control
</li>
<li>这个remote control有七个'可编程槽', 每个槽都有on off的开关
</li>
<li>remote control还有一个全局的undo开关
</li>
<li>如何控制这些硬件的函数,都已经有了比如
<ol class="org-ol">
<li>开:函数on()
</li>
<li>关:函数off()
</li>
<li>其他函数比如setVolumen(), setInputChannel()也是有的,但是显然我们remote
control用不到
</li>
</ol>
</li>
<li>要支持这些函数,同时还要考虑到以后,可能有更多的硬件(最少有on, off函数),要
能够支持.
</li>
</ul>
</li>
<li>如果我们没个slot都设计个switch显然是可以解决问题的,比如
<div class="org-src-container">

<pre class="src src-java"><span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">for slot 1</span>
<span style="color: #859900; font-weight: bold;">switch</span><span style="color: #2aa198;">(</span>slot1<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
<span style="color: #859900; font-weight: bold;">case</span> Light:
    light.on<span style="color: #b58900;">()</span>;
<span style="color: #859900; font-weight: bold;">case</span> TV:
    tv.on<span style="color: #b58900;">()</span>;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">..</span>
<span style="color: #2aa198;">}</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">for slot 2</span>
<span style="color: #859900; font-weight: bold;">switch</span><span style="color: #2aa198;">(</span>slot2<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
<span style="color: #859900; font-weight: bold;">case</span> Light:
    light.on<span style="color: #b58900;">()</span>;
<span style="color: #859900; font-weight: bold;">case</span> TV:
    tv.on<span style="color: #b58900;">()</span>;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">..</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>这种设计最主要的问题是,如果增加了一个新的设备比如DVD,那么所有的十四个slot都要
更改代码.
</li>
<li>这种设计最主要的问题, 是和Light, TV, DVD等耦合的太紧了,解决办法就是:
<pre class="example">
       设计一个Command object, 我们的remote control和这个Command object交谈,
       而Command object则负责和它对应的设备(可以是Light, TV, DVD中的一种)交谈
</pre>
</li>
<li>这也就是Command Pattern的主要思想: 创建一个中间的object来解耦和
</li>
<li>对于remoteControl这个例子来说(我们以Light为例子):
<ul class="org-ul">
<li>我们首先创建一个抽象的Command interface
</li>
<li>Remote Control里面就has-one Command Interface (我们把这个叫做Invoker)
</li>
<li>对于'开'和'关'这两个命令,我们分别要实现两个concreteCommand类
</li>
<li>这两个concreteCommand类里面要分别has-one 具体的已经存在的Object(这里就是
Light啦), 然后在内部调用已经存在的Object的函数(On或者Off)
</li>
<li>这样Command Interface和Concrete Command在一起:一边联系了的RemoteControl,
另外一边联系了已经存在了的Object(Light).解除了两者的耦合
</li>
</ul>
</li>
<li>整体的UML图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/simple-remote.png" alt="simple-remote.png" />
</p>
<p><span class="figure-number">Figure 18:</span> simple-remote.png</p>
</div>
</li>
<li>下面我们来看看具体的代码:
<ul class="org-ul">
<li>Command Interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">simpleremote</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Command</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">execute</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Command Concrete Class(以LightOn为例子, LightOff相似)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">simpleremote</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">LightOnCommand</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Command</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">LightOnCommand</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.light = light;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">execute</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        light.on<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>被Command联系的一边: 已经存在的Light类代码(已经被前面的LightOnCommand所包
含了,也就是Composition组合)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">simpleremote</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Light</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">on</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Light On"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">off</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Light Off"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>被联系的另外一边,就是remoteControl的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">simpleremote</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">SimpleRemoteControl</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Command</span> <span style="color: #268bd2;">slot</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">SimpleRemoteControl</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Command</span> <span style="color: #268bd2;">slot</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.slot = slot;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">SimpleRemoteControl</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setCommand</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Command</span> <span style="color: #268bd2;">slot</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.slot = slot;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">press</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        slot.execute<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们最后需要一个Main函数来测试一下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">simpleremote</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Light</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">LightOnCommand</span> <span style="color: #268bd2;">lightOnCommand</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LightOnCommand</span><span style="color: #268bd2;">(</span>light<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">LightOffCommand</span> <span style="color: #268bd2;">lightOffCommand</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LightOffCommand</span><span style="color: #268bd2;">(</span>light<span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">SimpleRemoteControl</span> <span style="color: #268bd2;">SRLightOn</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">SimpleRemoteControl</span><span style="color: #268bd2;">()</span>;
        SRLightOn.setCommand<span style="color: #268bd2;">(</span>lightOnCommand<span style="color: #268bd2;">)</span>;
        SRLightOn.press<span style="color: #268bd2;">()</span>;

        <span style="color: #b58900;">SimpleRemoteControl</span> <span style="color: #268bd2;">SRLightOff</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">SimpleRemoteControl</span><span style="color: #268bd2;">()</span>;
        SRLightOff.setCommand<span style="color: #268bd2;">(</span>lightOffCommand<span style="color: #268bd2;">)</span>;
        SRLightOff.press<span style="color: #268bd2;">()</span>;

        <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">All other 6 ONs and 6 OFFs SimpleRemoteControl instances</span>
        <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">list here ...</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Light On                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Light Off                                      //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">The Command Pattern defined</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>Command Pattern的定义如下
<pre class="example">
The COmmand Pattern encapsulates a request as an object, thereby  letting
you parameterize other objects wieth different requests, queue or log
requests, and support undoable operations
</pre>
</li>
<li>类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/command-pattern.png" alt="command-pattern.png" />
</p>
<p><span class="figure-number">Figure 19:</span> command-pattern.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3">Time to QA that Undo button!</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>客户的需求和Command pattern的定义都提到了undo, 要我做到undo,我们必须更改
Command interface 增加一个函数undo()
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">remotewithundo</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Command</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">execute</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">undo</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>undo的实现很巧妙,就跟execute相反就可以
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">remotewithundo</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">LightOnCommand</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Command</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">LightOnCommand</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.light = light;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">execute</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        light.on<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">undo</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        light.off<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们的Invoker通过一个参数undoCommand始终记录着上次被调动的Command是哪个,然后
一旦调用undoButton的时候,就调用那个Command的undo()
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">remotewithundo</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">RemoteControlWithUndo</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Command</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">onCommands</span>;
    <span style="color: #b58900;">Command</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">offCommands</span>;
    <span style="color: #b58900;">Command</span> <span style="color: #268bd2;">undoCommand</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">RemoteControlWithUndo</span><span style="color: #b58900;">(){</span>
        onCommands = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Command</span><span style="color: #268bd2;">[</span>7<span style="color: #268bd2;">]</span>;
        offCommands = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Command</span><span style="color: #268bd2;">[</span>7<span style="color: #268bd2;">]</span>;

        <span style="color: #b58900;">Command</span> <span style="color: #268bd2;">noCommand</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NoCommand</span><span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 7; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            onCommands<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span> = noCommand;
            offCommands<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span> = noCommand;
        <span style="color: #268bd2;">}</span>
        undoCommand = noCommand;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setCommand</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">slot</span>, <span style="color: #b58900;">Command</span> <span style="color: #268bd2;">onCommand</span>, <span style="color: #b58900;">Command</span> <span style="color: #268bd2;">offCommand</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        onCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span>= onCommand;
        offCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span> = offCommand;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">onButtonWasPushed</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">slot</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        onCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span>.execute<span style="color: #268bd2;">()</span>;
        undoCommand = onCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">offButtonWasPushed</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">slot</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        offCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span>.execute<span style="color: #268bd2;">()</span>;
        undoCommand = offCommands<span style="color: #268bd2;">[</span>slot<span style="color: #268bd2;">]</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">undoButtonWasPushed</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        undoCommand.undo<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试例子如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch6.<span style="color: #268bd2; font-weight: bold;">remotewithundo</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">RemoteControlWithUndo</span> <span style="color: #268bd2;">remoteControlWithUndo</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">RemoteControlWithUndo</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">Light</span> <span style="color: #268bd2;">light</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Light</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">LightOnCommand</span> <span style="color: #268bd2;">lightOnCommand</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LightOnCommand</span><span style="color: #268bd2;">(</span>light<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">LightOffCommand</span> <span style="color: #268bd2;">lightOffCommand</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LightOffCommand</span><span style="color: #268bd2;">(</span>light<span style="color: #268bd2;">)</span>;

        remoteControlWithUndo.setCommand<span style="color: #268bd2;">(</span>0, lightOnCommand, lightOffCommand<span style="color: #268bd2;">)</span>;

        remoteControlWithUndo.onButtonWasPushed<span style="color: #268bd2;">(</span>0<span style="color: #268bd2;">)</span>;
        remoteControlWithUndo.offButtonWasPushed<span style="color: #268bd2;">(</span>0<span style="color: #268bd2;">)</span>;
        remoteControlWithUndo.undoButtonWasPushed<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Light On                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Light Off                                      //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Light On                                       //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Chapter 7: the Adapter and Facade Patterns: Being Adaptive</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Adapters all around us</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>理解adapter并不难,因为它普遍存在于我们的生活: 比如,在欧洲如果想使用美国的插
头,你得使用一个转接器,这个转接器在英文中的意思就是Adapter
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">Object oriented adapters</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>看完生活中的例子,我们再来说一个软件开发中的例子:
<ul class="org-ul">
<li>Vender为我们提供了一些class的接口让我们来使用, 但是我们已有的代码是无法支
持这些接口的

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/do-not-match.png" alt="do-not-match.png" />
</p>
<p><span class="figure-number">Figure 20:</span> do-not-match.png</p>
</div>
</li>
<li>我们已有的代码经过测试用例和实际环境的千锤百炼,不能轻易去改,而你又不可能去
更改Vender的代码.那么一个Adapter是一个非常好的选择

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/adapter-between.png" alt="adapter-between.png" />
</p>
<p><span class="figure-number">Figure 21:</span> adapter-between.png</p>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">Adapter Example</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>我们第一章讲过duck的例子, 一个Duck的特点是一能quack, 二能fly
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">ducks</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>MallardDuck是一种鸭子,所以继承这个接口就可以
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">ducks</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MallardDuck</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Quack"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Fly"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们有一个如下的接口,需要传入Duck interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">testDuck</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">duck</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</li>
<li>但是我们有的,确只是Turkey interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">ducks</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Turkey</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">gobble</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>如果想把Turkey 传入到一个声明类型为Duck的库函数里面,我们需要的就是一个Adapter
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">ducks</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">TurkeyAdapter</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Duck</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Turkey</span> <span style="color: #268bd2;">turkey</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">TurkeyAdapter</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Turkey</span> <span style="color: #268bd2;">turkey</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.turkey = turkey;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">quack</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        turkey.gobble<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">fly</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 5; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            turkey.fly<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>这样我们就可以使用testDuck啦
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">ducks</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">WildTurkey</span> <span style="color: #268bd2;">wildTurkey</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">WildTurkey</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">turkeyAdapter</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">TurkeyAdapter</span><span style="color: #268bd2;">(</span>wildTurkey<span style="color: #268bd2;">)</span>;
        testDuck<span style="color: #268bd2;">(</span>turkeyAdapter<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">testDuck</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">duck</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        duck.quack<span style="color: #268bd2;">()</span>;
        duck.fly<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Gobble gobble                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying a short distance                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying a short distance                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying a short distance                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying a short distance                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">I'm flying a short distance                    //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
<li>整个例子的类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/ducks.png" alt="ducks.png" />
</p>
<p><span class="figure-number">Figure 22:</span> ducks.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4">Adapter Pattern defined</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Adapter Pattern的定义如下
<pre class="example">
The Adapter Pattern converts the interface of a class into another
interface the clients expect. Adapter lets classes work together that
couldn't otherwise becasue of incompatible interfaces
</pre>
</li>
<li>我们上面的做法使用了interface,其实是adapter的一种(object adapter), adapter
一共有两种:
<ul class="org-ul">
<li>object adapter, 也就是我们前面使用的.是使用composition来完成adapt的

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/object-adapter.png" alt="object-adapter.png" />
</p>
<p><span class="figure-number">Figure 23:</span> object-adapter.png</p>
</div>
</li>
<li>class adapter, 是使用多重继承来完成adapt的, 这在java里面无法实现, c++里面
可以. 但是显然不如composition的来的更为灵活

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/class-adapter.png" alt="class-adapter.png" />
</p>
<p><span class="figure-number">Figure 24:</span> class-adapter.png</p>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5">Real world adapters</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>我们来看一个JDK里面存在的使用adapter的例子:
<ul class="org-ul">
<li>Java早期的collection(比如Vector, Stack Hashtable等)都implement了一个interface
Enumeration. 这个interface有两个函数hasMoreElements()和nextElement()
</li>
<li>后来,java实现了新的Collection的机制, 引入了一个崭新的和Enumeration类似的
interface: Iterator, 其有三个函数hasNext(),next(),remove()
</li>
</ul>
</li>
<li>我们这一章讲的是Adapter,所以救世主就肯定是Adapter啦.新的代码都是提供了Iterator
的interface(也就是Target).而我们产品的(久经考验, 不便再改)的代码,可能是Enumeration
的接口,所以,我们要祭出Adapter啦, 类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/jdk-adapter.png" alt="jdk-adapter.png" />
</p>
<p><span class="figure-number">Figure 25:</span> jdk-adapter.png</p>
</div>
</li>
<li>代码如下, remove不支持怎么办?抛异常呗&#x2026;
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">clas</span> <span style="color: #268bd2;">EnumerationIterator</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Iterator</span> <span style="color: #2aa198;">{</span>
    Enumeration <span style="color: #859900; font-weight: bold;">enum</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">EnumerationIterator</span><span style="color: #b58900;">(</span>Enumeration <span style="color: #859900; font-weight: bold;">enum</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.<span style="color: #859900; font-weight: bold;">enum</span> = <span style="color: #859900; font-weight: bold;">enum</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">enum</span>.hasMoreElements<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Object</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">enum</span>.nextElement<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6">There is another pattern in this chapter: Facade</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li>我们还要讲述一种比较简单的pattern: Facade
</li>
<li>之所以说这个pattern简单,是因为它的原理其实就是
<pre class="example">
Compose多个class在自己内部,然后自己设计函数,在函数内部使用compose的对象
</pre>
</li>
<li>说个例子:比如你有一个家庭影院,每次你看的时候都要做很多事情:
<ul class="org-ul">
<li>打开功放
</li>
<li>打开DVD
</li>
<li>打开电视机
</li>
<li>&#x2026;..
</li>
</ul>
</li>
<li>这每一件事情都是某个object的某个调用函数, 如果这个列表很长的话,对于用户来说,
体验就很不好.我们希望能有个类似"一键开始享受电影"的功能.
</li>
<li>实现方法,当然就是compose多个object, 然后在自己的oneKeyWatchMovie函数里面调
用这些object

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/theater-facade.png" alt="theater-facade.png" />
</p>
<p><span class="figure-number">Figure 26:</span> theater-facade.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7">Construting your home therater facade</h3>
<div class="outline-text-3" id="text-7-7">
<ul class="org-ul">
<li>下面来看看代码实现:
<ul class="org-ul">
<li>首先是Amplifier类
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">facade</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Amplifier</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Amplifier</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">on</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Amplifier is on"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>然后是DvdPlayer类 (compose了Amplifer)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">facade</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">DvdPlayer</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;
    <span style="color: #b58900;">Amplifier</span> <span style="color: #268bd2;">amplifier</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">DvdPlayer</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>, <span style="color: #b58900;">Amplifier</span> <span style="color: #268bd2;">amplifier</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
        <span style="color: #859900; font-weight: bold;">this</span>.amplifier = amplifier;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">on</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"DVD player is on"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Screen类
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">facade</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Screen</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Screen</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">on</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Screen is on, enjoy the movie"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Facade类
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">facade</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">HomeTheaterFacade</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Amplifier</span> <span style="color: #268bd2;">amplifier</span>;
    <span style="color: #b58900;">DvdPlayer</span> <span style="color: #268bd2;">dvdPlayer</span>;
    <span style="color: #b58900;">Screen</span> <span style="color: #268bd2;">screen</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">HomeTheaterFacade</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Amplifier</span> <span style="color: #268bd2;">amplifier</span>,
                             <span style="color: #b58900;">DvdPlayer</span> <span style="color: #268bd2;">dvdPlayer</span>,
                             <span style="color: #b58900;">Screen</span> <span style="color: #268bd2;">screen</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.amplifier = amplifier;
        <span style="color: #859900; font-weight: bold;">this</span>.dvdPlayer = dvdPlayer;
        <span style="color: #859900; font-weight: bold;">this</span>.screen = screen;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">oneKeyWatchMovie</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        amplifier.on<span style="color: #268bd2;">()</span>;
        dvdPlayer.on<span style="color: #268bd2;">()</span>;
        screen.on<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Main代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch7.<span style="color: #268bd2; font-weight: bold;">facade</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Amplifier</span> <span style="color: #268bd2;">amplifier</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Amplifier</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Top Amplifier"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">DvdPlayer</span> <span style="color: #268bd2;">dvdPlayer</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">DvdPlayer</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Top DVD Player"</span>, amplifier<span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">Screen</span> <span style="color: #268bd2;">screen</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Screen</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Top Screen"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">HomeTheaterFacade</span> <span style="color: #268bd2;">homeTheaterFacade</span> =
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">HomeTheaterFacade</span><span style="color: #268bd2;">(</span>amplifier, dvdPlayer, screen<span style="color: #268bd2;">)</span>;

        homeTheaterFacade.watchMovie<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Amplifier is on                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">DVD player is on                               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Screen is on, enjoy the movie                  //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-8" class="outline-3">
<h3 id="sec-7-8">Facade Pattern defined</h3>
<div class="outline-text-3" id="text-7-8">
<ul class="org-ul">
<li>facade pattern非常直接,定义如下
<pre class="example">
The Facade Pattern provides a unified interface to a set of interfaces
in a subsystem. Facade defines a higher-level interface that makes the
subsystem easier to use
</pre>
</li>
<li>如果我们从一个更大的视角,我们会看到如下结构:我们隐藏了Facade后面的信息

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/facade-subsystem.png" alt="facade-subsystem.png" />
</p>
<p><span class="figure-number">Figure 27:</span> facade-subsystem.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-9" class="outline-3">
<h3 id="sec-7-9">The Principle of Least Knowledge</h3>
<div class="outline-text-3" id="text-7-9">
<ul class="org-ul">
<li>facade的设计其实蕴含了一条design principle
<pre class="example">
Principle of Least Knowledge - talk only to your immediate friends
</pre>
</li>
<li>这条principle告诉我们,当我们设计一个系统的时候, 要注意和其interact的class的
数目. 这个数目能够小的话,尽量小.这样在系统变动的时候,会造成最小的影响.
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">Chapter 8: the Template Method Pattern: Encapsulating Algorithms</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">It's time for some more cafeine</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>咖啡和茶是很多人的生活必备,它们除了都含有咖啡因以外,在制作方法上面也很类似:
<ul class="org-ul">
<li>对于咖啡:
<ol class="org-ol">
<li>Boil some water
</li>
<li>Brew coffee in boiling water
</li>
<li>Pour coffee in cup
</li>
<li>Add sugar and milk
</li>
</ol>
</li>
<li>对于茶:
<ol class="org-ol">
<li>Boil some water
</li>
<li>Brew tea in boiling water
</li>
<li>Pour tea in cup
</li>
<li>Add lemon
</li>
</ol>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">Whipping up some coffee and tea classes</h3>
<div class="outline-text-3" id="text-8-2">
<ul class="org-ul">
<li>如果我们把上面的步骤写成代码的话,你会发现,也很相似
<ul class="org-ul">
<li>对于咖啡:
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Coffee</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepareRecipe</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        boilWater<span style="color: #268bd2;">()</span>;
        brewCoffeeGrinds<span style="color: #268bd2;">()</span>;
        pourInCup<span style="color: #268bd2;">()</span>;
        addSugarAndMilk<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">boilWater</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Boling water"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brewCoffeeGrinds</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dripping Coffee through filter"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pourInCup</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Pouring into cup"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addSugarAndMilk</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adding Sugar and Milk"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>对于茶
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Tea</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepareRecipe</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        boilWater<span style="color: #268bd2;">()</span>;
        steepTeaBag<span style="color: #268bd2;">()</span>;
        pourInCup<span style="color: #268bd2;">()</span>;
        addLemon<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">boilWater</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Boiling water"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">steepTeaBag</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Steeping the tea"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addLemon</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adding Lemon"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pourInCup</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Pouring into cup"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3">Sir, may I abstract your Coffee, Tea?</h3>
<div class="outline-text-3" id="text-8-3">
<ul class="org-ul">
<li>最直观的感受就是Tea和Coffee里面的boilWater()和pourInCup()是可以提取出来的,
因为它们完全一致. 然后prepareRecipe()就必须设置为abstract函数了,因为其内部
并不是所有函数都能够在base class里面确定.如下图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/straightforward-abstract.png" alt="straightforward-abstract.png" />
</p>
<p><span class="figure-number">Figure 28:</span> straightforward-abstract.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4">Taking the design further..</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li>如果我们更进一步的观察的话会发现:
<ul class="org-ul">
<li>brewCoffeeGrinds()和steepTeaBag()是一回事: 都是把原料准备好
</li>
<li>addSugarAndMilk()和addLemon()更是一回事: 都是添加调味料,只是调味料不同而已
</li>
</ul>
</li>
<li>如果能把这两者抽象成base class里面的相同函数(区别在sub class里面进行指定),
那么我们的prepareReceipe就可以在base class里面实现, 而sub class也就不需要对
其进行扩展了.
</li>
<li>这种把一个步骤(或者说算法)集合在一个base class函数里面让subclass使用的方法
就是 template method pattern. 类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/template-abstract.png" alt="template-abstract.png" />
</p>
<p><span class="figure-number">Figure 29:</span> template-abstract.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5">The implementation code</h3>
<div class="outline-text-3" id="text-8-5">
<ul class="org-ul">
<li>首先是base class, 这里面prepareRecipe()是final的,因为我们不想让subclass去改
动我们的算法. 我们能确定的函数比如boilWater()也实现在了base class,不能确定的
函数比如brew(), 我们设计成abstract class,让subclass去实现
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">cofeetea</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CaffeineBeverage</span> <span style="color: #2aa198;">{</span>

    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepareRecipe</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        boilWater<span style="color: #268bd2;">()</span>;
        brew<span style="color: #268bd2;">()</span>;
        pourInCup<span style="color: #268bd2;">()</span>;
        addCondiments<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brew</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addCondiments</span><span style="color: #b58900;">()</span>;
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">boilWater</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Boiling water"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pourInCup</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Pouring into cup"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Coffee函数如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">cofeetea</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Coffee</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">CaffeineBeverage</span> <span style="color: #2aa198;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brew</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dripping Coffee through filter"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addCondiments</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adding Sugar and Milk"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Tea函数如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">cofeetea</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Tea</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">CaffeineBeverage</span> <span style="color: #2aa198;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brew</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Steeping the tea"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addCondiments</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adding Lemon"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试函数如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">cofeetea</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Tea</span> <span style="color: #268bd2;">tea</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Tea</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">Coffee</span> <span style="color: #268bd2;">coffee</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Coffee</span><span style="color: #268bd2;">()</span>;

        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--------Tea---------------------"</span><span style="color: #268bd2;">)</span>;
        tea.prepareRecipe<span style="color: #268bd2;">()</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--------Coffee------------------"</span><span style="color: #268bd2;">)</span>;
        coffee.prepareRecipe<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--------Tea---------------------               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Boiling water                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Steeping the tea                               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pouring into cup                               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Adding Lemon                                   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--------Coffee------------------               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Boiling water                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Dripping Coffee through filter                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pouring into cup                               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Adding Sugar and Milk                          //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6">Meet the Template Method</h3>
<div class="outline-text-3" id="text-8-6">
<ul class="org-ul">
<li>前面我们实现的就是一个template method pattern啦, 总体上来说
<pre class="example">
The Template Method defines the steps of an algorithm and allows
subclasses to provoie the implementation for one or more steps
</pre>
</li>
<li>下面一个图详尽的解释了这句话

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/meet-template-method.png" alt="meet-template-method.png" />
</p>
<p><span class="figure-number">Figure 30:</span> meet-template-method</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7">Template Method Pattern defined</h3>
<div class="outline-text-3" id="text-8-7">
<ul class="org-ul">
<li>照旧,我们还是对template有一个定义,但远不如上面的图和解释清楚
<pre class="example">
The Template Method Pattern defines the skeleton of an algorithm in a
method, deferring some steps to subclasses. Template Method lets
subclasses redefine certain steps of an algorithm without changing
the algorithm's structure.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-8" class="outline-3">
<h3 id="sec-8-8">Hooked on Template Method</h3>
<div class="outline-text-3" id="text-8-8">
<ul class="org-ul">
<li>template method有一个扩展,叫做"hook",就是在abstract base class里面提供一个
method, 但是这个method内部没有实现(或者是default实现):
<ul class="org-ul">
<li>如果subclass想更改一部分的Algorithm的话,可以选择override这个函数
</li>
<li>如果subclass不想更改Algorithm的话,那么不用去管这个函数
</li>
</ul>
</li>
<li>下面就是一个带有hook的template method实现, customerWantsCondiments就是那个
hook
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">coffeeteawithhook</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CaffeineBeverageWithHook</span> <span style="color: #2aa198;">{</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">prepareRecipe</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        boilWater<span style="color: #268bd2;">()</span>;
        brew<span style="color: #268bd2;">()</span>;
        pourInCoup<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>customerWantsCondiments<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            addCondiments<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brew</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addCondiments</span><span style="color: #b58900;">()</span>;

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">boilWater</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Boiling water"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pourInCoup</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Pouring into cup"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">customerWantsCondiments</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>如果你想使用hook的话,就要override函数customerWantsCondiments
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">coffeeteawithhook</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">BufferedReader</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">IOException</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">InputStreamReader</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CoffeeWithHook</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">CaffeineBeverageWithHook</span> <span style="color: #2aa198;">{</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">brew</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dripping Coffee through filter"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addCondiments</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Adding Sugar and Milk"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">customerWantsCondiments</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">String</span> <span style="color: #268bd2;">answer</span> = getUserInput<span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>answer.toLowerCase<span style="color: #6c71c4;">()</span>.startsWith<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"y"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getUserInput</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">String</span> <span style="color: #268bd2;">answer</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;

        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Would you like milk and sugar with your coffee (y/n)"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">BufferedReader</span> <span style="color: #268bd2;">in</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">BufferedReader</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">InputStreamReader</span><span style="color: #6c71c4;">(</span>System.in<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;

        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            answer = in.readLine<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">IOException</span> <span style="color: #268bd2;">ioe</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.err.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"IO error trying to read your answer"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>answer == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"no"</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> answer;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们来看看测试代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">coffeeteawithhook</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">TeaWithHook</span> <span style="color: #268bd2;">teaWithHook</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">TeaWithHook</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">CoffeeWithHook</span> <span style="color: #268bd2;">coffeeWithHook</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CoffeeWithHook</span><span style="color: #268bd2;">()</span>;

        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--------Tea---------------------"</span><span style="color: #268bd2;">)</span>;
        teaWithHook.prepareRecipe<span style="color: #268bd2;">()</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--------Coffee------------------"</span><span style="color: #268bd2;">)</span>;
        coffeeWithHook.prepareRecipe<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">//////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--------Tea---------------------                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Boiling water                                        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Steeping the tea                                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pouring into cup                                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Would you like lemon with your coffee (y/n)          //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">n                                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">--------Coffee------------------                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Boiling water                                        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Dripping Coffee through filter                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pouring into cup                                     //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Would you like milk and sugar with your coffee (y/n) //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">y                                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Adding Sugar and Milk                                //</span>
<span style="color: #93a1a1;">//////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-9" class="outline-3">
<h3 id="sec-8-9">The Holywood Principls</h3>
<div class="outline-text-3" id="text-8-9">
<ul class="org-ul">
<li>Template method with hook的例子,用到了一个新的design pattern: Hollywood Principle
<pre class="example">
The Hollywood Principle: Don't call us, we'll call you
</pre>
</li>
<li>这句话在我们的例子里面是base class (CaffeineBeverageWithHook) 对 subclass
(CoffeeWithHook)说的:
<ul class="org-ul">
<li>首先,你不要调用我,那会产生复杂的调用依赖
</li>
<li>其次,我给了你在Algorithm里面的hook(你可以选择override这个hook),所以肯定会
调用hook函数的,如果你override了这个函数,那么也就可以说,我调用了你.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-10" class="outline-3">
<h3 id="sec-8-10">Template Methods in the JDK</h3>
<div class="outline-text-3" id="text-8-10">
<ul class="org-ul">
<li>JDK中又很多处用到了Template Method with hook, 比如排序. 我们先看下面的例子:
<ul class="org-ul">
<li>首先是排序代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">sort</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Arrays</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Duck</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">ducks</span> = <span style="color: #268bd2;">{</span>
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Daffy"</span>, 8<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Dewey"</span>, 1<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Howard"</span>, 7<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Louie"</span>, 2<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Donald"</span>, 10<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Duck</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Huy"</span>, 2<span style="color: #6c71c4;">)</span>
        <span style="color: #268bd2;">}</span>;

        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Before sorting:"</span><span style="color: #268bd2;">)</span>;
        display<span style="color: #268bd2;">(</span>ducks<span style="color: #268bd2;">)</span>;

        Arrays.sort<span style="color: #268bd2;">(</span>ducks<span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nAfter sorting:"</span><span style="color: #268bd2;">)</span>;
        display<span style="color: #268bd2;">(</span>ducks<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">display</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Duck</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">ducks</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; ducks.<span style="color: #b58900;">length</span>; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span>ducks<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">///////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt;    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Before sorting:                                   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Daffy weights        8                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Dewey weights        1                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Howard weights       7                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Louie weights        2                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Donald weights       10                           //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Huy weights      2                                //</span>
<span style="color: #93a1a1;">//                                                   </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">After sorting:                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Dewey weights        1                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Louie weights        2                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Huy weights      2                                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Howard weights       7                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Daffy weights        8                            //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Donald weights       10                           //</span>
<span style="color: #93a1a1;">///////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
<li>我们知道,如果你想要完成上面的排序, 得让Duck override compareTo.对了,这个
compareTo就是hook method
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch8.template.<span style="color: #268bd2; font-weight: bold;">sort</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Duck</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Comparable</span><span style="color: #2aa198;">&lt;</span><span style="color: #b58900;">Duck</span><span style="color: #2aa198;">&gt;</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">weight</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Duck</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">int</span> <span style="color: #268bd2;">weight</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.weight = weight;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name + <span style="color: #2aa198;">" weights     \t"</span> + weight;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">compareTo</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Duck</span> <span style="color: #268bd2;">otherDuck</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span>.weight &lt; otherDuck.<span style="color: #b58900;">weight</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> -1;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span>.weight == otherDuck.weight<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> 0;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> 1;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
<li>例子中的Arrays.sort里面就蕴含了hook:
<ul class="org-ul">
<li>首先Arrays.sort源代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">sort</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">Object</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">a</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>LegacyMergeSort.userRequested<span style="color: #b58900;">)</span>
        legacyMergeSort<span style="color: #b58900;">(</span>a<span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">else</span>
        ComparableTimSort.sort<span style="color: #b58900;">(</span>a<span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>然后legacyMergeSort代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">legacyMergeSort</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">Object</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">a</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Object</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">aux</span> = a.clone<span style="color: #b58900;">()</span>;
    mergeSort<span style="color: #b58900;">(</span>aux, a, 0, a.length, 0<span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>mergeSort的代码如下,终于看到了hook compareTo
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">mergeSort</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">Object</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">src</span>,
                              <span style="color: #b58900;">Object</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">dest</span>,
                              <span style="color: #b58900;">int</span> <span style="color: #268bd2;">low</span>,
                              <span style="color: #b58900;">int</span> <span style="color: #268bd2;">high</span>,
                              <span style="color: #b58900;">int</span> <span style="color: #268bd2;">off</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">length</span> = high - low;

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Insertion sort on smallest arrays</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>length &lt; <span style="color: #b58900;">INSERTIONSORT_THRESHOLD</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span>=low; i&lt;<span style="color: #b58900;">high</span>; i++<span style="color: #268bd2;">)</span>
            <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">j</span>=i; j&gt;low &amp;&amp;
                     <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span><span style="color: #b58900;">Comparable</span><span style="color: #859900;">)</span> dest<span style="color: #859900;">[</span>j-1<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>.compareTo<span style="color: #6c71c4;">(</span>dest<span style="color: #859900;">[</span>j<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>&gt;0; j--<span style="color: #268bd2;">)</span>
                swap<span style="color: #268bd2;">(</span>dest, j, j-1<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">return</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Recursively sort halves of dest into src</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">destLow</span>  = low;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">destHigh</span> = high;
    low  += off;
    high += off;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">mid</span> = <span style="color: #b58900;">(</span>low + high<span style="color: #b58900;">)</span> &gt;&gt;&gt; 1;
    mergeSort<span style="color: #b58900;">(</span>dest, src, low, mid, -off<span style="color: #b58900;">)</span>;
    mergeSort<span style="color: #b58900;">(</span>dest, src, mid, high, -off<span style="color: #b58900;">)</span>;

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">If list is already sorted, just copy from src to dest.  This is an</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">optimization that results in faster sorts for nearly ordered lists.</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #b58900;">Comparable</span><span style="color: #6c71c4;">)</span>src<span style="color: #6c71c4;">[</span>mid-1<span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>.compareTo<span style="color: #268bd2;">(</span>src<span style="color: #6c71c4;">[</span>mid<span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span> &lt;= 0<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        System.arraycopy<span style="color: #268bd2;">(</span>src, low, dest, destLow, length<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">return</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Merge sorted halves (now in src) into dest</span>
    <span style="color: #859900; font-weight: bold;">for</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = destLow, <span style="color: #268bd2;">p</span> = low, <span style="color: #268bd2;">q</span> = mid; i &lt; <span style="color: #b58900;">destHigh</span>; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>q &gt;= high || p &lt; <span style="color: #b58900;">mid</span> &amp;&amp; <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span><span style="color: #b58900;">Comparable</span><span style="color: #859900;">)</span>src<span style="color: #859900;">[</span>p<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>.compareTo<span style="color: #6c71c4;">(</span>src<span style="color: #859900;">[</span>q<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>&lt;=0<span style="color: #268bd2;">)</span>
            dest<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = src<span style="color: #268bd2;">[</span>p++<span style="color: #268bd2;">]</span>;
        <span style="color: #859900; font-weight: bold;">else</span>
            dest<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = src<span style="color: #268bd2;">[</span>q++<span style="color: #268bd2;">]</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
<li>Jdk HttpServlet中的service()也是一个template method的实现
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">HttpServlet</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">GenericServlet</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">protected</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">doGet</span><span style="color: #b58900;">(</span><span style="color: #b58900;">HttpServletRequest</span> <span style="color: #268bd2;">req</span>, <span style="color: #b58900;">HttpServletResponse</span> <span style="color: #268bd2;">resp</span><span style="color: #b58900;">)</span>
        <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">ServletException</span>, <span style="color: #b58900;">IOException</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">String</span> <span style="color: #268bd2;">protocol</span> = req.getProtocol<span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">String</span> <span style="color: #268bd2;">msg</span> = lStrings.getString<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"http.method_get_not_supported"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>protocol.endsWith<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"1.1"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            resp.sendError<span style="color: #6c71c4;">(</span><span style="color: #268bd2; font-weight: bold;">HttpServletResponse</span>.SC_METHOD_NOT_ALLOWED, msg<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            resp.sendError<span style="color: #6c71c4;">(</span><span style="color: #268bd2; font-weight: bold;">HttpServletResponse</span>.SC_BAD_REQUEST, msg<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">default method for doPost doPut...</span>
    <span style="color: #859900; font-weight: bold;">protected</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">service</span><span style="color: #b58900;">(</span><span style="color: #b58900;">HttpServletRequest</span> <span style="color: #268bd2;">req</span>, <span style="color: #b58900;">HttpServletResponse</span> <span style="color: #268bd2;">resp</span><span style="color: #b58900;">)</span>
        <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">ServletException</span>, <span style="color: #b58900;">IOException</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">String</span> <span style="color: #268bd2;">method</span> = req.getMethod<span style="color: #268bd2;">()</span>;

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_GET<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">long</span> <span style="color: #268bd2;">lastModified</span> = getLastModified<span style="color: #6c71c4;">(</span>req<span style="color: #6c71c4;">)</span>;
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>lastModified == -1<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">servlet doesn't support if-modified-since, no reason</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">to go through further expensive logic</span>
                doGet<span style="color: #859900;">(</span>req, resp<span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #b58900;">long</span> <span style="color: #268bd2;">ifModifiedSince</span> = req.getDateHeader<span style="color: #859900;">(</span>HEADER_IFMODSINCE<span style="color: #859900;">)</span>;
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>ifModifiedSince &lt; <span style="color: #b58900;">lastModified</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">If the servlet mod time is later, call doGet()</span>
                    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Round down to the nearest second for a proper compare</span>
                    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">A ifModifiedSince of -1 will always be less</span>
                    maybeSetLastModified<span style="color: #b58900;">(</span>resp, lastModified<span style="color: #b58900;">)</span>;
                    doGet<span style="color: #b58900;">(</span>req, resp<span style="color: #b58900;">)</span>;
                <span style="color: #859900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900;">{</span>
                    resp.setStatus<span style="color: #b58900;">(</span><span style="color: #268bd2; font-weight: bold;">HttpServletResponse</span>.SC_NOT_MODIFIED<span style="color: #b58900;">)</span>;
                <span style="color: #859900;">}</span>
            <span style="color: #6c71c4;">}</span>

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_HEAD<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">long</span> <span style="color: #268bd2;">lastModified</span> = getLastModified<span style="color: #6c71c4;">(</span>req<span style="color: #6c71c4;">)</span>;
            maybeSetLastModified<span style="color: #6c71c4;">(</span>resp, lastModified<span style="color: #6c71c4;">)</span>;
            doHead<span style="color: #6c71c4;">(</span>req, resp<span style="color: #6c71c4;">)</span>;

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_POST<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            doPost<span style="color: #6c71c4;">(</span>req, resp<span style="color: #6c71c4;">)</span>;

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_PUT<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            doPut<span style="color: #6c71c4;">(</span>req, resp<span style="color: #6c71c4;">)</span>;

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_DELETE<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            doDelete<span style="color: #6c71c4;">(</span>req, resp<span style="color: #6c71c4;">)</span>;

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_OPTIONS<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            doOptions<span style="color: #6c71c4;">(</span>req,resp<span style="color: #6c71c4;">)</span>;

        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>method.equals<span style="color: #6c71c4;">(</span>METHOD_TRACE<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            doTrace<span style="color: #6c71c4;">(</span>req,resp<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">..</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>用户的代码总是:
<ul class="org-ul">
<li>extends HttpServlet(因为是abstract class所以只能继承了).
</li>
<li>然后override自己的doGet, doPost&#x2026;
</li>
<li>不能去override自己的service(), 因为那个是template method (所以如果service
给设计成final更好)
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">Chapter 9: the Iterator and Composite Patterns: Well-Managed Collections</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>设计一个类的时候,如果有一系列类型相同的object,一般会考虑使用容器放置, 在java
中有很多这种容器:
<ul class="org-ul">
<li>Array
</li>
<li>Stack
</li>
<li>List
</li>
<li>Hashtable
</li>
</ul>
</li>
<li>容器管理object的时候,会遇到两种特别难以处理的情况:
<ul class="org-ul">
<li>第一种情况: client可以看到我们类内部的实现, 但是client要处理很多个类,但是
这些类里面用了不同的容器. client不想为每一种容器写一套遍历代码!
</li>
<li>另外一种情况就是,类内部如何放置这些object是你设计的内部细节, 你不想为类外
部所看到. client想要遍历你们,至少你得给几个最基本的函数来让我们完成遍历
</li>
</ul>
</li>
<li>Iterator pattern就是解决上面"两种"困境的办法!
</li>
</ul>
</div>
<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">Two resturants merge</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>针对上面第一种情况,我们来说一个例子: 有两个餐馆合并了.但是两个餐馆原来各有
一套菜单系统:
<ul class="org-ul">
<li>KFC餐馆使用的是Array[]来存储menuitems
</li>
<li>MCD餐馆使用的是ArrayList来存储menuitems
</li>
</ul>
</li>
<li>大家的MenuItem定义都是一样的
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MenuItem</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">MenuItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.price = price;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2;">(</span>name + <span style="color: #2aa198;">", $"</span> + price<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>但是大家都不想更改自己的容器实现(因为那可能要破坏几年如一日正常运转的代码):
<ul class="org-ul">
<li>KFC的代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">KFCMenu</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">MAX_ITEMS</span> = 6;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">numberOfItems</span> = 0;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">menuItems</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">KFCMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        menuItems = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">[</span>MAX_ITEMS<span style="color: #268bd2;">]</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KA"</span>, 1.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KB"</span>, 2.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KC"</span>, 3.0<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">(</span>name, price<span style="color: #268bd2;">)</span>;
        menuItems<span style="color: #268bd2;">[</span>numberOfItems++<span style="color: #268bd2;">]</span> = menuItem;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>MCD的代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">ArrayList</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MCDMenu</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">ArrayList</span> <span style="color: #268bd2;">menuItems</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">MCDMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        menuItems = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #268bd2;">()</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"MA"</span>, 1.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"MB"</span>, 2.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"MC"</span>, 3.0<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">(</span>name, price<span style="color: #268bd2;">)</span>;
        menuItems.add<span style="color: #268bd2;">(</span>menuItem<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
<li>话又说回来,即便是改了容器实现, 但是把容器实现通过如下的代码"暴露"出来,也是
违反面向对象设计要求的. (这也就是上面说的"另外一种情况")
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuItem</span><span style="color: #2aa198;">[]</span> <span style="color: #268bd2;">getMenuItems</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">return</span> menuItems;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>解决的办法前面说过了,是Iterator pattern. 其接口样子如下.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #b58900;">ackage</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Iterator</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span>;
    <span style="color: #b58900;">Object</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Iterator接口概括起来就是说,如果你implements了Iterator,说明你内部必定有容器
你也会告诉我们何时结束,每次当前的内容是什么, 下面就是一个类实现Iterator的例子
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">KFCMenuIterator</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Iterator</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">items</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">position</span> = 0;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">KFCMenuIterator</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">items</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.items = items;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Object</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = items<span style="color: #268bd2;">[</span>position++<span style="color: #268bd2;">]</span>;
        <span style="color: #859900; font-weight: bold;">return</span> menuItem;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>position &gt;= items.length || items<span style="color: #6c71c4;">[</span>position<span style="color: #6c71c4;">]</span> == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们的类其实现在就可以"暴露"一个函数, 这个函数的返回值就是一个Iterator
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">KFCMenuIterator</span><span style="color: #b58900;">(</span>menuItems<span style="color: #b58900;">)</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>为了让这个接口看起来更专业,我们设计了一个Menu interface, 让我们的类来implements
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">Menu</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>现在KFCmenu是这个样子
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">KFCMenu</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Menu</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">MAX_ITEMS</span> = 6;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">numberOfItems</span> = 0;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">menuItems</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">KFCMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        menuItems = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">[</span>MAX_ITEMS<span style="color: #268bd2;">]</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KA"</span>, 1.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KB"</span>, 2.0<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KC"</span>, 3.0<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">(</span>name, price<span style="color: #268bd2;">)</span>;
        menuItems<span style="color: #268bd2;">[</span>numberOfItems++<span style="color: #268bd2;">]</span> = menuItem;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">KFCMenuIterator</span><span style="color: #268bd2;">(</span>menuItems<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>waitress就是使用我们类的client code. 它想遍历容器的话,那么它只需要talk to
Iterator和Menu这两个接口就可以了.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Waitress</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">kfcMenu</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">mcdMenu</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Waitress</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">kfcMenu</span>, <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">mcdMenu</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.kfcMenu = kfcMenu;
        <span style="color: #859900; font-weight: bold;">this</span>.mcdMenu = mcdMenu;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"KFC--------&gt;"</span><span style="color: #268bd2;">)</span>;
        printMenuWithIterator<span style="color: #268bd2;">(</span>kfcMenu.createIterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"MCD--------&gt;"</span><span style="color: #268bd2;">)</span>;
        printMenuWithIterator<span style="color: #268bd2;">(</span>mcdMenu.createIterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenuWithIterator</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">iterator</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span>iterator.hasNext<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #6c71c4;">(</span><span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">)</span>iterator.next<span style="color: #6c71c4;">()</span>;
            System.out.println<span style="color: #6c71c4;">(</span>menuItem.toString<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.<span style="color: #268bd2; font-weight: bold;">iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">KFCMenu</span> <span style="color: #268bd2;">kfcMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">KFCMenu</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">MCDMenu</span> <span style="color: #268bd2;">mcdMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MCDMenu</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">Waitress</span> <span style="color: #268bd2;">waitress</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Waitress</span><span style="color: #268bd2;">(</span>kfcMenu, mcdMenu<span style="color: #268bd2;">)</span>;
        waitress.printMenu<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">KFC--------&gt;                                   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">KA, $1.0                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">KB, $2.0                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">KC, $3.0                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">MCD--------&gt;                                   //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">MA, $1.0                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">MB, $2.0                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">MC, $3.0                                       //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
<li>总体的类图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/menu-iterator.png" alt="menu-iterator.png" />
</p>
<p><span class="figure-number">Figure 31:</span> menu-iterator</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">Use java's Iterator</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li>java 提供了内置的Iterator, 并且在巨大多数的容器(主要是Collection接口里面定
义了的iterator())里面实现了返回一个iterator的函数iterator(), 所以比如用
ArrayList这种大路边的容器来实现我们的例子,就很简单了
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">ArrayList</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">BreakfastMenu</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Menu</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">menuItems</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">BreakfastMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        menuItems = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">&gt;()</span>;

        menuItems.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Pancake"</span>, 2.99<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        menuItems.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Waffles"</span>, 3.59<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Notice here!!</span>
        <span style="color: #859900; font-weight: bold;">return</span> menuItems.iterator<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>如果是hashmap这种结构,我们也可以"只返回value的iterator"
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">HashMap</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">LunchMenu</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Menu</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">HashMap</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">String</span>, <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">map</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">HashMap</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">String</span>, <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;()</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">LunchMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Veggie"</span>, 3.99<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Burrito"</span>, 4.29<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">(</span>name, price<span style="color: #268bd2;">)</span>;
        map.put<span style="color: #268bd2;">(</span>menuItem.getName<span style="color: #6c71c4;">()</span>, menuItem<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">only the values' iterator are return</span>
        <span style="color: #859900; font-weight: bold;">return</span> map.values<span style="color: #268bd2;">()</span>.iterator<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>如果是Array这种结构,那么没有iterator(),那么我们得自己"implements"一个Iterator
然后返回
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">DinerMenuIterator</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Iterator</span><span style="color: #2aa198;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #2aa198;">&gt;</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">list</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">position</span> = 0;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">DinerMenuIterator</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">list</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.list = list;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> list<span style="color: #268bd2;">[</span>position++<span style="color: #268bd2;">]</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>position &gt;= list.length || list<span style="color: #6c71c4;">[</span>position<span style="color: #6c71c4;">]</span> == <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>position &lt;= 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">throw new Exception("You can't remove an item until you've at least one next()");</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>list<span style="color: #6c71c4;">[</span>position-1<span style="color: #6c71c4;">]</span> != <span style="color: #268bd2; font-weight: bold;">null</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = position - 1; i &lt; <span style="color: #859900;">(</span>list.length - 1<span style="color: #859900;">)</span>; i++<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                list<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> = list<span style="color: #859900;">[</span>i+1<span style="color: #859900;">]</span>;
            <span style="color: #6c71c4;">}</span>
            list<span style="color: #6c71c4;">[</span>list.length<span style="color: #6c71c4;">]</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>使用这个Iterator的例子
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">DinerMenu</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Menu</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">MAX_ITEMS</span> = 6;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">numberOfItems</span> = 0;
    <span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">[]</span> <span style="color: #268bd2;">menuItems</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">DinerMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        menuItems = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">[</span>MAX_ITEMS<span style="color: #268bd2;">]</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Hotdog"</span>, 3.05<span style="color: #268bd2;">)</span>;
        addItem<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Pasta"</span>, 3.89<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">addItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">(</span>name, price<span style="color: #268bd2;">)</span>;
        menuItems<span style="color: #268bd2;">[</span>numberOfItems++<span style="color: #268bd2;">]</span> = menuItem;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">DinerMenuIterator</span><span style="color: #268bd2;">(</span>menuItems<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>waitress的代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Waitress</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">breakfastMenu</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">lunchMenu</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">dinerMenu</span>;



    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Waitress</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">breakfastMenu</span>, <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">lunchMenu</span>, <span style="color: #b58900;">Menu</span> <span style="color: #268bd2;">dinerMenu</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.breakfastMenu = breakfastMenu;
        <span style="color: #859900; font-weight: bold;">this</span>.lunchMenu = lunchMenu;
        <span style="color: #859900; font-weight: bold;">this</span>.dinerMenu = dinerMenu;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Breakfast--------"</span><span style="color: #268bd2;">)</span>;
        printMenuWithIterator<span style="color: #268bd2;">(</span>breakfastMenu.createIterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Lunch------------"</span><span style="color: #268bd2;">)</span>;
        printMenuWithIterator<span style="color: #268bd2;">(</span>lunchMenu.createIterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Diner------------"</span><span style="color: #268bd2;">)</span>;
        printMenuWithIterator<span style="color: #268bd2;">(</span>dinerMenu.createIterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenuWithIterator</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Iterator</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuItem</span><span style="color: #268bd2;">&gt;</span> <span style="color: #268bd2;">iterator</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span>iterator.hasNext<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">MenuItem</span> <span style="color: #268bd2;">menuItem</span> = iterator.next<span style="color: #6c71c4;">()</span>;
            System.out.print<span style="color: #6c71c4;">(</span>menuItem.getName<span style="color: #859900;">()</span> + <span style="color: #2aa198;">", "</span><span style="color: #6c71c4;">)</span>;
            System.out.print<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"$"</span> + menuItem.getPrice<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
            System.out.println<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.iterator.<span style="color: #268bd2; font-weight: bold;">jdk</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">BreakfastMenu</span> <span style="color: #268bd2;">breakfastMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">BreakfastMenu</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">LunchMenu</span> <span style="color: #268bd2;">lunchMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LunchMenu</span><span style="color: #268bd2;">()</span>;
        <span style="color: #b58900;">DinerMenu</span> <span style="color: #268bd2;">dinerMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">DinerMenu</span><span style="color: #268bd2;">()</span>;

        <span style="color: #b58900;">Waitress</span> <span style="color: #268bd2;">waitress</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Waitress</span><span style="color: #268bd2;">(</span>breakfastMenu, lunchMenu, dinerMenu<span style="color: #268bd2;">)</span>;
        waitress.printMenu<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Breakfast--------                              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pancake, $2.99                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Waffles, $3.59                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Lunch------------                              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Veggie, $3.99                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Burrito, $4.29                                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Diner------------                              //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Hotdog, $3.05                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Pasta, $3.89                                   //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">Iterator Pattern defined</h3>
<div class="outline-text-3" id="text-9-3">
<ul class="org-ul">
<li>好了,又到了定义的时间
<pre class="example">
The Iterator Pattern provides a way to access the elements of an aggregate
object sequentially without exposing its underlying representation
</pre>
</li>
<li>Iterator的广泛应用有很重要的意义, 这意味着你可以写一份的代码但是却能在很多
种的aggregate容器中运行.
</li>
<li>Iterator Pattern另外一个重要的影响是,把"遍历"这个行为的责任,从"aggregate
object"转移到iterator object.这样使得"aggregate object"能够更加专注于自己份
内的工作.
</li>
<li>下面就是Iterator Pattern的类图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/iterator.png" alt="iterator.png" />
</p>
<p><span class="figure-number">Figure 32:</span> iterator.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4">Single Responsibility</h3>
<div class="outline-text-3" id="text-9-4">
<ul class="org-ul">
<li>前面说了, 把aggregae object的"遍历责任"拿掉,让它专注于自己的工作.子所以这样
做是为了让某个class"只为一个原因而改动", 如果我们的aggregae object还需要考
虑遍历, 那么:
<ul class="org-ul">
<li>如果collection改变,那么我们的aggregate object要改变
</li>
<li>如果我们遍历的方法改变, 那么我们的aggregate object也要改变.
</li>
</ul>
</li>
<li>所以,最好的处理方式是让某一个class只有一个responsibility.
<pre class="example">
A class should have only one reaseon to change.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5">Iterators and Collections</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li>Java中的Iterator能够轻松使用原因在于大多数的容器都实现了java.util.Collection
interface, 这个interface有很多很有用的method
<pre class="example">
+------------------+
|   &lt;&lt;interface&gt;&gt;  |
|   Collection     |
+------------------+
| add()            |
| addAll()         |
| clear()          |
| contains()       |
| equals()         |
| hashCode()       |
| isEmpty()        |
| iterator()       |
| remove()         |
| removeAll()      |
| retainAll()      |
| size()           |
| toArray()        |
|                  |
+------------------+
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6">New problem raised</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>现在我们遇到了新问题: 如果我们的菜单下面不仅仅是item,还可能有子菜单,那我们
改如何显示.
</li>
<li>问题如下(其实在python, ruby中,这都不算事儿,因为array里面的成员不需要类型一
致):

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/new-problem.png" alt="new-problem.png" />
</p>
<p><span class="figure-number">Figure 33:</span> new-problem.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-7" class="outline-3">
<h3 id="sec-9-7">The Composite Pattern defined</h3>
<div class="outline-text-3" id="text-9-7">
<ul class="org-ul">
<li>在java中,解决的办法就是composite pattern啦, 其定义如下
<pre class="example">
The Composite Pattern allows you to compose objects into tree
structures to represent part-whole hierarchies. Composite lets
clients treat individual objects and composition of objects
uniformly
</pre>
</li>
<li>其实重点就是最后一句, client代码对待一下两者是公平的:
<ul class="org-ul">
<li>individual object
</li>
<li>composition of objects
</li>
</ul>
</li>
<li>如何公平对待这两者呢:继承共同的接口.

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/composite.png" alt="composite.png" />
</p>
<p><span class="figure-number">Figure 34:</span> composite.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-8" class="outline-3">
<h3 id="sec-9-8">Designing Menus with Composite</h3>
<div class="outline-text-3" id="text-9-8">
<ul class="org-ul">
<li>让我们来看看上面的Menu的例子的类图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/menu-composite.png" alt="menu-composite.png" />
</p>
<p><span class="figure-number">Figure 35:</span> menu-composite.png</p>
</div>
</li>
<li>代码入下:
<ul class="org-ul">
<li>共同的接口(使用了abstract class)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menu</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">add</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">menuComponent</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">menuComponent</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">getChild</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">double</span> <span style="color: #268bd2;">getPrice</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">isVegetarian</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">print</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>叶子节点MenuItem
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menu</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MenuItem</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;
    <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">vegetarian</span>;
    <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span>;

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> description;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">isVegetarian</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> vegetarian;
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">double</span> <span style="color: #268bd2;">getPrice</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> price;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">MenuItem</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>,
                    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>,
                    <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">vegetarian</span>,
                    <span style="color: #b58900;">double</span> <span style="color: #268bd2;">price</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
        <span style="color: #859900; font-weight: bold;">this</span>.vegetarian = vegetarian;
        <span style="color: #859900; font-weight: bold;">this</span>.price = price;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">print</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">" "</span> + getName<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>isVegetarian<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.print<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"(v),"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        System.out.println<span style="color: #268bd2;">(</span>getPrice<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"&gt;&gt;-- "</span> + getDescription<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>composite节点Menu
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menu</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">ArrayList</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Menu</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">menuComponents</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #b58900;">&gt;()</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Menu</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">add</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">menuComponent</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        menuComponents.add<span style="color: #268bd2;">(</span>menuComponent<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">menuComponent</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        menuComponents.remove<span style="color: #268bd2;">(</span>menuComponent<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">getChild</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">MenuComponent</span><span style="color: #268bd2;">)</span>menuComponents.get<span style="color: #268bd2;">(</span>i<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getDescription</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> description;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">print</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.print<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\n"</span> + getName<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">", "</span> + getDescription<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"-------------------------"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">Iterator</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #268bd2;">&gt;</span> <span style="color: #268bd2;">iterator</span> = menuComponents.iterator<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span>iterator.hasNext<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            iterator.next<span style="color: #6c71c4;">()</span>.print<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Client代码Waitress
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menu</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Waitress</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Waitress</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.allMenus = allMenus;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        allMenus.print<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menu</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">breakfastMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Breakfast"</span>, <span style="color: #2aa198;">"Breakfast"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">lunchMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Lunch"</span>, <span style="color: #2aa198;">"Lunch"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">dinnerMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dinner"</span>, <span style="color: #2aa198;">"Dinner"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">dessertMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dessert"</span>, <span style="color: #2aa198;">"Dessert menu is sub menu of Dinner"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"All"</span>, <span style="color: #2aa198;">"All menus combined"</span><span style="color: #268bd2;">)</span>;

        allMenus.add<span style="color: #268bd2;">(</span>breakfastMenu<span style="color: #268bd2;">)</span>;
        allMenus.add<span style="color: #268bd2;">(</span>lunchMenu<span style="color: #268bd2;">)</span>;
        allMenus.add<span style="color: #268bd2;">(</span>dinnerMenu<span style="color: #268bd2;">)</span>;

        breakfastMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Pancake"</span>,
                <span style="color: #2aa198;">"scrambled eggs"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                2.99<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        breakfastMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Regular Pancake"</span>,
                <span style="color: #2aa198;">"eggs, sausage"</span>,
                <span style="color: #268bd2; font-weight: bold;">false</span>,
                2.99<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        lunchMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"HotDo"</span>,
                <span style="color: #2aa198;">"hot dog, with cheese"</span>,
                <span style="color: #268bd2; font-weight: bold;">false</span>,
                3.05<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        dinnerMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Burrito"</span>,
                <span style="color: #2aa198;">"A large burrito, with whole pinto beans"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                4.29<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        dessertMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Sorbet"</span>,
                <span style="color: #2aa198;">"A scoop of raspberry and a scoop of lime"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                1.89<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;

        dinnerMenu.add<span style="color: #268bd2;">(</span>dessertMenu<span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">Waitress</span> <span style="color: #268bd2;">waitress</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Waitress</span><span style="color: #268bd2;">(</span>allMenus<span style="color: #268bd2;">)</span>;
        waitress.printMenu<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-9" class="outline-3">
<h3 id="sec-9-9">Flashback to Iterator</h3>
<div class="outline-text-3" id="text-9-9">
<ul class="org-ul">
<li>我们前面的代码也用到了Iterator, 但是是Menu或者MenuItem内部使用了这个Iterator
来进行遍历. 但是Iterator pattern的"原意"是要让client代码(也就是这里的waitress)
能够遍历所有内部元素
</li>
<li>下面就是让这个既使用Composite pattern,也使用Iterator pattern的代码:
<ul class="org-ul">
<li>首先就是让MenuComponent接口有一个createIterator()函数
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">abstract</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>MenuItem是没法返回一个iterator的,因为它内部没有容器
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MenuItem</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">...</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NullIterator</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>NullIterator 类的定义如下(意思是永远不会有下一个的iterator)
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menuiterator</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NullIterator</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Iterator</span><span style="color: #2aa198;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #2aa198;">&gt;</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">null</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>和MenuItem对应的是Menu, 它也继承MenuComponent,但是它含有容器,所以它要返回
一个"真的iterator"
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Menu</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">menuComponents</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ArrayList</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #b58900;">&gt;()</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Menu</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">description</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.description = description;
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
    <span style="color: #268bd2; font-weight: bold;">@Override</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">createIterator</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">CompositeIterator</span><span style="color: #268bd2;">(</span>menuComponents.iterator<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>返回的CompositeIterator是我们新创建的,要应付Menu里面还有Menu这种逻辑的Iterator
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menuiterator</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.*;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">CompositeIterator</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">Iterator</span><span style="color: #2aa198;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #2aa198;">&gt;</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">Stack</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">Iterator</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #268bd2;">&gt;</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">stack</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Stack</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">Iterator</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #268bd2;">&gt;</span><span style="color: #b58900;">&gt;()</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">CompositeIterator</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Iterator</span> <span style="color: #268bd2;">iterator</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        stack.push<span style="color: #268bd2;">(</span>iterator<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">next</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>hasNext<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">Iterator</span><span style="color: #6c71c4;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #6c71c4;">&gt;</span> <span style="color: #268bd2;">iterator</span> = stack.peek<span style="color: #6c71c4;">()</span>;
            <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">component</span> = <span style="color: #6c71c4;">(</span><span style="color: #b58900;">MenuComponent</span><span style="color: #6c71c4;">)</span>iterator.next<span style="color: #6c71c4;">()</span>;
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>component <span style="color: #859900; font-weight: bold;">instanceof</span> Menu<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                stack.push<span style="color: #859900;">(</span>component.createIterator<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">return</span> component;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">hasNext</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>stack.empty<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">false</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">Iterator</span><span style="color: #6c71c4;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #6c71c4;">&gt;</span> <span style="color: #268bd2;">iterator</span> = stack.peek<span style="color: #6c71c4;">()</span>;
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900; font-weight: bold;">!</span>iterator.hasNext<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                stack.pop<span style="color: #859900;">()</span>;
                <span style="color: #859900; font-weight: bold;">return</span> hasNext<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #268bd2; font-weight: bold;">true</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">remove</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">throw</span> <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UnsupportedOperationException</span><span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>现在我们的waitress就可以遍历容器里面的内容,然后判断是不是蔬菜,是的话,才会
打印.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menuiterator</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Iterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Waitress</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Waitress</span><span style="color: #b58900;">(</span><span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.allMenus = allMenus;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        allMenus.print<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">printVegetarianMenu</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Iterator</span><span style="color: #268bd2;">&lt;</span><span style="color: #b58900;">MenuComponent</span><span style="color: #268bd2;">&gt;</span> <span style="color: #268bd2;">iterator</span> = allMenus.createIterator<span style="color: #268bd2;">()</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nVEGETARIAN MENU\n"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span>iterator.hasNext<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">menuComponent</span> = iterator.next<span style="color: #6c71c4;">()</span>;
            <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>menuComponent.isVegetarian<span style="color: #b58900;">()</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                    menuComponent.print<span style="color: #b58900;">()</span>;
                <span style="color: #859900;">}</span>
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">UnsupportedOperationException</span> <span style="color: #268bd2;">e</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">do nothing here, we just igore, as Menu object does throw</span>
                <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">UnsupportedOperationException when calling isVegetarian</span>
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch9.composite.<span style="color: #268bd2; font-weight: bold;">menuiterator</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">breakfastMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Breakfast"</span>, <span style="color: #2aa198;">"Breakfast"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">lunchMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Lunch"</span>, <span style="color: #2aa198;">"Lunch"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">dinnerMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dinner"</span>, <span style="color: #2aa198;">"Dinner"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">dessertMenu</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Dessert"</span>, <span style="color: #2aa198;">"Dessert menu is sub menu of Dinner"</span><span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">MenuComponent</span> <span style="color: #268bd2;">allMenus</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Menu</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"All"</span>, <span style="color: #2aa198;">"All menus combined"</span><span style="color: #268bd2;">)</span>;

        allMenus.add<span style="color: #268bd2;">(</span>breakfastMenu<span style="color: #268bd2;">)</span>;
        allMenus.add<span style="color: #268bd2;">(</span>lunchMenu<span style="color: #268bd2;">)</span>;
        allMenus.add<span style="color: #268bd2;">(</span>dinnerMenu<span style="color: #268bd2;">)</span>;

        breakfastMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Pancake"</span>,
                <span style="color: #2aa198;">"scrambled eggs"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                2.99<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        breakfastMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Regular Pancake"</span>,
                <span style="color: #2aa198;">"eggs, sausage"</span>,
                <span style="color: #268bd2; font-weight: bold;">false</span>,
                2.99<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        lunchMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"HotDo"</span>,
                <span style="color: #2aa198;">"hot dog, with cheese"</span>,
                <span style="color: #268bd2; font-weight: bold;">false</span>,
                3.05<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        dinnerMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Burrito"</span>,
                <span style="color: #2aa198;">"A large burrito, with whole pinto beans"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                4.29<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;
        dessertMenu.add<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">MenuItem</span><span style="color: #6c71c4;">(</span>
                <span style="color: #2aa198;">"Sorbet"</span>,
                <span style="color: #2aa198;">"A scoop of raspberry and a scoop of lime"</span>,
                <span style="color: #268bd2; font-weight: bold;">true</span>,
                1.89<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>;

        dinnerMenu.add<span style="color: #268bd2;">(</span>dessertMenu<span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">Waitress</span> <span style="color: #268bd2;">waitress</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Waitress</span><span style="color: #268bd2;">(</span>allMenus<span style="color: #268bd2;">)</span>;
        waitress.printVegetarianMenu<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">VEGETARIAN MENU                                //</span>
<span style="color: #93a1a1;">//                                                </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">//  </span><span style="color: #93a1a1;">Pancake                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">(v),2.99                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&gt;&gt;-- scrambled eggs                            //</span>
<span style="color: #93a1a1;">//  </span><span style="color: #93a1a1;">Burrito                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">(v),4.29                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&gt;&gt;-- A large burrito, with whole pinto beans   //</span>
<span style="color: #93a1a1;">//  </span><span style="color: #93a1a1;">Sorbet                                        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">(v),1.89                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&gt;&gt;-- A scoop of raspberry and a scoop of lime  //</span>
<span style="color: #93a1a1;">//  </span><span style="color: #93a1a1;">Sorbet                                        //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">(v),1.89                                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&gt;&gt;-- A scoop of raspberry and a scoop of lime  //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">Chapter 10: the State Pattern: The State of Things</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>我们有个口香糖球(Gumball)售卖机, 然后有他们的state转换图如下, 希望能够有个程
序实现

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/gumball-state.png" alt="gumball-state.png" />
</p>
<p><span class="figure-number">Figure 36:</span> gumball-state.png</p>
</div>
</li>
<li>如果你没有学过设计模式,那么下面的解法是很容易直接的映入脑海的.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.<span style="color: #268bd2; font-weight: bold;">state</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">GumballMachine</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">SOLD_OUT</span> = 0;
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">NO_QUARTER</span> = 1;
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">HAS_QUARTER</span> = 2;
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">SOLD</span> = 3;

    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">state</span> = SOLD_OUT;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">count</span> = 0;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">GumballMachine</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">count</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.count = count;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>count &gt; 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            state = NO_QUARTER;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">insertQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == HAS_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You can't insert another quater"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == NO_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            state = HAS_QUARTER;
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You inserted a quater"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD_OUT<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You can't insert a quater, the machine is sold out"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Please wait, we're already giving you a gumball"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">ejectQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == HAS_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Quarter returned"</span><span style="color: #6c71c4;">)</span>;
            state = NO_QUARTER;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == NO_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You haven't inserted a quarter"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Sorry, you already turned the crank"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD_OUT<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You can't eject, you haven't inserted a quarter yet"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">turnCrank</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Turning twice doesn't get you another gumball!"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == NO_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You turned but there's no quarter"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD_OUT<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You turned, but there are no gumballs"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == HAS_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You turned..."</span><span style="color: #6c71c4;">)</span>;
            state = SOLD;
            dispense<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">dispense</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"A gumball comes rolling out the slot"</span><span style="color: #6c71c4;">)</span>;
            count = count - 1;
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>count == 0<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                System.out.println<span style="color: #859900;">(</span><span style="color: #2aa198;">"Oops, out of gumballs!"</span><span style="color: #859900;">)</span>;
                state = SOLD_OUT;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">{</span>
                state = NO_QUARTER;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == NO_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"You need to pay first"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD_OUT<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"No gumball dispensed"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == HAS_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"No gumball dispensed"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">refill</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">numGumBalls</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.count = numGumBalls;
        state = NO_QUARTER;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">StringBuffer</span> <span style="color: #268bd2;">result</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">StringBuffer</span><span style="color: #268bd2;">()</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nMighty Gumball, Inc."</span><span style="color: #268bd2;">)</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nJava-enabled Standing Gumball Model #2004\n"</span><span style="color: #268bd2;">)</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Inventory: "</span> + count + <span style="color: #2aa198;">" gumball"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>count != 1<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"s"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nMachine is "</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD_OUT<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"sold out"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == NO_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"waiting for quarter"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == HAS_QUARTER<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"waiting for turn of crank"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>state == SOLD<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"delivering a gumball"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">return</span> result.toString<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
<div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">The messy State of things</h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>这种设计最大的问题,在于我们如果有了CHANGE, 比如,增加了一种新的玩法: 有10%的
可能性玩家可以花25美分得到两个球! state图如下

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/gumball-winner-state.png" alt="gumball-winner-state.png" />
</p>
<p><span class="figure-number">Figure 37:</span> gumball-winner-state.png</p>
</div>
</li>
<li>如果还是上面的解法的话,面对这种改变就显得很无力, 因为要有很多的"inside"的改
动,比如我们要设置新的static final 的state
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">GumballMachine</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">SOLD_OUT</span> = 0;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">new state</span>
    <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">WINNER</span> = 4;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">The new design</h3>
<div class="outline-text-3" id="text-10-2">
<ul class="org-ul">
<li>解决的办法自然就是我们这一章的重点, state pattern. 所谓state pattern在我看来,
就是把final static int的每一个部分都拆出来,拆成一个class. 这些class都obey一
个State interface就可以了.

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/winner.png" alt="winner.png" />
</p>
<p><span class="figure-number">Figure 38:</span> winner.png</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3">Implementing our state class</h3>
<div class="outline-text-3" id="text-10-3">
<ul class="org-ul">
<li>首先是最重要的state interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.state.<span style="color: #268bd2; font-weight: bold;">winner</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900;">State</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">insertQuarter</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">ejectQuarter</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">turnCrank</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">dispense</span><span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>老的state都implements state interface, 比如最开始的状态:NoQuarterState
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.state.<span style="color: #268bd2; font-weight: bold;">winner</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">NoQuarterState</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">State</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">NoQuarterState</span><span style="color: #b58900;">(</span><span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.gumballMachine = gumballMachine;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">insertQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"You inserted a quarter"</span><span style="color: #268bd2;">)</span>;
        gumballMachine.setState<span style="color: #268bd2;">(</span>gumballMachine.getHasQuarterState<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">ejectQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"You haven't inserted a quarter"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">turnCrank</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"You turned, but there's no quarter"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">dispense</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"You need to pay first"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"waiting for quarter"</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们需求有了改变,需要新加入一个状态的时候,直接创建一个新的类implements state
interface
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.state.<span style="color: #268bd2; font-weight: bold;">winner</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">WinnerState</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900;">State</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">WinnerState</span><span style="color: #b58900;">(</span><span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.gumballMachine = gumballMachine;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">insertQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Please wait, we're already giving you a Gumball"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">ejectQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Please wait, we're already giving you a Gumball"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">turnCrank</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Turning again doesn't get you another gumball!"</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">dispense</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"YOU'RE A WINNER! You get two gumballs for your quarter"</span><span style="color: #268bd2;">)</span>;
        gumballMachine.releaseBall<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>gumballMachine.getCount<span style="color: #6c71c4;">()</span> == 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            gumballMachine.setState<span style="color: #6c71c4;">(</span>gumballMachine.getSoldOutState<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            gumballMachine.releaseBall<span style="color: #6c71c4;">()</span>;
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>gumballMachine.getCount<span style="color: #859900;">()</span> &gt; 0<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                gumballMachine.setState<span style="color: #859900;">(</span>gumballMachine.getNoQuarterState<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">{</span>
                System.out.println<span style="color: #859900;">(</span><span style="color: #2aa198;">"Oops, out of gumballs!"</span><span style="color: #859900;">)</span>;
                gumballMachine.setState<span style="color: #859900;">(</span>gumballMachine.getSoldOutState<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"dispensing two gumballs for your quarter, because YOU'RE A WINNER!"</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>我们的GumballMachine 是使用这些state class的class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.state.<span style="color: #268bd2; font-weight: bold;">winner</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">GumballMachine</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">soldOutState</span>;
    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">noQuarterState</span>;
    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">hasQuarterState</span>;
    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">soldState</span>;
    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">winnerState</span>;

    <span style="color: #b58900;">State</span> <span style="color: #268bd2;">state</span> = soldState;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">count</span> = 0;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getSoldState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> soldState;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">GumballMachine</span><span style="color: #b58900;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">numberCumballs</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        soldOutState = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">SoldOutState</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
        noQuarterState = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">NoQuarterState</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
        hasQuarterState = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">HasQuarterState</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
        soldState = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">SoldState</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;
        winnerState = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">WinnerState</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #268bd2;">)</span>;

        <span style="color: #859900; font-weight: bold;">this</span>.count = numberCumballs;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>numberCumballs &gt; 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            state = noQuarterState;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">turnCrank</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        state.turnCrank<span style="color: #268bd2;">()</span>;
        state.dispense<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">releaseBall</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"A gumball comes rolling out the slot..."</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>count != 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            count = count - 1;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">setState</span><span style="color: #b58900;">(</span><span style="color: #b58900;">State</span> <span style="color: #268bd2;">state</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.state = state;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getSoldOutState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> soldOutState;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getNoQuarterState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> noQuarterState;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getHasQuarterState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> hasQuarterState;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getWinnerState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> winnerState;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">State</span> <span style="color: #268bd2;">getState</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> state;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">getCount</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> count;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">insertQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        state.insertQuarter<span style="color: #268bd2;">()</span>;

    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">ejectQuarter</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        state.ejectQuarter<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">StringBuffer</span> <span style="color: #268bd2;">result</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">StringBuffer</span><span style="color: #268bd2;">()</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nMighty Gumball, Inc."</span><span style="color: #268bd2;">)</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nJava-enabled Standing Gumball Model #2004"</span><span style="color: #268bd2;">)</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\nInventory: "</span> + count + <span style="color: #2aa198;">" gumball"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>count != 1<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            result.append<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"s"</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #268bd2;">)</span>;
        result.append<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Machine is "</span> + state + <span style="color: #2aa198;">"\n"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">return</span> result.toString<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试代码如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch10.state.<span style="color: #268bd2; font-weight: bold;">winner</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">GumballMachine</span><span style="color: #268bd2;">(</span>10<span style="color: #268bd2;">)</span>;

        System.out.println<span style="color: #268bd2;">(</span>gumballMachine<span style="color: #268bd2;">)</span>;

        gumballMachine.insertQuarter<span style="color: #268bd2;">()</span>;
        gumballMachine.turnCrank<span style="color: #268bd2;">()</span>;
        gumballMachine.insertQuarter<span style="color: #268bd2;">()</span>;
        gumballMachine.turnCrank<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">/////////////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================POSSIBLE-OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Mighty Gumball, Inc.                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Java-enabled Standing Gumball Model #2004               //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Inventory: 10 gumballs                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Machine is waiting for quarter                          //</span>
<span style="color: #93a1a1;">//                                                         </span><span style="color: #93a1a1;">//</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">You inserted a quarter                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">You turned...                                           //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">YOU'RE A WINNER! You get two gumballs for your quarter  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">A gumball comes rolling out the slot...                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">A gumball comes rolling out the slot...                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">You inserted a quarter                                  //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">You turned...                                           //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">A gumball comes rolling out the slot...                 //</span>
<span style="color: #93a1a1;">/////////////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4">The State Pattern defined</h3>
<div class="outline-text-3" id="text-10-4">
<ul class="org-ul">
<li>state pattern的文字定义如下
<pre class="example">
The State Pattern allows an object to alter its behavior when its
internal state changes. The object will appear to change its class.
</pre>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">Chapter 11: the Proxy Pattern: Controlling Object Access</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1">New requirement</h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>GumballMachine的老板希望能给他出具一份公司所有产品的summary报告.
</li>
<li>我们最直观的感受就是改动当前的GumballMachine给它加一个location的新的成员变量
用来区分"世界各地的,不同的"GumballMachine
<div class="org-src-container">

<pre class="src src-diff"><span style="color: #333333;">    Modified   src/main/java/org/hfeng/misc/hfdp/ch11/proxy/winner/GumballMachine.java</span>
<span style="color: #333333;">diff --git a/src/main/java/org/hfeng/misc/hfdp/ch11/proxy/winner/GumballMachine.java b/src/main/java/org/hfeng/misc/hfdp/ch11/proxy/winner/GumballMachine.java</span>
<span style="color: #333333;">index a9b28bd..89c72fd 100644</span>
<span style="background-color: #fdf6e3;">--- </span><span style="color: #657b83; background-color: #fdf6e3; font-weight: bold;">a/src/main/java/org/hfeng/misc/hfdp/ch11/proxy/winner/GumballMachine.java</span>
<span style="background-color: #fdf6e3;">+++ </span><span style="color: #657b83; background-color: #fdf6e3; font-weight: bold;">b/src/main/java/org/hfeng/misc/hfdp/ch11/proxy/winner/GumballMachine.java</span>
<span style="background-color: #fdf6e3;">@@ -9,11 +9,17 @@</span><span style="background-color: #fdf6e3;"> public class GumballMachine {</span>

<span style="color: #333333;">     State state = soldState;</span>
<span style="color: #333333;">     int count = 0;</span>
<span style="color: #859900;">+</span><span style="color: #859900;">    String location;</span>
<span style="color: #859900;">+</span>
<span style="color: #859900;">+</span><span style="color: #859900;">    public String getLocation() {</span>
<span style="color: #859900;">+</span><span style="color: #859900;">        return location;</span>
<span style="color: #859900;">+</span><span style="color: #859900;">    }</span>
<span style="color: #859900;">+</span>
<span style="color: #333333;">     public State getSoldState() {</span>
<span style="color: #333333;">         return soldState;</span>
<span style="color: #333333;">     }</span>

<span style="color: #dc322f;">-</span><span style="color: #dc322f;">    public GumballMachine(int numberGumballs) {</span>
<span style="color: #859900;">+</span><span style="color: #859900;">    public GumballMachine(String location, int numberGumballs) {</span>
<span style="color: #333333;">         soldOutState = new SoldOutState(this);</span>
<span style="color: #333333;">         noQuarterState = new NoQuarterState(this);</span>
<span style="color: #333333;">         hasQuarterState = new HasQuarterState(this);</span>
<span style="background-color: #fdf6e3;">@@ -24,6 +30,7 @@</span><span style="background-color: #fdf6e3;"> public class GumballMachine {</span>
<span style="color: #333333;">         if (numberGumballs &gt; 0) {</span>
<span style="color: #333333;">             state = noQuarterState;</span>
<span style="color: #333333;">         }</span>
<span style="color: #859900;">+</span><span style="color: #859900;">        this.location = location;</span>
<span style="color: #333333;">     }</span>
</pre>
</div>
</li>
<li>然后我们设计一个新的报告用的类GumballMonitor
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch11.proxy.<span style="color: #268bd2; font-weight: bold;">monitor</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">GumballMonitor</span> <span style="color: #2aa198;">{</span>
    <span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">machine</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">GumballMonitor</span><span style="color: #b58900;">(</span><span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">machine</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.machine = machine;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">report</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Gumball Machine: "</span> + machine.getLocation<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Current inventory: "</span> + machine.getCount<span style="color: #6c71c4;">()</span> + <span style="color: #2aa198;">" gumballs"</span><span style="color: #268bd2;">)</span>;
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Current state: "</span> + machine.getState<span style="color: #6c71c4;">()</span><span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>测试用例如下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.misc.hfdp.ch11.proxy.<span style="color: #268bd2; font-weight: bold;">monitor</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MainTest</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">count</span> = 0;
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>args.length &lt; 2<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Usage GumballMachine &lt;Location&gt; &lt;Number&gt;"</span><span style="color: #6c71c4;">)</span>;
            System.exit<span style="color: #6c71c4;">(</span>1<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>

        count = Integer.parseInt<span style="color: #268bd2;">(</span>args<span style="color: #6c71c4;">[</span>1<span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">GumballMachine</span> <span style="color: #268bd2;">gumballMachine</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">GumballMachine</span><span style="color: #268bd2;">(</span>args<span style="color: #6c71c4;">[</span>0<span style="color: #6c71c4;">]</span>, count<span style="color: #268bd2;">)</span>;

        <span style="color: #b58900;">GumballMonitor</span> <span style="color: #268bd2;">monitor</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">GumballMonitor</span><span style="color: #268bd2;">(</span>gumballMachine<span style="color: #268bd2;">)</span>;

        monitor.report<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&gt; java MainTest Seattle 112                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Gumball Machine: Seattle                       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current inventory: 112 gumballs                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Current state: waiting for quarter             //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2">Misunderstanding</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>上面的做法是能解决GumballMachine在本地时候的情况.但是对方CEO的想法是"remotely"
的监控GumballMachine.也就是说
<pre class="example">
GumBallMonitor 和 GumBallMachine在两台不同的机器上面(JVM也就不同,
所以, 你不可以让GumBallMonitor compose 一个GumBallMachine了.
</pre>
</li>
<li>解决的办法就是proxy pattern啦
</li>
<li>所谓proxy pattern, 其实就是你不在compose"另外一个jvm"里面的对象, 而是compose
一个proxy对象, 让这个对象去和"另外一个jvm"里面的对象通信.如下图

<div class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/org_dot/master/notes/java/dp/proxy.png" alt="proxy.png" />
</p>
<p><span class="figure-number">Figure 39:</span> proxy.png</p>
</div>
</li>
<li>在java中,两个jvm(两个机器)之间的通信,就是通过RMI.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3">The Proxy Pattern defined</h3>
<div class="outline-text-3" id="text-11-3">
<ul class="org-ul">
<li>定义如下
<pre class="example">
The Proxy Pattern provides a surrogate or placeholder for another
object to control access to it.
</pre>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

         <!-- Disqus Comment BEGIN -->
          <div id="disqus_thread"></div>
          <script type="text/javascript">
              var disqus_shortname = 'harrifeng';

              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

         <!-- Disqus Comment END -->
</div>
</body>
</html>
