<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>jmdp</title>
<!-- 2017-05-02 Tue 10:48 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="your name" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>

         <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono|Galdeano|Open+Sans:600italic,400,600|Roboto+Condensed:400,700" rel="stylesheet" type="text/css">
         <link rel="stylesheet" type="text/css" href="/static/css/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="http://harrifeng.github.io/sitemap.html"> UP </a>
 |
 <a accesskey="H" href="http://harrifeng.github.io/index.html"> HOME </a>
</div><div id="preamble" class="status">

         <div id="header">
            <div id="header-top">
                <div id="blog-title">Harrifeng's Path</div>
                <div id="blog-sub-title">纸上得来终觉浅,绝知此事要Coding</div>
            </div>
            <div id="nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/about.html">About Me</a></li>
                    <li>
                    </li>
                </ul>
            </div>
         </div>
</div>
<div id="content">
<h1 class="title">jmdp</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Introduction2: 多线程程序的评量标准</a>
<ul>
<li><a href="#sec-1-1">安全性:</a></li>
<li><a href="#sec-1-2">生存性(liveness)</a></li>
<li><a href="#sec-1-3">复用性(reusability)</a></li>
</ul>
</li>
<li><a href="#sec-2">Chapter 1: Single Threaded Execution &#x2013; 能通过这座桥的,只有一个人</a>
<ul>
<li><a href="#sec-2-1">Single Threaded Execution Pattern</a></li>
<li><a href="#sec-2-2">不使用single threaded execution pattern的范例</a></li>
<li><a href="#sec-2-3">使用single threaded execution pattern的范例</a></li>
<li><a href="#sec-2-4">生命性与死锁</a></li>
<li><a href="#sec-2-5">synchronized语法的优点</a></li>
<li><a href="#sec-2-6">可重用性和继承异常</a></li>
</ul>
</li>
<li><a href="#sec-3">Chapter 2: Immutable&#x2013;想破坏它也没办法</a>
<ul>
<li><a href="#sec-3-1">使用Immutable Pattern的Person类</a></li>
</ul>
</li>
<li><a href="#sec-4">Chapter 3: Guarded Suspension &#x2013; 要等到我准备好喔</a></li>
<li><a href="#sec-5">Chapter 4: Balking &#x2013; 不需要的话，就算了吧</a></li>
<li><a href="#sec-6">Chapter 5: Producer-Consumer &#x2013; 我来做，你来用</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Introduction2: 多线程程序的评量标准</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">安全性:</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>允许1个以上的thread使用,而不危及数据安全性的类称之为thread-safe的类.
</li>
<li>Java lib类库里面的类也并不是所有都是thread-safe的,比如java.util.Vector是thread
safe的,但是java.util.ArrayList就不是thread-safe的
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">生存性(liveness)</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>并不是只满足thread-safe的程序就能够达到我们的目标. 生存性也是非常重要的:我们
不仅仅要保证我们的数据不被"破坏",还要保证程序能够eventually的得到我们想要的
结果
</li>
<li>违反生存性的一个典型的例子就是死锁(deadlock)
<pre class="example">
Deadlock can occur in a situation when a thread is waiting for an
object lock, that is acquired by another thread and second thread
is waiting for an object lock that is acquired by first thread.
Since, both threads are waiting for each other to release the lock,
the condition is called deadlock.
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">复用性(reusability)</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>复用性不是必备的条件,但是却是提高程序质量的方法.在写多线程程序时,若能巧妙的
将线程的共享互斥结构和方针隐藏在类里,这就是一个具有高度复用性的程序
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Chapter 1: Single Threaded Execution &#x2013; 能通过这座桥的,只有一个人</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Single Threaded Execution Pattern</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Single Threaded Execution有时候也被称之为Critical Section或者Critical Region.
<ul class="org-ul">
<li>Single Threaded Execution的名字来源于执行"数据"操作的thread
</li>
<li>Critical Section的名字来源于被执行的"数据"区域
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">不使用single threaded execution pattern的范例</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>先看一个反例,就是三个thread共同访问一个"数据"instance,造成了race condition
</li>
<li>首先看数据class: Gate有两个变量分别表示出生在某地(address)的某人(name).
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch01.<span style="color: #268bd2; font-weight: bold;">gateunsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Gate</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">counter</span> = 0;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span> = <span style="color: #2aa198;">"Nobody"</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span> = <span style="color: #2aa198;">"Nowhere"</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pass</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.counter++;
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.address = address;
        check<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"No."</span> + counter + <span style="color: #2aa198;">": "</span> + name + <span style="color: #2aa198;">", "</span> + address;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">check</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>name.charAt<span style="color: #6c71c4;">(</span>0<span style="color: #6c71c4;">)</span> != address.charAt<span style="color: #6c71c4;">(</span>0<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"**** BROKEN ****"</span> + toString<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>thread class产生race condtion的情况下, "数据"class本身肯定是有问题的,比如必
须能够暴露一个函数来更改自己内部的state,这样一来thread才能把state"搞乱". 这
个暴露的函数就是pass().
</li>
<li>更改了state以后,pass()紧接着调用了check(), 这是为了让我们发现state不一致的
情况, counter的作用也显示出来了,让我们看到多线程的"搞乱state"的情况也是需要
"很多次尝试"的.
</li>
<li>然后是thread class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch01.<span style="color: #268bd2; font-weight: bold;">gateunsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">UserThread</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Thread</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">Gate</span> <span style="color: #268bd2;">gate</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">myName</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">myAddress</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">UserThread</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Gate</span> <span style="color: #268bd2;">gate</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">myName</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">myAddress</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.gate = gate;
        <span style="color: #859900; font-weight: bold;">this</span>.myName = myName;
        <span style="color: #859900; font-weight: bold;">this</span>.myAddress = myAddress;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span>myName + <span style="color: #2aa198;">" BEGIN"</span><span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">true</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            gate.pass<span style="color: #6c71c4;">(</span>myName, myAddress<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>thread class产生race condition的情况下,必须能够:
<ol class="org-ol">
<li>得到"数据"的句柄, 在这里这个句柄就是数据的instance, 它作为一个参数传递给
这个thread class.
</li>
<li>在run函数里面,更改"数据". thread其实就是在run里面实现一个"函数"的功能, 也
只有在这里"更改"了数据,才可能造成数据不一致.run函数里面更改数据的方法是使
用Gate class暴露的pass()
</li>
</ol>
</li>
<li>最后是试验的main class
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch01.<span style="color: #268bd2; font-weight: bold;">gateunsafe</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Main</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Testing Gate, hit CTRL+C to exit."</span><span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">Gate</span> <span style="color: #268bd2;">gate</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Gate</span><span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UserThread</span><span style="color: #268bd2;">(</span>gate, <span style="color: #2aa198;">"Alice"</span>, <span style="color: #2aa198;">"Alaska"</span><span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UserThread</span><span style="color: #268bd2;">(</span>gate, <span style="color: #2aa198;">"Bobby"</span>, <span style="color: #2aa198;">"Brazil"</span><span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">UserThread</span><span style="color: #268bd2;">(</span>gate, <span style="color: #2aa198;">"Chris"</span>, <span style="color: #2aa198;">"Canada"</span><span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice BEGIN                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bobby BEGIN                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Chris BEGIN                                    //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.254: Alice, Alaska          //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.364: Chris, Canada          //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.285022: Chris, Canada       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.285126: Chris, Canada       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.286702: Chris, Canada       //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">**** BROKEN ****No.287216: Bobby, Canada       //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
<li>这个结果也很有意思,我们只截取了其中一部分,但是其实"真正"和我们想象的check()
出问题的结果,就是这一行
<pre class="example">
**** BROKEN ****No.287216: Bobby, Canada
</pre>
</li>
<li>其他行,之所以没有打印出"首字母不同"的字符串是因为check()本身也不是"线程安全
的", 在check的if里面check出问题之后,其他thread又把Gate instance的private 数
据给更改了.
</li>
<li>而之所以check的if会check出问题,是因为更改Gate instance内部数据的pass()是"线
程不安全"的,所以某个thread在更改了myName之后,就失去了CPU,另外的thread会给
myAddress一个'首字母'不同的其他值.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">使用single threaded execution pattern的范例</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>增加single threaded execution pattern的方法特别简单,只需要更改Gate.java就可
以了
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Gate</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">int</span> <span style="color: #268bd2;">counter</span> = 0;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span> = <span style="color: #2aa198;">"Nobody"</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span> = <span style="color: #2aa198;">"Nowhere"</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">pass</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.counter++;
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.address = address;
        check<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"No."</span> + counter + <span style="color: #2aa198;">": "</span> + name + <span style="color: #2aa198;">", "</span> + address;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">check</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>name.charAt<span style="color: #6c71c4;">(</span>0<span style="color: #6c71c4;">)</span> != address.charAt<span style="color: #6c71c4;">(</span>0<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"**** BROKEN ****"</span> + toString<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>通过比较我们发现,其实只是增加了两个synchronized关键字.(其中toString()的
synchronized不会影响本例)
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">生命性与死锁</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>使用single threaded execution pattern可以保证线程安全性,却无法保证生命性
</li>
<li>在single threaded execution pattern下面死锁形成的三个必要条件:
<ol class="org-ol">
<li>具有多个share resource参与者
</li>
<li>每个参与者都是在获取了shared resourceA后,没有释放shared resourceA就去里面
获取shared resourceB
</li>
<li>参与者获取不同的shared resource的顺序不一致.
</li>
</ol>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">synchronized语法的优点</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>c/c++里面的可能是使用lock的方法来保护critical region
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b58900;">void</span> <span style="color: #268bd2;">method</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    lock<span style="color: #b58900;">()</span>;
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
    unlock<span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>而synchronized的语法是
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">this</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
    <span style="color: #93a1a1;">//</span><span style="color: #93a1a1;">...</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>两者都少在"{"处锁定,而在"}"处解锁.在正常的情况下,两者是等价的.
</li>
<li>synchronized的优点是当"不正常"的情况发生的时候:
<ul class="org-ul">
<li>lock之间有return
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b58900;">void</span> <span style="color: #268bd2;">method</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    lock<span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span>;
    <span style="color: #b58900;">}</span>
    unlock<span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>lock之间有exception
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b58900;">void</span> <span style="color: #268bd2;">method</span><span style="color: #2aa198;">()</span> <span style="color: #2aa198;">{</span>
    lock<span style="color: #b58900;">()</span>;
    doMethod;  <span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">throw exception here, unlock() will not be called</span>
    unlock<span style="color: #b58900;">()</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
<li>上述两种"不正常"的情况下, unlock()都没有调用,所以lock并没有被释放. 而java的
synchronized机制则在这两种情况下,自动的放弃lock.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">可重用性和继承异常</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>single threaded execution pattern的"数据"如果被继承了的话,必须要求其子类的
所有的method都具备synchronized,所以其防护性非常的脆弱
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Chapter 2: Immutable&#x2013;想破坏它也没办法</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">使用Immutable Pattern的Person类</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>下面是使用Immutable Pattern的Person类.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Person</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Person</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">address</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
        <span style="color: #859900; font-weight: bold;">this</span>.address = address;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getAddress</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> address;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"[ Person: name = "</span> + name + <span style="color: #2aa198;">", address = "</span> + address + <span style="color: #2aa198;">" ]"</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Immutable Pattern下的Person类有如下特点:
<ul class="org-ul">
<li>Person类的字段值"只能"通过ctor来设置.有getter,但是没有setter
</li>
<li>Person类的字段都少private的,只有自己能够看到
</li>
<li>Person类的字段都设计成了final,也就是只能赋值一次(注意是赋值一次,也就是ref
不能更改,因为都是String,所以object不会更改而已)
</li>
<li>Person类被设计成final的.也就是说Person类不允许别人定义它的子类.这不是immutable
pattern的必要条件,但是可以预防子类修改字段.
</li>
</ul>
</li>
<li>immutable class能够在不使用synchronzied的情况下实现线程安全,并保证生存性.
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Chapter 3: Guarded Suspension &#x2013; 要等到我准备好喔</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>guarded是"被保护"(被动语态)的意思, 而suspension是"暂停的"意思.综合起来就是
<pre class="example">
      当现在并不适合执行某个操作的时候,要求执行该操作的线程等待条件合适
</pre>
</li>
<li>我们先来看看我们的例子:
<ul class="org-ul">
<li>Request类,表示client发送了请求,只有一个用来区别不同request的name
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">e01</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Request</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Request</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"[ Request "</span> + name + <span style="color: #2aa198;">" ]"</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>RequestQueue类是用来存放request instance的容器, 这个容器无论'存'还是'放',
总能成功,其方法是,比如如果从queue里面取, 但是queue里面没数据(不适合执行某
个操作的时候),我就suspension,等待时机合适.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">LinkedList</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">RequestQueue</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">LinkedList</span> <span style="color: #268bd2;">queue</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LinkedList</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">Request</span> <span style="color: #268bd2;">getRequest</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span>queue.size<span style="color: #6c71c4;">()</span> &lt;= 0<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #6c71c4;">{</span>
                wait<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                System.out.println<span style="color: #859900;">(</span><span style="color: #2aa198;">"Error "</span> + e.getMessage<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
                e.printStackTrace<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">Request</span><span style="color: #6c71c4;">)</span>queue.removeFirst<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">putRequest</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Request</span> <span style="color: #268bd2;">request</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        queue.addLast<span style="color: #268bd2;">(</span>request<span style="color: #268bd2;">)</span>;
        notifyAll<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>ClientThread类的实例是putRequest的调用者,也就是俗称的"生产者"
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Random</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ClientThread</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Thread</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Random</span> <span style="color: #268bd2;">random</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ClientThread</span><span style="color: #b58900;">(</span><span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">long</span> <span style="color: #268bd2;">seed</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">super</span><span style="color: #268bd2;">(</span>name<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">this</span>.requestQueue = requestQueue;
        <span style="color: #859900; font-weight: bold;">this</span>.random = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Random</span><span style="color: #268bd2;">(</span>seed<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 10000; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">Request</span> <span style="color: #268bd2;">request</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Request</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"No."</span> + i<span style="color: #6c71c4;">)</span>;
            System.out.println<span style="color: #6c71c4;">(</span>Thread.currentThread<span style="color: #859900;">()</span>.getName<span style="color: #859900;">()</span> + <span style="color: #2aa198;">" requests "</span> + request<span style="color: #6c71c4;">)</span>;
            requestQueue.putRequest<span style="color: #6c71c4;">(</span>request<span style="color: #6c71c4;">)</span>;
            <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #6c71c4;">{</span>
                Thread.sleep<span style="color: #859900;">(</span>random.nextInt<span style="color: #b58900;">(</span>1000<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                System.out.println<span style="color: #859900;">(</span><span style="color: #2aa198;">"Error "</span> + e.getMessage<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
                e.printStackTrace<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>ServerThread类的实例是getRequest的调用者,也就是俗称的"消费者"
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Random</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ServerThread</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Thread</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Random</span> <span style="color: #268bd2;">random</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ServerThread</span><span style="color: #b58900;">(</span><span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">long</span> <span style="color: #268bd2;">seed</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">super</span><span style="color: #268bd2;">(</span>name<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">this</span>.requestQueue = requestQueue;
        <span style="color: #859900; font-weight: bold;">this</span>.random = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Random</span><span style="color: #268bd2;">(</span>seed<span style="color: #268bd2;">)</span>;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 10000; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #b58900;">Request</span> <span style="color: #268bd2;">request</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Request</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"No."</span> + i<span style="color: #6c71c4;">)</span>;
            System.out.println<span style="color: #6c71c4;">(</span>Thread.currentThread<span style="color: #859900;">()</span>.getName<span style="color: #859900;">()</span> + <span style="color: #2aa198;">" handles "</span> + request<span style="color: #6c71c4;">)</span>;
            <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #6c71c4;">{</span>
                Thread.sleep<span style="color: #859900;">(</span>random.nextInt<span style="color: #b58900;">(</span>1000<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                System.out.println<span style="color: #859900;">(</span><span style="color: #2aa198;">"Error "</span> + e.getMessage<span style="color: #b58900;">()</span><span style="color: #859900;">)</span>;
                e.printStackTrace<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Main是测试的主函数
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Main</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">RequestQueue</span><span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClientThread</span><span style="color: #268bd2;">(</span>requestQueue, <span style="color: #2aa198;">"Alice"</span>, 3141592L<span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ServerThread</span><span style="color: #268bd2;">(</span>requestQueue, <span style="color: #2aa198;">"Bobby"</span>, 6535897L<span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request No.0 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bobby handles [ Request No.0 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request No.1 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request No.2 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bobby handles [ Request No.1 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Bobby handles [ Request No.2 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">...                                            //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
<li>老的版本java 产生nonblocking效果的要素:
<ul class="org-ul">
<li>调用wait()和notifyAll()的函数,都是synchronized的
</li>
<li>wait():
</li>
<li>notifyAll():
</li>
</ul>
</li>
<li>上诉这些要素其实都是建立在操作系统提供的多线程操作工具的基础上的:
<ul class="org-ul">
<li>synchronized函数,其实就是Linux多线程里面的mutex锁(在所有访问到"多个thread共
享数据"的时候,都要使用锁)
</li>
<li>wait()和notifyAll(),其实就是Linux多线程里面的condition variable: condition
variable其实是操作系统中避免busy waiting (比如while(num&gt;0)这种情况, 每次拿
到lock,check一下num有没有合乎我们的要求,不符合放弃lock再来下一次)下,空耗cpu,
而设计的一种新的操作系统内置"通知手段", 这种手段自然的需要两个部分:
<ol class="org-ol">
<li>开始等待:就是不使用busy waiting了,相信操作系统会"守诺"wake up我们,所以
开始wait(), 注意wait()之前必须要有锁在手中.
</li>
<li>被通知:我们希望得到的那个状态(比如num&gt;0)是需要其他thread来达成的.它们一
旦达成,要使用notify()来通知我们(如果有多个人等待这个状态,至少有一个能得
到通知),也就是说,这个"诺"是其他thread来完成的.操作系统负责传达到:
<ul class="org-ul">
<li>Linux里面通知所有人是pthread_cond_broadcat,也就是这里的notifyAll
</li>
<li>Linux里面的通知其中一个人是pthread_cond_signal,也就是java里面的notify
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li>新版本的开始使用Java的BlocingQueue来解决这个问题, 所以我们下面主要介绍blockingQueue
</li>
<li>queue的定义很简单了.就是一个"FIFO(First In, First Out)"的容器.
</li>
<li>而blockingqueue和普通queue的区别,很显然在于blocking:
<ul class="org-ul">
<li>当queue为'空'的时候,再次outpu queue的数据不会失败或者exception(失败或者
exception是从接口Queue extend来的),而是会block(接口BlockingQueue自己的)
</li>
<li>当queue为'满'的时候,再次input queue的数据不会失败或者exception(失败或者
exception是从接口Queue extend来的),而是会block(接口BlockingQueue自己的)
</li>
</ul>
</li>
<li>我们再来看看jdk5之后使用nonblocking container之后的情况:
<ul class="org-ul">
<li>Request类,和原来一样
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">e01</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Request</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Request</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.name = name;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">getName</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> name;
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">toString</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"[ Request "</span> + name + <span style="color: #2aa198;">" ]"</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>RequestQueue类是存放request instance的容器, 在jdk1.5之后,我们可以不使用
LinkedList,而使用对LinkedList进行包装过的LinkedBlockingQueue. 这个容器就有:
放置或block的接口put(), 取出或block的接口take()
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">e01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #268bd2; font-weight: bold;">concurrent</span>.<span style="color: #b58900;">BlockingQueue</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #268bd2; font-weight: bold;">concurrent</span>.<span style="color: #b58900;">LinkedBlockingQueue</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">RequestQueue</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">BlockingQueue</span><span style="color: #b58900;">&lt;</span><span style="color: #b58900;">Request</span><span style="color: #b58900;">&gt;</span> <span style="color: #268bd2;">queue</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">LinkedBlockingQueue</span><span style="color: #b58900;">&lt;&gt;()</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">Request</span> <span style="color: #268bd2;">getRequest</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">Request</span> <span style="color: #268bd2;">req</span> = <span style="color: #268bd2; font-weight: bold;">null</span>;
        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            req = queue.take<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> req;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">putRequest</span><span style="color: #b58900;">(</span><span style="color: #b58900;">Request</span> <span style="color: #268bd2;">request</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            queue.put<span style="color: #6c71c4;">(</span>request<span style="color: #6c71c4;">)</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Server,Client的代码都一样,我们来看看main函数的结果
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch03.<span style="color: #268bd2; font-weight: bold;">e01</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Main</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">main</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span><span style="color: #268bd2;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #b58900;">RequestQueue</span> <span style="color: #268bd2;">requestQueue</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">RequestQueue</span><span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ClientThread</span><span style="color: #268bd2;">(</span>requestQueue, <span style="color: #2aa198;">"Alice"</span>, 3141592L<span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
        <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">ServerThread</span><span style="color: #268bd2;">(</span>requestQueue, <span style="color: #2aa198;">"Alice"</span>, 6535897L<span style="color: #268bd2;">)</span>.start<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">&lt;===================OUTPUT===================&gt; //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.0 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.0 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.1 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.2 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.1 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.2 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.3 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.3 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.4 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.4 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.5 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.6 ]                //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.5 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice handles [ Request NO.6 ]                 //</span>
<span style="color: #93a1a1;">// </span><span style="color: #93a1a1;">Alice requests [ Request NO.7 ]                //</span>
<span style="color: #93a1a1;">////////////////////////////////////////////////////</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Chapter 4: Balking &#x2013; 不需要的话，就算了吧</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>其实这个pattern总体来说是比较简单的，就是说如果两个thread都做同一件事情，很有
可能threadB在做之前会发现没什么事情可做（因为threadA帮助它做完了）
</li>
<li>为了能够让threadB知道自己到底需不需要做（check是否被其他的thread完成）。我们
必须另外设置一个flag变量，下面就是一个这样的例子：
<ul class="org-ul">
<li>Data class.需要被保存的类。其中设置了flag来表示自己有没有需要保存的改动
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch04.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">IOException</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">FileWriter</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">Writer</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Data</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">filename</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">String</span> <span style="color: #268bd2;">content</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">boolean</span> <span style="color: #268bd2;">changed</span>;

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">Data</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">filename</span>, <span style="color: #b58900;">String</span> <span style="color: #268bd2;">content</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.filename = filename;
        <span style="color: #859900; font-weight: bold;">this</span>.content = content;
        <span style="color: #859900; font-weight: bold;">this</span>.changed = <span style="color: #268bd2; font-weight: bold;">true</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">change</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">newContent</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        content = newContent;
        changed = <span style="color: #268bd2; font-weight: bold;">true</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">save</span><span style="color: #b58900;">()</span> <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">IOException</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-weight: bold;">!</span>changed<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">return</span>;
        <span style="color: #268bd2;">}</span>

        doSave<span style="color: #268bd2;">()</span>;
        changed = <span style="color: #268bd2; font-weight: bold;">false</span>;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">doSave</span><span style="color: #b58900;">()</span> <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">IOException</span> <span style="color: #b58900;">{</span>
        System.out.println<span style="color: #268bd2;">(</span>Thread.currentThread<span style="color: #6c71c4;">()</span>.getName<span style="color: #6c71c4;">()</span>
                           + <span style="color: #2aa198;">" calls do Save, content ="</span> + content <span style="color: #268bd2;">)</span>;
        <span style="color: #b58900;">Writer</span> <span style="color: #268bd2;">writer</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">FileWriter</span><span style="color: #268bd2;">(</span>filename<span style="color: #268bd2;">)</span>;
        writer.write<span style="color: #268bd2;">(</span>content<span style="color: #268bd2;">)</span>;
        writer.close<span style="color: #268bd2;">()</span>;
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Changer class：更改Data的thread。它在改动完之后会sleep一段时间（模拟做其他
事情），changer的save是模拟人类在打字的时候，过几分钟总会保存一下的。
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch04.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">IOException</span>;
<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">util</span>.<span style="color: #b58900;">Random</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ChangerThread</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Thread</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Data</span> <span style="color: #268bd2;">data</span>;
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Random</span> <span style="color: #268bd2;">random</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900;">Random</span><span style="color: #b58900;">()</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">ChangerThread</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">Data</span> <span style="color: #268bd2;">data</span><span style="color: #b58900;">){</span>
        <span style="color: #859900; font-weight: bold;">super</span><span style="color: #268bd2;">(</span>name<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">this</span>.data = data;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; <span style="color: #268bd2; font-weight: bold;">true</span>; i++<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                data.change<span style="color: #859900;">(</span><span style="color: #2aa198;">"No."</span> + i<span style="color: #859900;">)</span>;
                Thread.sleep<span style="color: #859900;">(</span>random.nextInt<span style="color: #b58900;">(</span>1000<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>;
                data.save<span style="color: #859900;">()</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">IOException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            System.out.println<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Error "</span> + e.getMessage<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span>;
            e.printStackTrace<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
        <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            e.printStackTrace<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>Saver class: 保存Data的thread，它不会去更改Data，但是每过一段时间会去保存
一下data。这个是模拟ms word的自动保存。这个可能几秒钟就会自动保存一下
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> org.hfeng.jmdp.ch04.<span style="color: #268bd2; font-weight: bold;">l01</span>;

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2; font-weight: bold;">java</span>.<span style="color: #268bd2; font-weight: bold;">io</span>.<span style="color: #b58900;">IOException</span>;
<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">SaverThread</span> <span style="color: #859900; font-weight: bold;">extends</span> <span style="color: #b58900;">Thread</span><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #b58900;">Data</span> <span style="color: #268bd2;">data</span>;
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #268bd2;">SaverThread</span><span style="color: #b58900;">(</span><span style="color: #b58900;">String</span> <span style="color: #268bd2;">name</span>, <span style="color: #b58900;">Data</span> <span style="color: #268bd2;">data</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">super</span><span style="color: #268bd2;">(</span>name<span style="color: #268bd2;">)</span>;
        <span style="color: #859900; font-weight: bold;">this</span>.data = data;
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">run</span><span style="color: #b58900;">()</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">try</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2; font-weight: bold;">true</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                data.save<span style="color: #859900;">()</span>;
                Thread.sleep<span style="color: #859900;">(</span>1000<span style="color: #859900;">)</span>;
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">IOException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            e.printStackTrace<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">catch</span> <span style="color: #268bd2;">(</span><span style="color: #b58900;">InterruptedException</span> <span style="color: #268bd2;">e</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            e.printStackTrace<span style="color: #6c71c4;">()</span>;
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
<li>因为Saver和Changer都会去保存，所以Data里面的flag就特别有用。因为并不是每次
都真的需要去保存.这也是这个pattern的核心
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">synchronized</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">save</span><span style="color: #2aa198;">()</span> <span style="color: #859900; font-weight: bold;">throws</span> <span style="color: #b58900;">IOException</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #b58900; font-weight: bold;">!</span>changed<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span>;
    <span style="color: #b58900;">}</span>

    doSave<span style="color: #b58900;">()</span>;
    changed = <span style="color: #268bd2; font-weight: bold;">false</span>;
<span style="color: #2aa198;">}</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Chapter 5: Producer-Consumer &#x2013; 我来做，你来用</h2>
</div>
</div>
<div id="postamble" class="status">

         <!-- Disqus Comment BEGIN -->
          <div id="disqus_thread"></div>
          <script type="text/javascript">
              var disqus_shortname = 'harrifeng';

              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

         <!-- Disqus Comment END -->
</div>
</body>
</html>
